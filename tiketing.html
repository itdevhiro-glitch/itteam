<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
<title>Zeppelin — Enterprise Command Center</title>
<link rel="icon" type="image/png" href="icov2.png" />
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&family=Plus+Jakarta+Sans:wght@400;600;700&display=swap" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">

<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/dayjs/1.11.10/dayjs.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/dayjs/1.11.10/plugin/relativeTime.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>

<style>
    :root {
        --font-main: 'Inter', sans-serif;
        --font-heading: 'Plus Jakarta Sans', sans-serif;
        --bg-body: #f8fafc; --bg-surface: #ffffff; --bg-sidebar: #0f172a; 
        --border-subtle: #e2e8f0; --text-primary: #1e293b; --text-secondary: #64748b;
        --primary: #4f46e5; --success: #10b981; --warning: #f59e0b; --danger: #ef4444; 
    }
    * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
    body { margin: 0; font-family: var(--font-main); background: var(--bg-body); color: var(--text-primary); height: 100vh; overflow: hidden; }
    
    .app-layout { display: grid; grid-template-columns: 80px 1fr; height: 100vh; width: 100vw; transition: 0.3s; }
    
    .sidebar { background: var(--bg-sidebar); display: flex; flex-direction: column; align-items: center; padding: 24px 0; z-index: 50; }
    .brand-icon { width: 48px; height: 48px; background: linear-gradient(135deg, var(--primary), #8b5cf6); border-radius: 12px; color: white; display: flex; align-items: center; justify-content: center; font-weight: 800; font-size: 24px; margin-bottom: 40px; box-shadow: 0 0 15px rgba(79,70,229,0.3); }
    .nav-item { width: 48px; height: 48px; border-radius: 12px; color: #94a3b8; display: flex; align-items: center; justify-content: center; font-size: 24px; cursor: pointer; transition: 0.2s; margin-bottom: 12px; }
    .nav-item:hover { background: rgba(255,255,255,0.1); color: white; }
    .nav-item.active { background: var(--primary); color: white; box-shadow: 0 4px 12px rgba(79,70,229,0.4); }

    .view-container { height: 100vh; overflow: hidden; position: relative; width: 100%; }
    .view-section { position: absolute; inset: 0; background: var(--bg-body); display: none; opacity: 0; transition: opacity 0.2s; }
    .view-section.active { display: block; opacity: 1; }

    /* WORKSPACE */
    .workspace-grid { display: grid; grid-template-columns: 380px 1fr; height: 100%; }
    .list-sidebar { background: var(--bg-surface); border-right: 1px solid var(--border-subtle); display: flex; flex-direction: column; height: 100%; width: 100%; }
    .list-header { padding: 20px; border-bottom: 1px solid var(--border-subtle); background: rgba(255,255,255,0.8); backdrop-filter: blur(8px); }
    .search-input { width: 100%; padding: 12px 12px 12px 36px; border-radius: 8px; border: 1px solid var(--border-subtle); background: var(--bg-body); font-size: 13px; transition: 0.2s; }
    .search-input:focus { border-color: var(--primary); background: white; box-shadow: 0 0 0 3px #e0e7ff; }
    
    .filter-tabs { display: flex; gap: 6px; margin-top: 12px; overflow-x: auto; padding-bottom: 4px; }
    .filter-tab { flex: 1; padding: 8px; border-radius: 6px; font-size: 12px; font-weight: 600; text-align: center; background: var(--bg-body); cursor: pointer; border: 1px solid var(--border-subtle); white-space: nowrap; transition: 0.2s; color: var(--text-secondary); }
    .filter-tab:hover { background: #f1f5f9; }
    .filter-tab.active { background: var(--primary); color: white; border-color: var(--primary); }
    
    .ticket-scroller { flex: 1; overflow-y: auto; padding: 12px; padding-bottom: 80px; }
    .ticket-card { padding: 16px; border-radius: 12px; background: white; border: 1px solid var(--border-subtle); margin-bottom: 8px; cursor: pointer; transition: 0.2s; position: relative; }
    .ticket-card:hover { border-color: var(--primary); transform: translateY(-2px); box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); }
    .ticket-card.active { border-color: var(--primary); background: #f0fdfa; box-shadow: 0 0 0 1px var(--primary); }
    .ticket-card.active::before { content:''; position: absolute; left:0; top:12px; bottom:12px; width:4px; background: var(--primary); border-radius: 0 4px 4px 0; }

    /* CHAT & TIMELINE */
    .chat-container { display: flex; flex-direction: column; height: 100%; background: #f8fafc; position: relative; }
    .chat-header { height: 64px; background: white; border-bottom: 1px solid var(--border-subtle); padding: 0 20px; display: flex; align-items: center; justify-content: space-between; flex-shrink: 0; box-shadow: 0 1px 2px rgba(0,0,0,0.02); }
    .timeline-area { flex: 1; overflow-y: auto; padding: 24px; display: flex; flex-direction: column; gap: 24px; padding-bottom: 100px; }
    
    .tl-item { display: flex; gap: 14px; max-width: 85%; animation: fadeIn 0.3s ease; }
    .tl-item.right { align-self: flex-end; flex-direction: row-reverse; }
    .tl-item.center { align-self: center; max-width: 90%; width: 100%; justify-content: center; }
    .tl-avatar { width: 34px; height: 34px; border-radius: 50%; background: white; border: 1px solid var(--border-subtle); display: grid; place-items: center; font-size: 12px; font-weight: 700; color: #475569; flex-shrink: 0; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
    .tl-bubble { padding: 14px 18px; border-radius: 16px; position: relative; font-size: 14px; line-height: 1.5; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
    .tl-item.left .tl-bubble { background: white; border: 1px solid var(--border-subtle); border-top-left-radius: 2px; }
    .tl-item.right .tl-bubble { background: var(--primary); color: white; border-top-right-radius: 2px; }
    
    .log-box { 
        background: #fffbeb; border: 1px solid #fcd34d; border-radius: 8px; padding: 10px 16px; 
        font-size: 12px; color: #92400e; width: 100%; text-align: left; display: flex; gap: 10px; align-items: flex-start;
    }

    .chat-footer { background: white; border-top: 1px solid var(--border-subtle); padding: 16px 24px; flex-shrink: 0; z-index: 10; }
    .input-mode-toggle { display: flex; gap: 12px; margin-bottom: 12px; font-size: 12px; font-weight: 600; overflow-x: auto; }
    .toggle-opt { cursor: pointer; padding: 6px 12px; border-radius: 6px; color: var(--text-secondary); background: #f1f5f9; white-space: nowrap; display: flex; align-items: center; gap: 6px; transition: 0.2s; }
    .toggle-opt:hover { background: #e2e8f0; }
    .toggle-opt.active { background: var(--text-primary); color: white; }
    .toggle-opt.active-internal { background: #fffbeb; color: #d97706; border: 1px solid #fcd34d; }

    textarea { width: 100%; height: 70px; padding: 12px; border: 1px solid var(--border-subtle); border-radius: 8px; font-family: var(--font-main); font-size: 14px; resize: none; transition: 0.2s; }
    textarea:focus { border-color: var(--primary); box-shadow: 0 0 0 3px #e0e7ff; }
    textarea.internal-mode { background: #fffbeb; border-color: #fcd34d; }
    textarea.internal-mode:focus { box-shadow: 0 0 0 3px #fef3c7; }

    /* DASHBOARD */
    .dash-scroll { padding: 32px 48px; overflow-y: auto; height: 100%; width: 100%; padding-bottom: 80px; background: #f8fafc; }
    .dash-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 32px; }
    .kpi-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 32px; }
    .kpi-card { background: white; padding: 24px; border-radius: 16px; border: 1px solid var(--border-subtle); box-shadow: 0 2px 4px rgba(0,0,0,0.02); position: relative; overflow: hidden; transition: 0.2s; }
    .kpi-card:hover { transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); }
    .kpi-card::after { content:''; position: absolute; top:0; left:0; width:4px; height:100%; background: var(--primary); }
    .kpi-val { font-size: 32px; font-weight: 800; color: var(--text-primary); margin: 8px 0; letter-spacing: -1px; }
    .kpi-label { font-size: 11px; font-weight: 700; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.5px; }
    
    .charts-row { display: grid; grid-template-columns: 2fr 1fr; gap: 20px; margin-bottom: 32px; height: 320px; }
    .chart-box { background: white; padding: 20px; border-radius: 16px; border: 1px solid var(--border-subtle); display: flex; flex-direction: column; box-shadow: 0 2px 4px rgba(0,0,0,0.02); }
    .table-card { background: white; border-radius: 16px; border: 1px solid var(--border-subtle); overflow: hidden; box-shadow: 0 2px 4px rgba(0,0,0,0.02); }
    
    table { width: 100%; border-collapse: collapse; min-width: 700px; }
    th, td { padding: 14px 20px; border-bottom: 1px solid var(--border-subtle); font-size: 13px; text-align: left; }
    th { background: #f8fafc; font-weight: 600; color: var(--text-secondary); text-transform: uppercase; font-size: 11px; }
    tr:last-child td { border-bottom: none; }
    tr:hover td { background: #fdfdfd; }

    /* UI ELEMENTS */
    .badge { padding: 3px 8px; border-radius: 6px; font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; }
    .bg-Open { background: #fffbeb; color: #d97706; border: 1px solid #fde68a; } 
    .bg-Progress { background: #e0f2fe; color: #0284c7; border: 1px solid #bae6fd; } 
    .bg-Closed { background: #ecfdf5; color: #059669; border: 1px solid #a7f3d0; }
    .btn { padding: 10px 18px; border-radius: 8px; background: var(--primary); color: white; border: none; font-weight: 600; cursor: pointer; display: inline-flex; align-items: center; justify-content: center; gap: 8px; font-size: 13px; transition: 0.2s; box-shadow: 0 2px 4px rgba(79,70,229,0.2); }
    .btn:hover { background: #4338ca; transform: translateY(-1px); }
    .btn:active { transform: translateY(0); }
    .btn-back { display: none; background: transparent; color: var(--text-primary); border: 1px solid var(--border-subtle); width: 36px; height: 36px; border-radius: 10px; padding: 0; margin-right: 12px; cursor: pointer; }
    .hidden { display: none !important; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

    /* --- MOBILE RESPONSIVE --- */
    @media (max-width: 768px) {
        .app-layout { grid-template-columns: 1fr; grid-template-rows: 1fr 64px; }
        .sidebar { flex-direction: row; width: 100%; height: 64px; padding: 0; justify-content: space-around; border-top: 1px solid var(--border-subtle); position: fixed; bottom: 0; background: white; order: 2; box-shadow: 0 -4px 20px rgba(0,0,0,0.05); }
        .brand-icon { display: none; }
        .nav-item { margin: 0; padding: 10px; font-size: 24px; border-radius: 12px; color: #94a3b8; }
        .nav-item.active { background: #eff6ff; color: var(--primary); box-shadow: none; }
        .view-container { height: calc(100vh - 64px); order: 1; }

        .workspace-grid { display: block; position: relative; }
        .list-sidebar { width: 100%; height: 100%; overflow-y: auto; padding-bottom: 0; }
        .chat-container { 
            position: fixed; top: 0; left: 0; width: 100%; height: calc(100vh - 64px); z-index: 20; 
            transform: translateX(100%); transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .chat-container.mobile-active { transform: translateX(0); }
        .btn-back { display: inline-flex; align-items: center; justify-content: center; }

        .kpi-grid { grid-template-columns: 1fr 1fr; gap: 12px; }
        .charts-row { grid-template-columns: 1fr; height: auto; }
        .chart-box { height: 260px; margin-bottom: 0; }
        .dash-scroll { padding: 20px; }
        h1 { font-size: 20px; }
        .kpi-val { font-size: 24px; }
        .list-header .search-input { width: 100%; }
    }
</style>
</head>
<body>

<div id="loginScreen" style="position:fixed; inset:0; background:radial-gradient(circle at top right,#eef2ff,#f8fafc); z-index:9999; display:flex; align-items:center; justify-content:center;">
    <div style="background:white; padding:32px; border-radius:20px; width:90%; max-width:400px; text-align:center; box-shadow:0 20px 40px -10px rgba(0,0,0,0.1); border:1px solid white;">
        <div class="brand-icon" style="margin:0 auto 24px; display:flex;">Z</div>
        <h2 style="margin-bottom:8px; font-family:'Plus Jakarta Sans',sans-serif;">Technician Portal</h2>
        <p style="color:#64748b; font-size:14px; margin-bottom:24px;">Secure Access for Support Team.</p>
        <input type="text" id="loginId" placeholder="ID / Email" style="width:100%; padding:12px; margin-bottom:12px; border:1px solid #e2e8f0; border-radius:8px; font-family:'Inter',sans-serif;">
        <input type="password" id="loginPass" placeholder="Password" style="width:100%; padding:12px; margin-bottom:24px; border:1px solid #e2e8f0; border-radius:8px;">
        <button class="btn" onclick="processLogin()" style="width:100%; height:44px; justify-content:center;">Authenticate</button>
        <p id="loginError" style="color:var(--danger); font-size:12px; margin-top:16px; display:none;"></p>
    </div>
</div>

<div id="appLayout" class="app-layout hidden">
    <div class="view-container">
        
        <div id="view-dashboard" class="view-section active">
            <div class="dash-scroll">
                <div class="dash-header">
                    <div>
                        <h1 style="margin:0; color:#1e293b;">Command Center</h1>
                        <p style="color:#64748b; margin:4px 0 0 0; font-size:13px;">System Overview & Analytics</p>
                    </div>
                    <div style="font-size:12px; font-weight:700; color:var(--primary); background:#eff6ff; padding:6px 12px; border-radius:20px;" id="dashDate">...</div>
                </div>

                <div class="kpi-grid">
                    <div class="kpi-card"><div class="kpi-label">Total Tickets</div><div class="kpi-val" id="kpiTotal">0</div></div>
                    <div class="kpi-card" style="border-left-color:var(--warning);"><div class="kpi-label">Pending / Open</div><div class="kpi-val" id="kpiOpen" style="color:var(--warning)">0</div></div>
                    <div class="kpi-card" style="border-left-color:var(--danger);"><div class="kpi-label">Critical Issues</div><div class="kpi-val" id="kpiCrit" style="color:var(--danger)">0</div></div>
                    <div class="kpi-card" style="border-left-color:var(--success);"><div class="kpi-label">Success Rate</div><div class="kpi-val" id="kpiRate" style="color:var(--success)">0</div></div>
                </div>

                <div class="charts-row">
                    <div class="chart-box">
                        <div style="display:flex; justify-content:space-between; margin-bottom:12px;"><h4 style="margin:0; font-size:14px;">Issue Categories</h4></div>
                        <div style="position:relative; height:100%;"><canvas id="chartCat"></canvas></div>
                    </div>
                    <div class="chart-box">
                        <div style="display:flex; justify-content:space-between; margin-bottom:12px;"><h4 style="margin:0; font-size:14px;">Status Ratio</h4></div>
                        <div style="position:relative; height:100%;"><canvas id="chartStat"></canvas></div>
                    </div>
                </div>

                <div class="table-card">
                    <div class="table-header-row">
                        <h3 style="margin:0; font-size:15px;">Global Registry</h3>
                        <div style="position:relative; max-width:220px;">
                            <i class="ri-search-line" style="position:absolute; left:10px; top:50%; transform:translateY(-50%); color:#94a3b8;"></i>
                            <input type="text" id="dashSearch" placeholder="Filter All Tickets..." oninput="dashSearchTerm=this.value.toLowerCase();renderDashTable();" style="width:100%; padding:10px 10px 10px 32px; border:1px solid #e2e8f0; border-radius:8px; font-size:12px;">
                        </div>
                    </div>
                    <div style="overflow-x:auto;">
                        <table id="dashTable">
                            <thead><tr><th>ID</th><th>Date</th><th>Subject</th><th>Requester</th><th>Status</th><th>PIC</th></tr></thead>
                            <tbody id="dashTableBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div id="view-workspace" class="view-section">
            <div class="workspace-grid">
                <aside class="list-sidebar">
                    <div class="list-header">
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
                            <h2 style="margin:0; font-size:18px; font-weight:700;">Incident Queue</h2>
                            <span class="badge" style="background:var(--primary); color:white;" id="qCount">0</span>
                        </div>
                        <div style="position:relative;">
                            <i class="ri-search-line" style="position:absolute; left:12px; top:50%; transform:translateY(-50%); color:#94a3b8;"></i>
                            <input type="text" id="searchInput" class="search-input" placeholder="Search ID or Name..." oninput="renderTickets()">
                        </div>
                        <div class="filter-tabs">
                            <div class="filter-tab active" id="tabAll" onclick="setTab('all')">All Queue</div>
                            <div class="filter-tab" id="tabMine" onclick="setTab('mine')">My Tasks</div>
                            <div class="filter-tab" id="tabCrit" onclick="setTab('critical')" style="color:var(--danger);">Urgent</div>
                        </div>
                    </div>
                    <div class="ticket-scroller" id="ticketList"></div>
                    <div style="padding:16px; border-top:1px solid #e2e8f0; background:white; display:flex; align-items:center; gap:12px;">
                        <div style="width:36px; height:36px; background:var(--primary); color:white; border-radius:50%; display:grid; place-items:center; font-weight:700;" id="myAvatar">T</div>
                        <div><div style="font-weight:700; font-size:13px;" id="myName">Tech</div><div style="font-size:11px; color:var(--success);">● Online</div></div>
                    </div>
                </aside>
                
                <main class="chat-container" id="detailPane">
                    <div id="emptyState" style="height:100%; display:flex; flex-direction:column; align-items:center; justify-content:center; color:#94a3b8;">
                        <div style="width:64px; height:64px; background:#f1f5f9; border-radius:50%; display:grid; place-items:center; margin-bottom:16px;"><i class="ri-inbox-archive-line" style="font-size:28px;"></i></div>
                        <p style="font-size:14px; font-weight:500;">Select a ticket to view details</p>
                    </div>
                    
                    <div id="activeTicket" class="hidden" style="display:flex; flex-direction:column; height:100%;">
                        <div class="chat-header">
                            <div style="display:flex; align-items:center; overflow:hidden;">
                                <button class="btn-back" onclick="closeMobileDetail()"><i class="ri-arrow-left-line"></i></button>
                                <div style="overflow:hidden;">
                                    <div style="display:flex; align-items:center; gap:8px;">
                                        <span id="h_id" style="font-family:monospace; background:#f1f5f9; padding:2px 8px; border-radius:6px; font-size:11px; color:var(--text-secondary); font-weight:700;">#ID</span>
                                        <h2 id="h_subj" style="margin:0; font-size:14px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">Subject</h2>
                                    </div>
                                    <div style="font-size:11px; color:#64748b; margin-top:2px;" id="h_user_dept">User - Dept</div>
                                </div>
                            </div>
                            <button class="btn" id="btnTake" onclick="takeTicket()" style="font-size:11px; padding:6px 12px;">Accept Ticket</button>
                        </div>
                        
                        <div class="timeline-area" id="timelineArea"></div>

                        <div class="chat-footer">
                            <div class="input-mode-toggle">
                                <div class="toggle-opt active" id="optReply" onclick="setMode('reply')"><i class="ri-reply-fill"></i> Reply User</div>
                                <div class="toggle-opt" id="optInternal" onclick="setMode('internal')"><i class="ri-eye-off-fill"></i> Internal Log</div>
                            </div>
                            <textarea id="replyInput" placeholder="Type your public reply to the user..."></textarea>
                            <div style="display:flex; justify-content:space-between; margin-top:12px; align-items:center;">
                                <select id="statusSelect" style="padding:10px; border-radius:8px; border:1px solid #e2e8f0; font-size:13px; max-width:140px; background:white;">
                                    <option value="Open">Status: Open</option>
                                    <option value="Progress">Status: Progress</option>
                                    <option value="Closed">Status: Resolved</option>
                                </select>
                                <button class="btn" onclick="submitUpdate()">Update & Send <i class="ri-send-plane-fill"></i></button>
                            </div>
                        </div>
                    </div>
                </main>
            </div>
        </div>
    </div>

    <nav class="sidebar">
        <div class="brand-icon">Z</div>
        <div class="nav-item active" id="nav-db" onclick="switchView('dashboard')"><i class="ri-dashboard-3-line"></i></div>
        <div class="nav-item" id="nav-ws" onclick="switchView('workspace')"><i class="ri-computer-line"></i></div>
        <div class="nav-item" style="color:var(--danger); margin-top:auto;" onclick="auth.signOut()"><i class="ri-logout-box-line"></i></div>
    </nav>
</div>

<script>
    dayjs.extend(window.dayjs_plugin_relativeTime);
    const firebaseConfig = {
        apiKey: "AIzaSyA9wgSalrlTcveIZi2i-WND86z1i9JYHKw",
        authDomain: "it-support-53eeb.firebaseapp.com",
        databaseURL: "https://it-support-53eeb-default-rtdb.firebaseio.com",
        projectId: "it-support-53eeb",
        storageBucket: "it-support-53eeb.firebasestorage.app",
        messagingSenderId: "573924501146",
        appId: "1:573924501146:web:12f34306ed675472322123"
    };
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const auth = firebase.auth();

    let currentUser = null;
    let reports = [];
    let activeId = null;
    let curTab = 'all';
    let dashSearchTerm = '';
    let isInternalMode = false;
    let chart1 = null, chart2 = null;

    auth.onAuthStateChanged(user => {
        if (user) {
            db.ref('users/' + user.uid).once('value').then(snap => {
                const p = snap.val();
                if (p && (p.role === 'Support' || p.role === 'Admin' || p.departemen === 'IT')) {
                    currentUser = { uid: user.uid, ...p };
                    initApp();
                } else { alert("Access Denied"); auth.signOut(); }
            });
        } else {
            document.getElementById('loginScreen').style.display = 'flex';
            document.getElementById('appLayout').classList.add('hidden');
        }
    });

    async function processLogin() {
        const id = document.getElementById('loginId').value;
        const pass = document.getElementById('loginPass').value;
        const btn = document.querySelector('#loginScreen button');
        btn.innerHTML = '<i class="ri-loader-4-line ri-spin"></i> Authenticating...';
        try {
            let email = id;
            if(!id.includes('@')) {
                const s = await db.ref('users').orderByChild('nik').equalTo(id).once('value');
                if(!s.exists()) throw new Error("User ID not found");
                email = Object.values(s.val())[0].email;
            }
            await auth.signInWithEmailAndPassword(email, pass);
        } catch(e) { 
            btn.innerHTML = 'Authenticate';
            document.getElementById('loginError').style.display='block'; 
            document.getElementById('loginError').textContent = e.message; 
        }
    }

    function initApp() {
        document.getElementById('loginScreen').style.display = 'none';
        document.getElementById('appLayout').classList.remove('hidden');
        document.getElementById('myName').textContent = currentUser.nama.split(' ')[0];
        document.getElementById('myAvatar').textContent = currentUser.nama.charAt(0);
        document.getElementById('dashDate').textContent = dayjs().format('DD MMM YYYY');

        db.ref('reports').on('value', snap => {
            const val = snap.val();
            reports = val ? Object.keys(val).map(k => ({...val[k], id: k})) : [];
            reports.sort((a,b) => new Date(b.created_iso) - new Date(a.created_iso));
            renderTickets();
            updateDashboardData();
            if(activeId) loadTimeline(reports.find(r => r.id === activeId));
        });
        // Auto render chart on start
        setTimeout(renderCharts, 500);
    }

    window.switchView = (view) => {
        document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
        document.getElementById('view-' + view).classList.add('active');
        document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
        if(view === 'workspace') document.getElementById('nav-ws').classList.add('active');
        else {
            document.getElementById('nav-db').classList.add('active');
            updateDashboardData();
            setTimeout(renderCharts, 100);
        }
    };

    window.setTab = (t) => {
        curTab = t;
        document.querySelectorAll('.filter-tab').forEach(el => el.classList.remove('active'));
        if(t==='all') document.getElementById('tabAll').classList.add('active');
        if(t==='mine') document.getElementById('tabMine').classList.add('active');
        if(t==='critical') document.getElementById('tabCrit').classList.add('active');
        renderTickets();
    };

    function renderTickets() {
        const list = document.getElementById('ticketList'); list.innerHTML = '';
        const search = document.getElementById('searchInput').value.toLowerCase();
        let filtered = reports.filter(r => !r.isDeleted && r.status !== 'Closed');
        if(curTab === 'mine') filtered = filtered.filter(r => r.pic === currentUser.nama);
        if(curTab === 'critical') filtered = filtered.filter(r => r.kategori === 'Critical');
        filtered = filtered.filter(r => (r.id+r.nama+r.jenis).toLowerCase().includes(search));
        
        document.getElementById('qCount').textContent = filtered.length;

        filtered.forEach(r => {
            const div = document.createElement('div');
            div.className = `ticket-card ${activeId === r.id ? 'active' : ''}`;
            div.onclick = () => { 
                activeId = r.id; 
                renderTickets(); 
                loadTimeline(r);
                document.getElementById('detailPane').classList.add('mobile-active'); 
            };
            div.innerHTML = `
                <div style="display:flex; justify-content:space-between; font-size:11px; color:#64748b; margin-bottom:4px;">
                    <span style="font-family:monospace; font-weight:700;">${r.id}</span>
                    <span>${dayjs(r.created_iso).fromNow(true)}</span>
                </div>
                <div style="font-weight:600; font-size:14px; margin-bottom:4px; line-height:1.3;">${r.jenis}</div>
                <div style="font-size:12px; color:#64748b;">${r.nama}</div>
                <div style="margin-top:8px;"><span class="badge bg-${r.status}">${r.status}</span></div>
            `;
            list.appendChild(div);
        });
    }

    window.closeMobileDetail = () => document.getElementById('detailPane').classList.remove('mobile-active');

    function loadTimeline(r) {
        if(!r) return;
        document.getElementById('emptyState').classList.add('hidden');
        document.getElementById('activeTicket').classList.remove('hidden');
        document.getElementById('h_id').textContent = r.id;
        document.getElementById('h_subj').textContent = r.jenis;
        document.getElementById('h_user_dept').textContent = `${r.nama} • ${r.departemen || '-'}`;
        document.getElementById('statusSelect').value = r.status;
        
        const btn = document.getElementById('btnTake');
        if(r.pic === currentUser.nama) btn.style.display = 'none';
        else if(r.pic) { btn.textContent = `By ${r.pic.split(' ')[0]}`; btn.disabled = true; btn.style.display='block'; }
        else { btn.textContent = "Take Ticket"; btn.disabled = false; btn.style.display='block'; }

        const tl = document.getElementById('timelineArea'); tl.innerHTML = '';
        tl.innerHTML += `
            <div class="tl-item left">
                <div class="tl-avatar">${r.nama.charAt(0)}</div>
                <div class="tl-bubble">
                    <div style="font-size:10px; color:#94a3b8; margin-bottom:4px;">${dayjs(r.created_iso).format('DD MMM HH:mm')}</div>
                    ${r.catatan || 'No description provided.'}
                </div>
            </div>`;

        if(r.note_internal) {
            r.note_internal.split('\n').filter(l=>l.trim()).forEach(item => {
                if(item.startsWith('[')) {
                    tl.innerHTML += `
                        <div class="tl-item center">
                            <div class="log-box">
                                <i class="ri-information-line"></i>
                                <span>${item}</span>
                            </div>
                        </div>`;
                } else {
                    tl.innerHTML += `<div class="tl-item right"><div class="tl-bubble">${item}</div></div>`;
                }
            });
        }
        tl.scrollTop = tl.scrollHeight;
    }

    window.setMode = (mode) => {
        isInternalMode = (mode === 'internal');
        document.getElementById('optReply').className = isInternalMode ? 'toggle-opt' : 'toggle-opt active';
        document.getElementById('optInternal').className = isInternalMode ? 'toggle-opt active-internal' : 'toggle-opt';
        const area = document.getElementById('replyInput');
        area.placeholder = isInternalMode ? "Log private internal note..." : "Write public reply...";
        area.className = isInternalMode ? "internal-mode" : "";
    };

    window.takeTicket = () => {
        const log = `[PROGRESS ${dayjs().format('HH:mm')} ${currentUser.nama.split(' ')[0]}]: Ticket taken.`;
        db.ref('reports/' + activeId).update({ pic: currentUser.nama, status: 'Progress', note_internal: (reports.find(x=>x.id===activeId).note_internal||"") + `\n${log}` });
    };

    window.submitUpdate = () => {
        const txt = document.getElementById('replyInput').value;
        const st = document.getElementById('statusSelect').value;
        const r = reports.find(x => x.id === activeId);
        let updates = { status: st, updated_iso: new Date().toISOString() };
        if(!r.pic) updates.pic = currentUser.nama;

        let logEntry = "";
        const ts = dayjs().format('DD/MM HH:mm');
        const userShort = currentUser.nama.split(' ')[0];
        
        if(txt) logEntry = isInternalMode ? `[LOG ${ts} ${userShort}]: ${txt}` : `[REPLY ${ts} ${userShort}]: ${txt}`;
        else if (st !== r.status) logEntry = `[STATUS ${ts} ${userShort}]: Changed to ${st}.`;

        if(logEntry) updates.note_internal = (r.note_internal || "") + `\n${logEntry}`;
        
        db.ref('reports/' + activeId).update(updates);
        document.getElementById('replyInput').value = '';
    };

    function updateDashboardData() {
        const all = reports.filter(r => !r.isDeleted);
        document.getElementById('kpiTotal').textContent = all.length;
        document.getElementById('kpiOpen').textContent = all.filter(r => r.status==='Open'||r.status==='Progress').length;
        document.getElementById('kpiCrit').textContent = all.filter(r => r.kategori==='Critical'&&r.status!=='Closed').length;
        document.getElementById('kpiRate').textContent = all.filter(r => r.status==='Closed').length;
        renderDashTable();
    }

    window.renderDashTable = () => {
        const all = reports.filter(r => !r.isDeleted);
        const filtered = all.filter(r => (r.id+r.jenis+r.nama).toLowerCase().includes(dashSearchTerm));
        const tbody = document.getElementById('dashTableBody'); tbody.innerHTML = '';
        filtered.slice(0, 50).forEach(r => {
            tbody.innerHTML += `<tr>
                <td style="font-family:monospace; color:var(--primary); font-weight:700;">${r.id}</td>
                <td>${dayjs(r.created_iso).format('DD/MM')}</td>
                <td>${r.jenis}</td>
                <td>${r.nama}</td>
                <td><span class="badge bg-${r.status}">${r.status}</span></td>
                <td>${r.pic?r.pic.split(' ')[0]:'-'}</td>
            </tr>`;
        });
    };

    function renderCharts() {
        if(!reports.length) return;
        const valid = reports.filter(r => !r.isDeleted);
        const cats = {}; const stats = {Open:0, Progress:0, Closed:0};
        valid.forEach(r => { cats[r.jenis]=(cats[r.jenis]||0)+1; if(stats[r.status]!==undefined)stats[r.status]++; });

        const cfg = { responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}} };
        
        const ctx1 = document.getElementById('chartCat').getContext('2d');
        if(chart1) chart1.destroy();
        chart1 = new Chart(ctx1, { type:'bar', data:{ labels:Object.keys(cats).slice(0,5), datasets:[{data:Object.values(cats).slice(0,5), backgroundColor:'#4f46e5', borderRadius:4}] }, options:cfg });

        const ctx2 = document.getElementById('chartStat').getContext('2d');
        if(chart2) chart2.destroy();
        chart2 = new Chart(ctx2, { type:'doughnut', data:{ labels:['Op','Pr','Cl'], datasets:[{data:[stats.Open,stats.Progress,stats.Closed], backgroundColor:['#f59e0b','#0ea5e9','#10b981'], borderWidth:0}] }, options:{...cfg, cutout:'75%', plugins:{legend:{position:'right'}}} });
    }
</script>
</body>
</html>
