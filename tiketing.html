<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
<title>Zeppelin — Support Workspace</title>
<link rel="icon" type="image/png" href="icov2.png" />
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&family=Plus+Jakarta+Sans:wght@400;600;700&display=swap" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/dayjs/1.11.10/dayjs.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/dayjs/1.11.10/plugin/relativeTime.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
<style>
    :root {
        --font-main: 'Inter', system-ui, -apple-system, sans-serif;
        --font-heading: 'Plus Jakarta Sans', sans-serif;
        --font-mono: 'JetBrains Mono', monospace;
        --bg-body: #f8fafc;
        --bg-surface: #ffffff;
        --bg-sidebar: #0f172a; 
        --border-subtle: #e2e8f0;
        --text-primary: #1e293b;
        --text-secondary: #64748b;
        --text-tertiary: #94a3b8;
        --primary: #4f46e5; 
        --primary-hover: #4338ca;
        --primary-light: #e0e7ff;
        --success: #10b981; --success-bg: #d1fae5;
        --warning: #f59e0b; --warning-bg: #fef3c7;
        --danger: #ef4444; --danger-bg: #fee2e2;
        --info: #0ea5e9; --info-bg: #e0f2fe;
        --shadow-sm: 0 1px 3px 0 rgb(0 0 0 / 0.1);
        --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1);
    }
    * { box-sizing: border-box; outline: none; -webkit-font-smoothing: antialiased; }
    body { margin: 0; font-family: var(--font-main); background: var(--bg-body); color: var(--text-primary); height: 100vh; overflow: hidden; }
    .app-layout { display: grid; grid-template-columns: 80px 1fr; height: 100vh; width: 100vw; }
    .sidebar { background: var(--bg-sidebar); display: flex; flex-direction: column; align-items: center; padding: 24px 0; z-index: 50; }
    .brand-icon { width: 48px; height: 48px; background: linear-gradient(135deg, var(--primary), #8b5cf6); border-radius: 12px; color: white; display: flex; align-items: center; justify-content: center; font-weight: 800; font-size: 24px; margin-bottom: 40px; box-shadow: 0 0 15px rgba(79,70,229,0.3); }
    .nav-item { width: 48px; height: 48px; border-radius: 12px; color: #94a3b8; display: flex; align-items: center; justify-content: center; font-size: 24px; cursor: pointer; transition: all 0.2s; margin-bottom: 12px; position: relative; }
    .nav-item:hover { background: rgba(255,255,255,0.1); color: white; }
    .nav-item.active { background: var(--primary); color: white; box-shadow: 0 4px 12px rgba(79,70,229,0.4); }
    .workspace-grid { display: grid; grid-template-columns: 380px 1fr; height: 100%; }
    .list-sidebar { background: var(--bg-surface); border-right: 1px solid var(--border-subtle); display: flex; flex-direction: column; height: 100%; }
    .list-header { padding: 24px; border-bottom: 1px solid var(--border-subtle); }
    .list-title { font-family: var(--font-heading); font-weight: 700; font-size: 18px; color: var(--text-primary); margin: 0 0 16px 0; }
    .search-box { position: relative; margin-bottom: 16px; }
    .search-box i { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: var(--text-tertiary); }
    .search-input { width: 100%; padding: 10px 10px 10px 36px; border-radius: 8px; border: 1px solid var(--border-subtle); background: var(--bg-body); font-size: 13px; font-family: inherit; }
    .filter-tabs { display: flex; gap: 8px; }
    .filter-tab { flex: 1; padding: 8px; border-radius: 6px; font-size: 12px; font-weight: 600; text-align: center; background: var(--bg-body); color: var(--text-secondary); cursor: pointer; border: 1px solid var(--border-subtle); transition: 0.2s; }
    .filter-tab.active { background: var(--primary); color: white; border-color: var(--primary); }
    .ticket-scroller { flex: 1; overflow-y: auto; padding: 12px; }
    .ticket-card { padding: 16px; border-radius: 12px; background: var(--bg-surface); border: 1px solid var(--border-subtle); margin-bottom: 8px; cursor: pointer; transition: all 0.2s; position: relative; }
    .ticket-card:hover { transform: translateY(-2px); box-shadow: var(--shadow-sm); border-color: var(--primary); }
    .ticket-card.active { background: #f0fdfa; border-color: var(--primary); box-shadow: 0 0 0 2px var(--primary-light); }
    .t-meta { display: flex; justify-content: space-between; font-size: 11px; color: var(--text-secondary); margin-bottom: 6px; }
    .t-subject { font-weight: 600; font-size: 14px; color: var(--text-primary); margin-bottom: 4px; line-height: 1.4; }
    .t-user { display: flex; align-items: center; gap: 6px; font-size: 12px; color: var(--text-secondary); }
    .badge { padding: 2px 8px; border-radius: 4px; font-size: 10px; font-weight: 700; text-transform: uppercase; }
    .bg-Open { background: var(--warning-bg); color: var(--warning); }
    .bg-Progress { background: var(--info-bg); color: var(--info); }
    .bg-Closed { background: var(--success-bg); color: var(--success); }
    .bg-Critical { background: var(--danger-bg); color: var(--danger); }
    .chat-container { background: var(--bg-body); display: flex; flex-direction: column; height: 100%; position: relative; }
    .chat-header { height: 72px; background: var(--bg-surface); border-bottom: 1px solid var(--border-subtle); padding: 0 32px; display: flex; align-items: center; justify-content: space-between; }
    .chat-body { flex: 1; overflow-y: auto; padding: 32px; display: flex; flex-direction: column; gap: 24px; }
    .chat-footer { background: var(--bg-surface); border-top: 1px solid var(--border-subtle); padding: 20px 32px; }
    .chat-bubble { max-width: 80%; padding: 20px; border-radius: 16px; position: relative; box-shadow: var(--shadow-sm); }
    .chat-user { align-self: flex-start; background: var(--bg-surface); border: 1px solid var(--border-subtle); border-top-left-radius: 4px; }
    .chat-tech { align-self: flex-end; background: linear-gradient(135deg, var(--primary), #4338ca); color: white; border-top-right-radius: 4px; }
    .chat-note { align-self: center; width: 100%; background: #fffbeb; border: 1px dashed #f59e0b; color: #92400e; font-size: 13px; padding: 12px 16px; border-radius: 8px; }
    .chat-info { font-size: 11px; margin-bottom: 8px; font-weight: 600; opacity: 0.8; display: flex; justify-content: space-between; }
    .chat-text { font-size: 14px; line-height: 1.6; }
    textarea { width: 100%; height: 80px; padding: 12px; border: 1px solid var(--border-subtle); border-radius: 8px; font-family: var(--font-main); font-size: 14px; resize: none; margin-bottom: 12px; }
    textarea:focus { border-color: var(--primary); box-shadow: 0 0 0 3px var(--primary-light); }
    
    /* DASHBOARD STYLES */
    .dash-container { padding: 32px 48px; overflow-y: auto; height: 100%; background: #f8fafc; }
    .dash-header { display: flex; justify-content: space-between; align-items: end; margin-bottom: 32px; }
    .kpi-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 24px; margin-bottom: 32px; }
    .kpi-card { background: white; padding: 24px; border-radius: 12px; border: 1px solid var(--border-subtle); box-shadow: var(--shadow-sm); position: relative; overflow: hidden; }
    .kpi-card::after { content:''; position: absolute; top:0; left:0; width:4px; height:100%; background: var(--primary); }
    .kpi-card.warn::after { background: var(--warning); }
    .kpi-card.dang::after { background: var(--danger); }
    .kpi-card.succ::after { background: var(--success); }
    .kpi-val { font-size: 36px; font-weight: 800; color: var(--text-primary); margin: 4px 0; letter-spacing: -1px; }
    .kpi-label { font-size: 12px; font-weight: 700; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.5px; }
    
    .charts-row { display: grid; grid-template-columns: 2fr 1fr; gap: 24px; margin-bottom: 32px; height: 320px; }
    .chart-box { background: white; padding: 20px; border-radius: 12px; border: 1px solid var(--border-subtle); box-shadow: var(--shadow-sm); display: flex; flex-direction: column; }
    .chart-header { font-size: 15px; font-weight: 700; margin-bottom: 16px; color: var(--text-primary); display: flex; justify-content: space-between; }
    
    .table-card { background: white; border-radius: 12px; border: 1px solid var(--border-subtle); overflow: hidden; box-shadow: var(--shadow-sm); }
    table { width: 100%; border-collapse: collapse; }
    th { background: #f8fafc; padding: 14px 20px; text-align: left; font-size: 12px; font-weight: 700; color: var(--text-secondary); text-transform: uppercase; border-bottom: 1px solid var(--border-subtle); }
    td { padding: 14px 20px; border-bottom: 1px solid var(--border-subtle); font-size: 13px; color: var(--text-primary); }
    tr:last-child td { border-bottom: none; }
    tr:hover td { background: #fdfdfd; }
    
    .btn { padding: 10px 20px; border-radius: 8px; font-weight: 600; cursor: pointer; border: none; background: var(--primary); color: white; display: inline-flex; align-items: center; gap: 8px; transition: 0.2s; }
    .btn:hover { background: #4338ca; transform: translateY(-1px); }
    .btn-outline { background: white; color: var(--text-primary); border: 1px solid var(--border-subtle); }
    .btn-outline:hover { border-color: var(--primary); color: var(--primary); }
    #loginScreen { position: fixed; inset: 0; background: radial-gradient(circle at top right, #eef2ff, #f8fafc); z-index: 9999; display: flex; align-items: center; justify-content: center; }
    .login-card { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(20px); padding: 48px; border-radius: 24px; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1); width: 420px; border: 1px solid white; }
    .hidden { display: none !important; }
</style>
</head>
<body>

<div id="loginScreen">
    <div class="login-card">
        <div class="brand-icon" style="width:64px; height:64px; font-size:28px; margin:0 auto 24px;">Z</div>
        <h2 style="text-align:center; font-family:var(--font-heading); color:var(--text-primary); margin-bottom:8px;">Technician Access</h2>
        <p style="text-align:center; color:var(--text-secondary); font-size:14px; margin-bottom:32px;">Authorized Support Personnel Only.</p>
        <div style="margin-bottom:20px;">
            <label style="display:block; font-size:12px; font-weight:600; color:var(--text-secondary); margin-bottom:6px;">ID / EMAIL</label>
            <input type="text" id="loginId" placeholder="Access ID" style="width:100%; padding:12px; border:1px solid var(--border-subtle); border-radius:8px;">
        </div>
        <div style="margin-bottom:32px;">
            <label style="display:block; font-size:12px; font-weight:600; color:var(--text-secondary); margin-bottom:6px;">PASSWORD</label>
            <input type="password" id="loginPass" placeholder="••••••••" style="width:100%; padding:12px; border:1px solid var(--border-subtle); border-radius:8px;">
        </div>
        <button id="btnLogin" class="btn" style="width:100%; justify-content:center;" onclick="processLogin()">Secure Login</button>
        <p id="loginError" style="text-align:center; color:var(--danger); font-size:13px; margin-top:16px; display:none;"></p>
    </div>
</div>

<div id="appLayout" class="app-layout hidden">
    <nav class="sidebar">
        <div class="brand-icon">Z</div>
        <div class="nav-item active" onclick="switchView('workspace')" title="Workspace"><i class="ri-computer-line"></i></div>
        <div class="nav-item" onclick="switchView('dashboard')" title="My Dashboard"><i class="ri-dashboard-3-line"></i></div>
        <div style="margin-top:auto;">
            <div class="nav-item" style="color:var(--danger);" onclick="auth.signOut()"><i class="ri-logout-box-line"></i></div>
        </div>
    </nav>

    <div id="view-workspace" class="workspace-grid">
        <aside class="list-sidebar">
            <div class="list-header">
                <h2 class="list-title">Incident Queue</h2>
                <div class="search-box">
                    <i class="ri-search-line"></i>
                    <input type="text" id="searchInput" class="search-input" placeholder="Search ID or User..." oninput="renderTickets(currentTab)">
                </div>
                <div class="filter-tabs">
                    <div class="filter-tab active" id="tabAll" onclick="renderTickets('all')">Queue</div>
                    <div class="filter-tab" id="tabMine" onclick="renderTickets('mine')">My Tasks</div>
                    <div class="filter-tab" id="tabCrit" onclick="renderTickets('critical')" style="color:var(--danger);">Urgent</div>
                </div>
            </div>
            <div class="ticket-scroller" id="ticketList"></div>
            <div style="padding:16px; border-top:1px solid var(--border-subtle); background:var(--bg-surface); display:flex; gap:10px; align-items:center;">
                <div style="width:32px; height:32px; background:var(--primary); color:white; border-radius:50%; display:grid; place-items:center; font-weight:700;" id="myAvatar">T</div>
                <div>
                    <div style="font-weight:700; font-size:13px;" id="myName">Technician</div>
                    <div style="font-size:11px; color:var(--success);">● Online</div>
                </div>
            </div>
        </aside>

        <main class="chat-container">
            <div id="emptyState" style="height:100%; display:flex; flex-direction:column; align-items:center; justify-content:center; color:var(--text-secondary);">
                <i class="ri-customer-service-2-line" style="font-size:64px; margin-bottom:16px; opacity:0.3;"></i>
                <h3>Ready to assist</h3>
                <p>Select a ticket from the queue to start.</p>
            </div>

            <div id="activeTicket" class="hidden" style="display:flex; flex-direction:column; height:100%;">
                <div class="chat-header">
                    <div>
                        <div style="display:flex; align-items:center; gap:12px;">
                            <span id="headId" style="font-family:var(--font-mono); background:var(--bg-body); padding:4px 8px; border-radius:6px; font-size:12px;">#ID</span>
                            <h2 id="headSubject" style="font-size:16px; font-weight:700;">Subject</h2>
                            <span id="headPrio" class="badge bg-Critical hidden">CRITICAL</span>
                        </div>
                        <div style="font-size:12px; color:var(--text-secondary); margin-top:4px;">
                            <i class="ri-user-line"></i> <span id="headUser">User</span> &bull; <span id="headDept">Dept</span>
                        </div>
                    </div>
                    <div>
                        <button class="btn btn-outline" id="btnTake" onclick="takeTicket()">Take Ticket</button>
                    </div>
                </div>

                <div class="chat-body" id="chatArea"></div>

                <div class="chat-footer">
                    <div style="margin-bottom:8px; display:flex; gap:12px; font-size:12px; font-weight:600;">
                        <label style="display:flex; align-items:center; gap:6px; cursor:pointer;">
                            <input type="radio" name="replyMode" value="public" checked onchange="setMode()"> Reply User (Public)
                        </label>
                        <label style="display:flex; align-items:center; gap:6px; cursor:pointer;">
                            <input type="radio" name="replyMode" value="internal" onchange="setMode()"> Internal Note (Private)
                        </label>
                    </div>
                    <textarea id="replyInput" placeholder="Type your response..."></textarea>
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <div style="display:flex; gap:8px;">
                            <select id="statusSelect" style="padding:8px; border-radius:6px; border:1px solid var(--border-subtle);">
                                <option value="Open">Status: Open</option>
                                <option value="Progress">Status: In Progress</option>
                                <option value="Closed">Status: Resolved</option>
                            </select>
                        </div>
                        <button class="btn" onclick="submitResponse()">Update Ticket <i class="ri-send-plane-fill"></i></button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <div id="view-dashboard" class="dash-container hidden">
        <div class="dash-header">
            <div>
                <h1 style="font-family:var(--font-heading); font-size:24px; font-weight:700; color:var(--text-primary);">Command Center</h1>
                <p style="color:var(--text-secondary); margin-top:4px;">Real-time ticketing analytics & overview.</p>
            </div>
            <div style="text-align:right;">
                 <div style="font-size:12px; font-weight:700; color:var(--primary);" id="dashDate">...</div>
            </div>
        </div>
        
        <div class="kpi-grid">
            <div class="kpi-card">
                <div class="kpi-label">Total Tickets</div>
                <div class="kpi-val" id="kpiTotal">0</div>
                <div style="font-size:12px; color:var(--text-secondary);">All time records</div>
            </div>
            <div class="kpi-card warn">
                <div class="kpi-label">Active / Open</div>
                <div class="kpi-val" id="kpiOpen" style="color:var(--warning)">0</div>
                <div style="font-size:12px; color:var(--text-secondary);">Needs attention</div>
            </div>
            <div class="kpi-card dang">
                <div class="kpi-label">Critical Issues</div>
                <div class="kpi-val" id="kpiCrit" style="color:var(--danger)">0</div>
                <div style="font-size:12px; color:var(--text-secondary);">High priority</div>
            </div>
            <div class="kpi-card succ">
                <div class="kpi-label">Resolution Rate</div>
                <div class="kpi-val" id="kpiRate" style="color:var(--success)">0%</div>
                <div style="font-size:12px; color:var(--text-secondary);">Success metric</div>
            </div>
        </div>

        <div class="charts-row">
            <div class="chart-box">
                <div class="chart-header">Ticket Category Distribution</div>
                <div style="position: relative; height: 100%; width: 100%;">
                    <canvas id="chartCategory"></canvas>
                </div>
            </div>
            <div class="chart-box">
                <div class="chart-header">Status Breakdown</div>
                <div style="position: relative; height: 100%; width: 100%;">
                    <canvas id="chartStatus"></canvas>
                </div>
            </div>
        </div>

        <div class="table-card">
            <div style="padding:20px; border-bottom:1px solid var(--border-subtle); display:flex; justify-content:space-between; align-items:center;">
                <h3 style="margin:0; font-size:16px; font-weight:700;">Global Ticket Registry</h3>
                <span style="font-size:12px; color:var(--text-secondary);">Showing all tickets</span>
            </div>
            <div style="overflow-x:auto;">
                <table>
                    <thead>
                        <tr>
                            <th>Ticket ID</th>
                            <th>Date</th>
                            <th>Subject</th>
                            <th>Requester</th>
                            <th>Priority</th>
                            <th>Status</th>
                            <th>PIC</th>
                        </tr>
                    </thead>
                    <tbody id="masterTableBody">
                        </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
    dayjs.extend(window.dayjs_plugin_relativeTime);

    const firebaseConfig = {
        apiKey: "AIzaSyA9wgSalrlTcveIZi2i-WND86z1i9JYHKw",
        authDomain: "it-support-53eeb.firebaseapp.com",
        databaseURL: "https://it-support-53eeb-default-rtdb.firebaseio.com",
        projectId: "it-support-53eeb",
        storageBucket: "it-support-53eeb.firebasestorage.app",
        messagingSenderId: "573924501146",
        appId: "1:573924501146:web:12f34306ed675472322123"
    };
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const auth = firebase.auth();

    let currentUser = null;
    let reports = [];
    let activeTicketId = null;
    let currentTab = 'all';
    let isInternalMode = false;
    let chartCatInstance = null;
    let chartStatInstance = null;

    auth.onAuthStateChanged(user => {
        if (user) {
            db.ref('users/' + user.uid).once('value').then(snap => {
                const profile = snap.val();
                if (profile && (profile.role === 'Admin' || profile.role === 'Support' || profile.departemen === 'IT')) {
                    currentUser = { uid: user.uid, ...profile };
                    initApp();
                } else {
                    alert("ACCESS DENIED: You are not authorized as IT Support.");
                    auth.signOut();
                }
            });
        } else {
            document.getElementById('loginScreen').style.display = 'flex';
            document.getElementById('appLayout').classList.add('hidden');
        }
    });

    async function processLogin() {
        const inputId = document.getElementById('loginId').value.trim();
        const inputPass = document.getElementById('loginPass').value;
        const btn = document.getElementById('btnLogin');
        const err = document.getElementById('loginError');

        if (!inputId || !inputPass) return;
        btn.disabled = true; btn.innerHTML = "Authenticating...";

        try {
            let email = inputId;
            if (!inputId.includes('@')) {
                const snap = await db.ref('users').orderByChild('nik').equalTo(inputId).once('value');
                if(!snap.exists()) throw new Error("ID Not Found");
                email = Object.values(snap.val())[0].email;
            }
            await auth.signInWithEmailAndPassword(email, inputPass);
        } catch (e) {
            btn.disabled = false; btn.innerHTML = "Secure Login";
            err.style.display = 'block'; err.textContent = e.message;
        }
    }

    function initApp() {
        document.getElementById('loginScreen').style.display = 'none';
        document.getElementById('appLayout').classList.remove('hidden');
        document.getElementById('dashDate').textContent = dayjs().format('DD MMMM YYYY');
        
        document.getElementById('myName').textContent = currentUser.nama;
        document.getElementById('myAvatar').textContent = currentUser.nama.charAt(0);

        db.ref('reports').on('value', snap => {
            const data = snap.val();
            reports = data ? Object.keys(data).map(k => ({...data[k], id: k})) : [];
            reports.sort((a,b) => new Date(b.created_iso) - new Date(a.created_iso));
            renderTickets(currentTab);
            updateDashboard(); // Call Dashboard update immediately
            if(activeTicketId) loadDetail(reports.find(r => r.id === activeTicketId));
        });
    }

    function switchView(view) {
        document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
        event.currentTarget.classList.add('active');
        document.getElementById('view-workspace').style.display = view === 'workspace' ? 'grid' : 'none';
        document.getElementById('view-dashboard').style.display = view === 'dashboard' ? 'block' : 'none';
        
        if(view === 'dashboard') {
            updateDashboard();
            setTimeout(renderCharts, 100); // Delay slightly to ensure canvas is visible
        }
    }

    function renderTickets(tab) {
        currentTab = tab;
        const listEl = document.getElementById('ticketList'); listEl.innerHTML = '';
        document.querySelectorAll('.filter-tab').forEach(t => t.classList.remove('active'));
        if(tab === 'all') document.getElementById('tabAll').classList.add('active');
        if(tab === 'mine') document.getElementById('tabMine').classList.add('active');
        if(tab === 'critical') document.getElementById('tabCrit').classList.add('active');

        const search = document.getElementById('searchInput').value.toLowerCase();
        let filtered = reports.filter(r => !r.isDeleted && r.status !== 'Closed');
        
        if (tab === 'mine') filtered = filtered.filter(r => r.pic === currentUser.nama);
        if (tab === 'critical') filtered = filtered.filter(r => r.kategori === 'Critical');

        filtered = filtered.filter(r => 
            r.id.toLowerCase().includes(search) || 
            r.nama.toLowerCase().includes(search) || 
            (r.jenis || '').toLowerCase().includes(search)
        );

        if (filtered.length === 0) listEl.innerHTML = '<div style="text-align:center; padding:20px; color:#94a3b8; font-size:13px;">No tickets found.</div>';

        filtered.forEach(r => {
            const el = document.createElement('div');
            el.className = `ticket-card ${activeTicketId === r.id ? 'active' : ''}`;
            el.onclick = () => selectTicket(r.id);
            const timeAgo = dayjs(r.created_iso).fromNow(true);
            el.innerHTML = `
                <div class="t-meta"><span style="font-family:monospace; font-weight:700; color:var(--primary);">${r.id}</span><span>${timeAgo}</span></div>
                <div class="t-subject">${r.jenis}</div>
                <div class="t-user">${r.nama}</div>
                <div style="margin-top:8px; display:flex; justify-content:space-between; align-items:center;">
                     <span class="badge bg-${r.status}">${r.status}</span>
                     ${r.pic ? `<span style="font-size:10px; color:var(--text-secondary);"><i class="ri-user-star-line"></i> ${r.pic}</span>` : ''}
                </div>
            `;
            listEl.appendChild(el);
        });
    }

    function selectTicket(id) {
        activeTicketId = id;
        renderTickets(currentTab);
        const r = reports.find(r => r.id === id);
        document.getElementById('emptyState').classList.add('hidden');
        document.getElementById('activeTicket').classList.remove('hidden');
        loadDetail(r);
    }

    function loadDetail(r) {
        if(!r) return;
        document.getElementById('headId').textContent = r.id;
        document.getElementById('headSubject').textContent = r.jenis;
        document.getElementById('headUser').textContent = r.nama;
        document.getElementById('headDept').textContent = r.departemen || 'General';
        
        const badge = document.getElementById('headPrio');
        if(r.kategori === 'Critical') badge.classList.remove('hidden'); else badge.classList.add('hidden');

        document.getElementById('statusSelect').value = r.status;
        
        const btnTake = document.getElementById('btnTake');
        if (r.pic === currentUser.nama) {
            btnTake.style.display = 'none';
        } else if (r.pic) {
            btnTake.style.display = 'block'; btnTake.disabled = true; btnTake.textContent = `Assigned to ${r.pic}`;
        } else {
            btnTake.style.display = 'block'; btnTake.disabled = false; btnTake.textContent = "Take Ticket";
        }

        const chat = document.getElementById('chatArea'); chat.innerHTML = '';
        chat.innerHTML += `
            <div class="chat-bubble chat-user">
                <div class="chat-info"><span>${r.nama}</span> <span>${dayjs(r.created_iso).format('DD MMM HH:mm')}</span></div>
                <div class="chat-text"><strong>${r.jenis}</strong><br>${r.catatan || '-'}</div>
            </div>
        `;
        if (r.note_internal) {
            r.note_internal.split('\n').filter(n=>n.trim()).forEach(n => {
                let msg = n;
                if(n.startsWith('[')) { 
                    chat.innerHTML += `<div class="chat-note">${n}</div>`;
                } else {
                    chat.innerHTML += `<div class="chat-bubble chat-tech"><div class="chat-info"><span>Note</span></div><div class="chat-text">${n}</div></div>`;
                }
            });
        }
        chat.scrollTop = chat.scrollHeight;
    }

    function takeTicket() {
        db.ref('reports/' + activeTicketId).update({ pic: currentUser.nama, status: 'Progress' });
    }

    function setMode() {
        isInternalMode = document.querySelector('input[name="replyMode"]:checked').value === 'internal';
        const box = document.getElementById('replyInput');
        if(isInternalMode) {
            box.style.background = '#fffbeb';
            box.placeholder = "Write a private note for other technicians...";
        } else {
            box.style.background = 'white';
            box.placeholder = "Write a reply to the user...";
        }
    }

    function submitResponse() {
        const text = document.getElementById('replyInput').value;
        const status = document.getElementById('statusSelect').value;
        const r = reports.find(x => x.id === activeTicketId);
        if(!r) return;

        let updates = { status: status, updated_iso: new Date().toISOString() };
        if(!r.pic) updates.pic = currentUser.nama;

        if (text) {
            const time = dayjs().format('DD/MM HH:mm');
            const prefix = isInternalMode ? `[INTERNAL ${time} ${currentUser.nama}]` : `[REPLY ${time} ${currentUser.nama}]`;
            const old = r.note_internal || "";
            updates.note_internal = old + `\n${prefix}: ${text}`;
        }
        db.ref('reports/' + activeTicketId).update(updates);
        document.getElementById('replyInput').value = '';
    }

    /* --- DASHBOARD LOGIC (FIXED) --- */
    function updateDashboard() {
        const validReports = reports.filter(r => !r.isDeleted);
        const total = validReports.length;
        const open = validReports.filter(r => r.status === 'Open' || r.status === 'Progress').length;
        const critical = validReports.filter(r => r.kategori === 'Critical' && r.status !== 'Closed').length;
        const closed = validReports.filter(r => r.status === 'Closed').length;
        
        document.getElementById('kpiTotal').textContent = total;
        document.getElementById('kpiOpen').textContent = open;
        document.getElementById('kpiCrit').textContent = critical;
        document.getElementById('kpiRate').textContent = total > 0 ? Math.round((closed/total)*100) + '%' : '0%';

        const tbody = document.getElementById('masterTableBody');
        tbody.innerHTML = '';
        validReports.slice(0, 50).forEach(r => {
            const bg = r.status === 'Closed' ? 'bg-Closed' : (r.status === 'Progress' ? 'bg-Progress' : 'bg-Open');
            tbody.innerHTML += `
                <tr>
                    <td style="font-family:monospace; color:var(--primary); font-weight:600;">${r.id}</td>
                    <td>${dayjs(r.created_iso).format('DD/MM/YY HH:mm')}</td>
                    <td>${r.jenis}</td>
                    <td>${r.nama}</td>
                    <td><span style="color:${r.kategori==='Critical'?'var(--danger)':'inherit'}">${r.kategori}</span></td>
                    <td><span class="badge ${bg}">${r.status}</span></td>
                    <td>${r.pic || '<span style="color:#cbd5e1; font-style:italic;">Unassigned</span>'}</td>
                </tr>
            `;
        });
        
        if(document.getElementById('view-dashboard').style.display === 'block') {
            renderCharts();
        }
    }

    function renderCharts() {
        if(!reports.length) return;

        // 1. Category Chart
        const cats = {};
        reports.forEach(r => { cats[r.jenis] = (cats[r.jenis] || 0) + 1; });
        
        const ctxCat = document.getElementById('chartCategory').getContext('2d');
        if(chartCatInstance) chartCatInstance.destroy();
        chartCatInstance = new Chart(ctxCat, {
            type: 'bar',
            data: {
                labels: Object.keys(cats).slice(0, 8), // Top 8 categories
                datasets: [{
                    label: 'Tickets by Type',
                    data: Object.values(cats).slice(0, 8),
                    backgroundColor: '#4f46e5',
                    borderRadius: 4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: {display: false} },
                scales: { y: {beginAtZero: true} }
            }
        });

        // 2. Status Chart
        const stats = { Open:0, Progress:0, Closed:0 };
        reports.forEach(r => { if(stats[r.status] !== undefined) stats[r.status]++; });
        
        const ctxStat = document.getElementById('chartStatus').getContext('2d');
        if(chartStatInstance) chartStatInstance.destroy();
        chartStatInstance = new Chart(ctxStat, {
            type: 'doughnut',
            data: {
                labels: ['Open', 'In Progress', 'Resolved'],
                datasets: [{
                    data: [stats.Open, stats.Progress, stats.Closed],
                    backgroundColor: ['#f59e0b', '#0ea5e9', '#10b981'],
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                cutout: '65%',
                plugins: { legend: {position:'bottom'} }
            }
        });
    }
</script>
</body>
</html>
