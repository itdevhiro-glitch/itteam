<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
<title>Zeppelin — Tech Workspace</title>
<link rel="icon" type="image/png" href="icov2.png" />
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Plus+Jakarta+Sans:wght@400;600;700&family=JetBrains+Mono:wght@500&display=swap" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">

<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/dayjs/1.11.10/dayjs.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/dayjs/1.11.10/plugin/relativeTime.min.js"></script>

<style>
    :root {
        --font-main: 'Inter', sans-serif;
        --font-heading: 'Plus Jakarta Sans', sans-serif;
        --font-mono: 'JetBrains Mono', monospace;
        --bg-body: #f8fafc;
        --bg-surface: #ffffff;
        --bg-sidebar: #0f172a; 
        --border-subtle: #e2e8f0;
        --text-primary: #1e293b;
        --text-secondary: #64748b;
        --text-on-dark: #f1f5f9;
        --primary: #4f46e5; 
        --primary-light: #e0e7ff;
        --success: #10b981; --success-bg: #d1fae5;
        --warning: #f59e0b; --warning-bg: #fef3c7;
        --danger: #ef4444; --danger-bg: #fee2e2;
        --info: #0ea5e9; --info-bg: #e0f2fe;
        --shadow-sm: 0 1px 3px 0 rgb(0 0 0 / 0.1);
        --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1);
    }

    * { box-sizing: border-box; outline: none; }
    body { margin: 0; font-family: var(--font-main); background: var(--bg-body); color: var(--text-primary); height: 100vh; overflow: hidden; }

    /* LAYOUT UTAMA */
    .app-layout { display: grid; grid-template-columns: 80px 1fr; height: 100vh; width: 100vw; }
    
    /* 1. SIDEBAR NAVIGASI */
    .mini-sidebar { 
        background: var(--bg-sidebar); display: flex; flex-direction: column; align-items: center; padding: 24px 0; z-index: 50; 
        border-right: 1px solid rgba(255,255,255,0.05);
    }
    .brand-icon { 
        width: 48px; height: 48px; background: linear-gradient(135deg, var(--primary), #8b5cf6); 
        border-radius: 12px; color: white; display: flex; align-items: center; justify-content: center; 
        font-weight: 800; font-size: 24px; margin-bottom: 40px; box-shadow: 0 0 15px rgba(79,70,229,0.3);
    }
    .nav-item { 
        width: 48px; height: 48px; border-radius: 12px; color: #94a3b8; 
        display: flex; align-items: center; justify-content: center; font-size: 24px; 
        cursor: pointer; transition: all 0.2s; margin-bottom: 12px; position: relative;
    }
    .nav-item:hover { background: rgba(255,255,255,0.1); color: white; }
    .nav-item.active { background: var(--primary); color: white; box-shadow: 0 4px 12px rgba(79,70,229,0.4); }
    .nav-tooltip {
        position: absolute; left: 60px; background: #1e293b; color: white; padding: 4px 8px; 
        border-radius: 4px; font-size: 12px; opacity: 0; pointer-events: none; transition: 0.2s; white-space: nowrap;
    }
    .nav-item:hover .nav-tooltip { opacity: 1; left: 64px; }

    /* VIEW CONTAINER */
    .main-view { flex: 1; overflow: hidden; display: flex; flex-direction: column; }
    
    /* --- VIEW 1: WORKSPACE (Handling Ticket) --- */
    .workspace-grid { display: grid; grid-template-columns: 350px 1fr; height: 100%; }
    
    /* List Sidebar */
    .list-sidebar { background: var(--bg-surface); border-right: 1px solid var(--border-subtle); display: flex; flex-direction: column; }
    .list-header { padding: 24px; border-bottom: 1px solid var(--border-subtle); }
    .list-title { font-family: var(--font-heading); font-weight: 700; font-size: 18px; color: var(--text-primary); margin: 0; }
    .filter-tabs { display: flex; gap: 8px; margin-top: 16px; }
    .filter-tab { 
        padding: 6px 12px; border-radius: 20px; font-size: 11px; font-weight: 600; 
        background: var(--bg-body); color: var(--text-secondary); cursor: pointer; border: 1px solid var(--border-subtle);
    }
    .filter-tab.active { background: var(--text-primary); color: white; border-color: var(--text-primary); }
    .ticket-scroller { flex: 1; overflow-y: auto; padding: 12px; }
    
    .ticket-card { 
        padding: 16px; border-radius: 12px; background: var(--bg-surface); border: 1px solid var(--border-subtle); 
        margin-bottom: 8px; cursor: pointer; transition: all 0.2s; position: relative;
    }
    .ticket-card:hover { transform: translateY(-2px); box-shadow: var(--shadow-md); border-color: var(--primary); }
    .ticket-card.active { background: #f0fdfa; border-color: var(--primary); box-shadow: 0 0 0 2px var(--primary-light); }
    .t-meta { display: flex; justify-content: space-between; font-size: 11px; color: var(--text-secondary); margin-bottom: 6px; }
    .t-subject { font-weight: 600; font-size: 13px; color: var(--text-primary); margin-bottom: 4px; line-height: 1.4; }
    .t-user { display: flex; align-items: center; gap: 6px; font-size: 12px; color: var(--text-secondary); }
    .avatar-xs { width: 20px; height: 20px; border-radius: 50%; background: #e2e8f0; display: grid; place-items: center; font-size: 10px; font-weight: 700; }
    .badge { padding: 2px 8px; border-radius: 4px; font-size: 10px; font-weight: 700; text-transform: uppercase; }
    .bg-open { background: var(--warning-bg); color: var(--warning); }
    .bg-progress { background: var(--info-bg); color: var(--info); }
    .bg-closed { background: var(--success-bg); color: var(--success); }
    .bg-critical { background: var(--danger-bg); color: var(--danger); }

    /* Chat Area */
    .chat-container { background: var(--bg-body); display: flex; flex-direction: column; height: 100%; position: relative; }
    .chat-header { 
        height: 72px; background: var(--bg-surface); border-bottom: 1px solid var(--border-subtle); 
        padding: 0 32px; display: flex; align-items: center; justify-content: space-between;
    }
    .chat-body { flex: 1; overflow-y: auto; padding: 32px; display: flex; flex-direction: column; gap: 24px; }
    .chat-footer { background: var(--bg-surface); border-top: 1px solid var(--border-subtle); padding: 20px 32px; }
    
    .chat-bubble { max-width: 80%; padding: 20px; border-radius: 16px; position: relative; box-shadow: var(--shadow-sm); }
    .chat-user { align-self: flex-start; background: var(--bg-surface); border: 1px solid var(--border-subtle); border-top-left-radius: 4px; }
    .chat-tech { align-self: flex-end; background: linear-gradient(135deg, var(--primary), #4338ca); color: white; border-top-right-radius: 4px; }
    .chat-note { align-self: center; width: 100%; background: #fffbeb; border: 1px dashed #f59e0b; color: #92400e; font-size: 13px; padding: 12px 16px; border-radius: 8px; }
    .chat-info { font-size: 11px; margin-bottom: 8px; font-weight: 600; opacity: 0.8; display: flex; justify-content: space-between; }
    .chat-text { font-size: 14px; line-height: 1.6; }

    textarea { 
        width: 100%; height: 80px; padding: 12px; border: 1px solid var(--border-subtle); border-radius: 8px;
        font-family: var(--font-main); font-size: 14px; resize: none; margin-bottom: 12px;
    }
    textarea:focus { border-color: var(--primary); box-shadow: 0 0 0 3px var(--primary-light); }

    /* --- VIEW 2: MY DASHBOARD --- */
    .dash-container { padding: 32px 48px; overflow-y: auto; height: 100%; }
    .dash-header { margin-bottom: 32px; }
    .dash-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 24px; margin-bottom: 32px; }
    
    .stat-box { background: var(--bg-surface); padding: 24px; border-radius: 16px; border: 1px solid var(--border-subtle); box-shadow: var(--shadow-sm); }
    .stat-val { font-size: 32px; font-weight: 800; color: var(--text-primary); margin: 8px 0; }
    .stat-label { font-size: 13px; color: var(--text-secondary); font-weight: 600; text-transform: uppercase; }
    
    .table-card { background: var(--bg-surface); border-radius: 16px; border: 1px solid var(--border-subtle); overflow: hidden; box-shadow: var(--shadow-sm); }
    table { width: 100%; border-collapse: collapse; }
    th { background: var(--bg-body); padding: 16px 24px; text-align: left; font-size: 12px; font-weight: 600; color: var(--text-secondary); text-transform: uppercase; border-bottom: 1px solid var(--border-subtle); }
    td { padding: 16px 24px; border-bottom: 1px solid var(--border-subtle); font-size: 14px; color: var(--text-primary); }
    tr:hover td { background: #f8fafc; }

    /* UTILS */
    .btn { padding: 10px 20px; border-radius: 8px; font-weight: 600; cursor: pointer; border: none; background: var(--primary); color: white; display: inline-flex; align-items: center; gap: 8px; transition: 0.2s; }
    .btn:hover { background: #4338ca; transform: translateY(-1px); }
    .btn-outline { background: white; color: var(--text-primary); border: 1px solid var(--border-subtle); }
    .btn-outline:hover { border-color: var(--primary); color: var(--primary); }
    
    #loginScreen { position: fixed; inset: 0; background: radial-gradient(circle at top right, #eef2ff, #f8fafc); z-index: 9999; display: flex; align-items: center; justify-content: center; }
    .login-card { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(20px); padding: 48px; border-radius: 24px; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1); width: 420px; border: 1px solid white; }
    
    .hidden { display: none !important; }
    .empty-state { height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; color: var(--text-secondary); }
    .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 1000; display: none; align-items: center; justify-content: center; }
    .modal-box { background: white; padding: 32px; border-radius: 16px; width: 400px; max-width: 90%; }
</style>
</head>
<body>

<div id="loginScreen">
    <div class="login-card">
        <div class="brand-icon" style="width:64px; height:64px; font-size:28px; margin:0 auto 24px;">Z</div>
        <h2 style="text-align:center; font-family:var(--font-heading); color:var(--text-primary); margin-bottom:8px;">Technician Portal</h2>
        <p style="text-align:center; color:var(--text-secondary); font-size:14px; margin-bottom:32px;">Masuk menggunakan Email atau NIK.</p>
        <div style="margin-bottom:20px;">
            <label style="display:block; font-size:12px; font-weight:600; color:var(--text-secondary); margin-bottom:6px;">ID PENGGUNA</label>
            <input type="text" id="loginId" placeholder="Email / NIK" style="width:100%; padding:12px; border:1px solid var(--border-subtle); border-radius:8px;">
        </div>
        <div style="margin-bottom:32px;">
            <label style="display:block; font-size:12px; font-weight:600; color:var(--text-secondary); margin-bottom:6px;">PASSWORD</label>
            <input type="password" id="loginPass" placeholder="••••••••" style="width:100%; padding:12px; border:1px solid var(--border-subtle); border-radius:8px;">
        </div>
        <button id="btnLogin" class="btn" style="width:100%; justify-content:center;" onclick="processLogin()">Masuk ke Workspace</button>
        <p id="loginError" style="text-align:center; color:var(--danger); font-size:13px; margin-top:16px; display:none;"></p>
    </div>
</div>

<div id="appLayout" class="app-layout hidden">
    <nav class="mini-sidebar">
        <div class="brand-icon">Z</div>
        <div class="nav-item active" onclick="switchView('workspace')" title="Workspace"><i class="ri-computer-line"></i><span class="nav-tooltip">Workspace</span></div>
        <div class="nav-item" onclick="switchView('dashboard')" title="My Dashboard"><i class="ri-dashboard-line"></i><span class="nav-tooltip">My Stats</span></div>
        <div style="margin-top:auto;">
            <div class="nav-item" style="color:var(--danger);" onclick="auth.signOut()"><i class="ri-logout-box-line"></i></div>
        </div>
    </nav>

    <div class="main-view">
        <div id="view-workspace" class="workspace-grid">
            <aside class="list-sidebar">
                <div class="list-header">
                    <h2 class="list-title">Incident Queue</h2>
                    <div class="filter-tabs">
                        <div class="filter-tab active" id="tabAll" onclick="renderTickets('all')">Open</div>
                        <div class="filter-tab" id="tabMine" onclick="renderTickets('mine')">My Tasks</div>
                        <div class="filter-tab" id="tabCrit" onclick="renderTickets('critical')" style="color:var(--danger);">Urgent</div>
                    </div>
                </div>
                <div class="ticket-scroller" id="ticketList"></div>
                <div style="padding:16px; border-top:1px solid var(--border-subtle); background:var(--bg-surface); display:flex; gap:10px; align-items:center;">
                    <div class="avatar-xs" id="myAvatar" style="background:var(--primary); color:white; width:32px; height:32px; font-size:14px;">T</div>
                    <div>
                        <div style="font-weight:700; font-size:13px;" id="myName">Technician</div>
                        <div style="font-size:11px; color:var(--success);">● Online</div>
                    </div>
                </div>
            </aside>

            <main class="chat-container">
                <div id="emptyState" class="empty-state">
                    <i class="ri-customer-service-2-line" style="font-size:64px; color:#cbd5e1; margin-bottom:16px;"></i>
                    <h3>Ready to work?</h3>
                    <p>Pilih tiket dari antrian untuk mulai menangani.</p>
                </div>

                <div id="activeTicket" class="hidden" style="display:flex; flex-direction:column; height:100%;">
                    <div class="chat-header">
                        <div>
                            <div style="display:flex; align-items:center; gap:12px;">
                                <span id="headId" style="font-family:var(--font-mono); background:var(--bg-body); padding:4px 8px; border-radius:6px; font-size:12px;">#ID</span>
                                <h2 id="headSubject" style="font-size:16px; font-weight:700;">Subject</h2>
                            </div>
                            <div style="font-size:12px; color:var(--text-secondary); margin-top:4px;">
                                <span id="headUser"><i class="ri-user-line"></i> User</span> &bull; 
                                <span id="headDept">Dept</span>
                            </div>
                        </div>
                        <div style="display:flex; gap:8px;">
                            <button class="btn btn-outline" onclick="openAssetModal()"><i class="ri-macbook-line"></i> Check Asset</button>
                            <button class="btn btn-outline" onclick="startRemote()"><i class="ri-remote-control-line"></i> Remote</button>
                        </div>
                    </div>

                    <div class="chat-body" id="chatArea"></div>

                    <div class="chat-footer">
                        <div style="margin-bottom:8px; display:flex; gap:12px; font-size:12px; font-weight:600;">
                            <label style="display:flex; align-items:center; gap:6px; cursor:pointer;">
                                <input type="radio" name="replyMode" value="public" checked onchange="setMode()"> Balas User (Public)
                            </label>
                            <label style="display:flex; align-items:center; gap:6px; cursor:pointer;">
                                <input type="radio" name="replyMode" value="internal" onchange="setMode()"> Catatan Internal (Rahasia)
                            </label>
                        </div>
                        <textarea id="replyInput" placeholder="Tulis balasan solusi..."></textarea>
                        <div style="display:flex; justify-content:space-between; align-items:center;">
                            <div style="display:flex; gap:8px;">
                                <select id="statusSelect" style="padding:8px; border-radius:6px; border:1px solid var(--border-subtle);">
                                    <option value="Open">Status: Open</option>
                                    <option value="Progress">Status: In Progress</option>
                                    <option value="Closed">Status: Resolved</option>
                                </select>
                                <select id="prioSelect" style="padding:8px; border-radius:6px; border:1px solid var(--border-subtle);">
                                    <option value="Low">Low</option>
                                    <option value="Normal">Normal</option>
                                    <option value="Critical">Critical</option>
                                </select>
                            </div>
                            <button class="btn" onclick="submitResponse()">Kirim & Update <i class="ri-send-plane-fill"></i></button>
                        </div>
                    </div>
                </div>
            </main>
        </div>

        <div id="view-dashboard" class="dash-container hidden">
            <div class="dash-header">
                <h1 style="font-family:var(--font-heading); font-size:24px; font-weight:700;">My Performance</h1>
                <p style="color:var(--text-secondary);">Statistik kinerja tiket yang Anda tangani.</p>
            </div>
            
            <div class="dash-grid">
                <div class="stat-box">
                    <div class="stat-label">Total Handled</div>
                    <div class="stat-val" id="dTotal">0</div>
                    <div style="font-size:12px; color:var(--success);"><i class="ri-arrow-up-line"></i> All Time</div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">Resolved This Month</div>
                    <div class="stat-val" id="dMonth">0</div>
                    <div style="font-size:12px; color:var(--text-secondary);">Tickets closed</div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">Active Now</div>
                    <div class="stat-val" id="dActive" style="color:var(--primary);">0</div>
                    <div style="font-size:12px; color:var(--text-secondary);">In Progress Queue</div>
                </div>
            </div>

            <h3 style="margin-bottom:16px; font-size:16px; font-weight:700;">Riwayat Penyelesaian Saya</h3>
            <div class="table-card">
                <table>
                    <thead><tr><th>ID</th><th>Subject</th><th>User</th><th>Date Closed</th><th>Category</th></tr></thead>
                    <tbody id="historyTable"></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<div id="modalAsset" class="modal-overlay">
    <div class="modal-box">
        <h3 style="margin-top:0;">Asset Information</h3>
        <p style="color:var(--text-secondary); font-size:13px; margin-bottom:16px;">Perangkat yang terdaftar pada user ini.</p>
        <div style="background:#f8fafc; padding:12px; border-radius:8px; border:1px solid #e2e8f0; margin-bottom:8px;">
            <div style="font-weight:700;">MacBook Pro M1 (LPT-001)</div>
            <div style="font-size:12px; color:#64748b;">Serial: C02XXXXXXX</div>
        </div>
        <div style="text-align:right; margin-top:20px;">
            <button class="btn btn-outline" onclick="document.getElementById('modalAsset').style.display='none'">Close</button>
        </div>
    </div>
</div>

<script>
    dayjs.extend(window.dayjs_plugin_relativeTime);

    const firebaseConfig = {
        apiKey: "AIzaSyA9wgSalrlTcveIZi2i-WND86z1i9JYHKw",
        authDomain: "it-support-53eeb.firebaseapp.com",
        databaseURL: "https://it-support-53eeb-default-rtdb.firebaseio.com",
        projectId: "it-support-53eeb",
        storageBucket: "it-support-53eeb.firebasestorage.app",
        messagingSenderId: "573924501146",
        appId: "1:573924501146:web:12f34306ed675472322123"
    };
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const auth = firebase.auth();

    let currentUser = null;
    let activeTicketId = null;
    let reports = [];
    let isInternalMode = false;

    auth.onAuthStateChanged(user => {
        if (user) {
            db.ref('users/' + user.uid).once('value').then(snap => {
                const profile = snap.val();
                if (profile && (profile.role === 'Admin' || profile.role === 'Support' || profile.departemen === 'IT' || profile.status === 'approved')) {
                    currentUser = { uid: user.uid, ...profile };
                    initApp();
                } else {
                    alert("Akses ditolak. Akun tidak valid.");
                    auth.signOut();
                }
            });
        } else {
            document.getElementById('loginScreen').style.display = 'flex';
            document.getElementById('appLayout').classList.add('hidden');
        }
    });

    async function processLogin() {
        const inputId = document.getElementById('loginId').value.trim();
        const inputPass = document.getElementById('loginPass').value;
        const btn = document.getElementById('btnLogin');
        const err = document.getElementById('loginError');

        if (!inputId || !inputPass) { err.style.display='block'; err.textContent="Isi ID & Password"; return; }
        btn.disabled = true; btn.innerHTML = "Memuat...";

        try {
            let email = inputId;
            if (!inputId.includes('@')) {
                const snap = await db.ref('users').once('value');
                const users = snap.val();
                let found = null;
                for (let k in users) if (users[k].nik == inputId) found = users[k];
                if (!found) throw new Error("NIK tidak ditemukan.");
                email = found.email;
            }
            await auth.signInWithEmailAndPassword(email, inputPass);
        } catch (e) {
            btn.disabled = false; btn.innerHTML = "Masuk ke Workspace";
            err.style.display = 'block'; err.textContent = e.message;
        }
    }

    function initApp() {
        document.getElementById('loginScreen').style.display = 'none';
        document.getElementById('appLayout').classList.remove('hidden');
        
        document.getElementById('myName').textContent = currentUser.nama;
        document.getElementById('myAvatar').textContent = currentUser.nama.charAt(0);

        db.ref('reports').on('value', snap => {
            const data = snap.val();
            reports = data ? Object.keys(data).map(k => ({...data[k], id: k})) : [];
            reports.sort((a,b) => new Date(b.created_iso) - new Date(a.created_iso));
            
            const activeTab = document.querySelector('.filter-tab.active');
            renderTickets(activeTab ? activeTab.id : 'tabAll');
            renderDashboard();
            
            if(activeTicketId) loadTicketDetail(reports.find(r => r.id === activeTicketId));
        });
    }

    function switchView(view) {
        document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
        event.currentTarget.classList.add('active');
        
        document.getElementById('view-workspace').style.display = view === 'workspace' ? 'grid' : 'none';
        document.getElementById('view-dashboard').style.display = view === 'dashboard' ? 'block' : 'none';
        if(view === 'dashboard') renderDashboard();
    }

    function renderTickets(tabId) {
        const listEl = document.getElementById('ticketList'); listEl.innerHTML = '';
        document.querySelectorAll('.filter-tab').forEach(t => t.classList.remove('active'));
        document.getElementById(tabId).classList.add('active');

        let filtered = reports.filter(r => !r.isDeleted && r.status !== 'Closed');
        if (tabId === 'tabMine') filtered = filtered.filter(r => r.pic === currentUser.nama);
        if (tabId === 'tabCrit') filtered = filtered.filter(r => r.kategori === 'Critical');

        if (filtered.length === 0) listEl.innerHTML = '<div style="text-align:center; padding:20px; color:#94a3b8; font-size:13px;">No tickets found.</div>';

        filtered.forEach(r => {
            const el = document.createElement('div');
            el.className = `ticket-card ${activeTicketId === r.id ? 'active' : ''}`;
            el.onclick = () => selectTicket(r.id);
            const timeAgo = dayjs(r.created_iso).fromNow(true);
            let bg = r.status === 'Open' ? 'bg-open' : 'bg-progress';
            if(r.kategori === 'Critical') bg = 'bg-critical';

            el.innerHTML = `
                <div class="t-meta"><span style="font-family:monospace; font-weight:700;">${r.id}</span><span>${timeAgo}</span></div>
                <div class="t-subject">${r.jenis}</div>
                <div class="t-user"><div class="avatar-xs">${r.nama.charAt(0)}</div> ${r.nama}</div>
                <div style="margin-top:8px;"><span class="badge ${bg}">${r.status}</span></div>
            `;
            listEl.appendChild(el);
        });
    }

    function selectTicket(id) {
        activeTicketId = id;
        renderTickets(document.querySelector('.filter-tab.active').id);
        const r = reports.find(r => r.id === id);
        document.getElementById('emptyState').classList.add('hidden');
        document.getElementById('activeTicket').classList.remove('hidden');
        loadTicketDetail(r);
    }

    function loadTicketDetail(r) {
        if(!r) return;
        document.getElementById('headId').textContent = r.id;
        document.getElementById('headSubject').textContent = r.jenis;
        document.getElementById('headUser').innerHTML = `<i class="ri-user-line"></i> ${r.nama}`;
        document.getElementById('headDept').innerHTML = `<i class="ri-building-line"></i> ${r.departemen || '-'}`;
        
        document.getElementById('statusSelect').value = r.status;
        document.getElementById('prioSelect').value = r.kategori;

        const chat = document.getElementById('chatArea'); chat.innerHTML = '';
        chat.innerHTML += `
            <div class="chat-bubble chat-user">
                <div class="chat-info"><span>${r.nama}</span> <span>${dayjs(r.created_iso).format('HH:mm')}</span></div>
                <div class="chat-text"><strong>${r.jenis}</strong><br>${r.catatan || '-'}</div>
            </div>
        `;
        if (r.note_internal) {
            r.note_internal.split('\n').filter(n=>n.trim()).forEach(n => chat.innerHTML += `<div class="chat-note"><strong>Internal Log:</strong> ${n}</div>`);
        }
        if (r.status === 'Progress') {
             chat.innerHTML += `<div class="chat-bubble chat-tech"><div class="chat-info"><span>System</span></div><div class="chat-text">Ticket marked In Progress by ${r.pic}.</div></div>`;
        }
    }

    window.setMode = () => {
        isInternalMode = document.querySelector('input[name="replyMode"]:checked').value === 'internal';
        const box = document.getElementById('replyInput');
        box.style.background = isInternalMode ? '#fffbeb' : 'white';
        box.placeholder = isInternalMode ? "Tulis catatan rahasia..." : "Tulis balasan ke user...";
    };

    window.submitResponse = () => {
        const text = document.getElementById('replyInput').value;
        const status = document.getElementById('statusSelect').value;
        const prio = document.getElementById('prioSelect').value;
        const r = reports.find(x => x.id === activeTicketId);

        let updates = { status: status, kategori: prio, pic: currentUser.nama };
        if (text) {
            if (isInternalMode) {
                const old = r.note_internal || "";
                updates.note_internal = old + `\n[${dayjs().format('DD/MM HH:mm')} ${currentUser.nama}]: ${text}`;
            } else {
                alert(`Email terkirim ke ${r.nama}: "${text}"`);
            }
        }
        db.ref('reports/' + activeTicketId).update(updates);
        document.getElementById('replyInput').value = '';
    };

    function renderDashboard() {
        const myHandled = reports.filter(r => r.pic === currentUser.nama);
        const myClosed = myHandled.filter(r => r.status === 'Closed');
        
        document.getElementById('dTotal').textContent = myHandled.length;
        document.getElementById('dMonth').textContent = myClosed.length; // Simplified logic
        document.getElementById('dActive').textContent = myHandled.filter(r => r.status !== 'Closed').length;

        const tbody = document.getElementById('historyTable'); tbody.innerHTML = '';
        myClosed.slice(0, 10).forEach(r => {
            tbody.innerHTML += `<tr>
                <td style="font-family:monospace;">${r.id}</td>
                <td>${r.jenis}</td>
                <td>${r.nama}</td>
                <td>${dayjs(r.updated_iso || r.created_iso).format('DD MMM YYYY')}</td>
                <td><span class="badge bg-closed">${r.kategori}</span></td>
            </tr>`;
        });
    }

    window.openAssetModal = () => document.getElementById('modalAsset').style.display = 'flex';
    window.startRemote = () => alert("Initiating secure remote connection tunnel...");
</script>
</body>
</html>
