<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
<title>Zeppelin — Technician Workspace</title>
<link rel="icon" type="image/png" href="icov2.png" />
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Plus+Jakarta+Sans:wght@400;600;700&family=JetBrains+Mono:wght@500&display=swap" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">

<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/dayjs/1.11.10/dayjs.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/dayjs/1.11.10/plugin/relativeTime.min.js"></script>

<style>
    :root {
        --font-main: 'Inter', system-ui, sans-serif;
        --font-heading: 'Plus Jakarta Sans', sans-serif;
        --font-mono: 'JetBrains Mono', monospace;
        --bg-body: #f8fafc;
        --bg-surface: #ffffff;
        --bg-sidebar: #0f172a; 
        --border-subtle: #e2e8f0;
        --text-primary: #1e293b;
        --text-secondary: #64748b;
        --text-on-dark: #f1f5f9;
        --primary: #4f46e5; 
        --primary-light: #e0e7ff;
        --success: #10b981;
        --success-bg: #d1fae5;
        --warning: #f59e0b;
        --warning-bg: #fef3c7;
        --danger: #ef4444;
        --danger-bg: #fee2e2;
        --shadow-sm: 0 1px 3px 0 rgb(0 0 0 / 0.1);
        --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1);
    }

    * { box-sizing: border-box; outline: none; }
    body { margin: 0; font-family: var(--font-main); background: var(--bg-body); color: var(--text-primary); height: 100vh; overflow: hidden; }

    .app-layout { display: grid; grid-template-columns: 80px 380px 1fr; height: 100vh; width: 100vw; }
    
    .mini-sidebar { 
        background: var(--bg-sidebar); display: flex; flex-direction: column; align-items: center; padding: 24px 0; z-index: 50; 
    }
    .brand-icon { 
        width: 48px; height: 48px; background: linear-gradient(135deg, var(--primary), #8b5cf6); 
        border-radius: 12px; color: white; display: flex; align-items: center; justify-content: center; 
        font-weight: 800; font-size: 24px; margin-bottom: 40px; box-shadow: 0 0 15px rgba(79,70,229,0.3);
    }
    .nav-icon { 
        width: 48px; height: 48px; border-radius: 12px; color: #94a3b8; 
        display: flex; align-items: center; justify-content: center; font-size: 24px; 
        cursor: pointer; transition: all 0.2s; margin-bottom: 12px;
    }
    .nav-icon:hover { background: rgba(255,255,255,0.1); color: white; }
    .nav-icon.active { background: var(--primary); color: white; box-shadow: 0 4px 12px rgba(79,70,229,0.4); }

    .list-sidebar { 
        background: var(--bg-surface); border-right: 1px solid var(--border-subtle); 
        display: flex; flex-direction: column;
    }
    .list-header { padding: 24px; border-bottom: 1px solid var(--border-subtle); }
    .list-title { font-family: var(--font-heading); font-weight: 700; font-size: 18px; color: var(--text-primary); margin: 0; }
    .filter-tabs { display: flex; gap: 8px; margin-top: 16px; }
    .filter-tab { 
        padding: 6px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; 
        background: var(--bg-body); color: var(--text-secondary); cursor: pointer; border: 1px solid var(--border-subtle);
    }
    .filter-tab.active { background: var(--text-primary); color: white; border-color: var(--text-primary); }
    
    .ticket-scroller { flex: 1; overflow-y: auto; padding: 12px; }
    .ticket-card { 
        padding: 16px; border-radius: 12px; background: var(--bg-surface); border: 1px solid var(--border-subtle); 
        margin-bottom: 8px; cursor: pointer; transition: all 0.2s; position: relative;
    }
    .ticket-card:hover { transform: translateY(-2px); box-shadow: var(--shadow-md); border-color: var(--primary); }
    .ticket-card.active { background: #f0fdfa; border-color: var(--primary); box-shadow: 0 0 0 2px var(--primary-light); }
    
    .t-meta { display: flex; justify-content: space-between; font-size: 11px; color: var(--text-secondary); margin-bottom: 6px; }
    .t-subject { font-weight: 600; font-size: 14px; color: var(--text-primary); margin-bottom: 4px; line-height: 1.4; }
    .t-user { display: flex; align-items: center; gap: 6px; font-size: 12px; color: var(--text-secondary); }
    .avatar-xs { width: 20px; height: 20px; border-radius: 50%; background: #e2e8f0; display: grid; place-items: center; font-size: 10px; font-weight: 700; }
    
    .badge { padding: 2px 8px; border-radius: 4px; font-size: 10px; font-weight: 700; text-transform: uppercase; }
    .bg-open { background: var(--warning-bg); color: var(--warning); }
    .bg-progress { background: #e0f2fe; color: #0284c7; }
    .bg-closed { background: var(--success-bg); color: var(--success); }
    .bg-critical { background: var(--danger-bg); color: var(--danger); }

    .workspace { background: var(--bg-body); display: flex; flex-direction: column; position: relative; }
    
    .ws-header { 
        height: 72px; background: var(--bg-surface); border-bottom: 1px solid var(--border-subtle); 
        padding: 0 32px; display: flex; align-items: center; justify-content: space-between;
    }
    .ws-title h2 { font-family: var(--font-heading); font-size: 18px; margin: 0; font-weight: 700; }
    .ws-meta { font-size: 13px; color: var(--text-secondary); display: flex; gap: 16px; margin-top: 4px; }
    
    .ws-body { flex: 1; overflow-y: auto; padding: 32px; display: flex; flex-direction: column; gap: 24px; }
    
    .chat-bubble { max-width: 80%; padding: 20px; border-radius: 16px; position: relative; box-shadow: var(--shadow-sm); }
    .chat-user { align-self: flex-start; background: var(--bg-surface); border: 1px solid var(--border-subtle); border-top-left-radius: 4px; }
    .chat-tech { align-self: flex-end; background: linear-gradient(135deg, var(--primary), #4338ca); color: white; border-top-right-radius: 4px; }
    .chat-note { align-self: center; width: 100%; background: #fffbeb; border: 1px dashed #f59e0b; color: #92400e; font-size: 13px; padding: 12px 16px; border-radius: 8px; }
    
    .chat-info { font-size: 11px; margin-bottom: 8px; font-weight: 600; opacity: 0.8; display: flex; justify-content: space-between; }
    .chat-text { font-size: 14px; line-height: 1.6; }

    .ws-footer { 
        background: var(--bg-surface); border-top: 1px solid var(--border-subtle); padding: 20px 32px; 
    }
    .input-tabs { display: flex; gap: 1px; margin-bottom: 1px; }
    .input-tab { 
        padding: 8px 16px; background: var(--bg-body); border: 1px solid var(--border-subtle); border-bottom: none;
        border-radius: 8px 8px 0 0; font-size: 12px; font-weight: 600; color: var(--text-secondary); cursor: pointer;
    }
    .input-tab.active { background: white; color: var(--primary); border-top: 2px solid var(--primary); }
    
    textarea { 
        width: 100%; height: 100px; padding: 16px; border: 1px solid var(--border-subtle); border-radius: 0 8px 8px 8px;
        font-family: var(--font-main); font-size: 14px; resize: none; 
    }
    textarea:focus { border-color: var(--primary); box-shadow: 0 0 0 4px var(--primary-light); }
    
    .action-bar { display: flex; justify-content: space-between; margin-top: 16px; align-items: center; }
    .status-select { padding: 8px 12px; border-radius: 8px; border: 1px solid var(--border-subtle); background: var(--bg-surface); font-size: 13px; }

    #loginScreen { position: fixed; inset: 0; background: radial-gradient(circle at top right, #eef2ff, #f8fafc); z-index: 9999; display: flex; align-items: center; justify-content: center; }
    .login-card { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(20px); padding: 48px; border-radius: 24px; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1); width: 420px; border: 1px solid white; }
    
    .btn { padding: 10px 20px; border-radius: 8px; font-weight: 600; cursor: pointer; border: none; background: var(--primary); color: white; display: inline-flex; align-items: center; gap: 8px; transition: 0.2s; }
    .btn:hover { background: #4338ca; transform: translateY(-1px); }
    .btn:disabled { opacity: 0.7; cursor: not-allowed; }
    .hidden { display: none !important; }
    .empty-state { height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; color: var(--text-secondary); }
    
    @media (max-width: 1024px) {
        .app-layout { grid-template-columns: 80px 1fr; }
        .list-sidebar { display: none; } 
        .list-sidebar.mobile-open { display: flex; position: fixed; width: 300px; height: 100%; z-index: 100; left: 80px; }
    }
</style>
</head>
<body>

<div id="loginScreen">
    <div class="login-card">
        <div class="brand-icon" style="width:64px; height:64px; font-size:28px; margin:0 auto 24px;">Z</div>
        <h2 style="text-align:center; font-family:var(--font-heading); color:var(--text-primary); margin-bottom:8px;">Technician Portal</h2>
        <p style="text-align:center; color:var(--text-secondary); font-size:14px; margin-bottom:32px;">Masuk untuk menangani tiket & insiden.</p>
        
        <div style="margin-bottom:20px;">
            <label style="display:block; font-size:12px; font-weight:600; color:var(--text-secondary); margin-bottom:6px;">ID PENGGUNA</label>
            <input type="text" id="loginId" placeholder="Masukkan Email atau NIK (Employee ID)" style="width:100%; padding:12px; border:1px solid var(--border-subtle); border-radius:8px;">
        </div>
        <div style="margin-bottom:32px;">
            <label style="display:block; font-size:12px; font-weight:600; color:var(--text-secondary); margin-bottom:6px;">PASSWORD</label>
            <input type="password" id="loginPass" placeholder="••••••••" style="width:100%; padding:12px; border:1px solid var(--border-subtle); border-radius:8px;">
        </div>
        
        <button id="btnLogin" class="btn" style="width:100%; justify-content:center;" onclick="processLogin()">
            Masuk ke Workspace
        </button>
        <p id="loginError" style="text-align:center; color:var(--danger); font-size:13px; margin-top:16px; display:none;"></p>
    </div>
</div>

<div id="appLayout" class="app-layout hidden">
    
    <nav class="mini-sidebar">
        <div class="brand-icon">Z</div>
        <div class="nav-icon active" title="Tiket Masuk"><i class="ri-ticket-2-line"></i></div>
        <div class="nav-icon" title="Riwayat Saya"><i class="ri-history-line"></i></div>
        <div style="margin-top:auto;">
            <div class="nav-icon" style="color:var(--danger);" onclick="auth.signOut()"><i class="ri-logout-box-line"></i></div>
        </div>
    </nav>

    <aside class="list-sidebar">
        <div class="list-header">
            <h2 class="list-title">Incident Queue</h2>
            <div class="filter-tabs">
                <div class="filter-tab active" id="tabAll" onclick="renderTickets('all')">All Open</div>
                <div class="filter-tab" id="tabMine" onclick="renderTickets('mine')">My Tickets</div>
                <div class="filter-tab" id="tabCrit" onclick="renderTickets('critical')" style="color:var(--danger);">Critical</div>
            </div>
        </div>
        <div class="ticket-scroller" id="ticketList">
        </div>
        <div style="padding:16px; border-top:1px solid var(--border-subtle); background:var(--bg-surface);">
            <div style="display:flex; align-items:center; gap:10px;">
                <div class="avatar-xs" style="width:32px; height:32px; font-size:14px; background:var(--primary); color:white;" id="myAvatar">T</div>
                <div>
                    <div style="font-weight:700; font-size:13px;" id="myName">Technician</div>
                    <div style="font-size:11px; color:var(--success);">● Online</div>
                </div>
            </div>
        </div>
    </aside>

    <main class="workspace">
        <div id="emptyState" class="empty-state">
            <i class="ri-customer-service-2-line" style="font-size:64px; color:#cbd5e1; margin-bottom:16px;"></i>
            <h3>Ready to work?</h3>
            <p>Pilih tiket dari antrian di sebelah kiri untuk mulai.</p>
        </div>

        <div id="activeTicket" class="hidden" style="display:flex; flex-direction:column; height:100%;">
            <div class="ws-header">
                <div class="ws-title">
                    <div style="display:flex; align-items:center; gap:12px;">
                        <span id="headId" style="font-family:var(--font-mono); background:var(--bg-body); padding:4px 8px; border-radius:6px; font-size:12px;">#ID</span>
                        <h2 id="headSubject">Subject Ticket</h2>
                    </div>
                    <div class="ws-meta">
                        <span id="headUser"><i class="ri-user-line"></i> User Name</span>
                        <span id="headDept"><i class="ri-building-line"></i> Department</span>
                        <span id="headTime"><i class="ri-time-line"></i> Time</span>
                    </div>
                </div>
                <button class="btn" style="background:white; color:var(--text-primary); border:1px solid var(--border-subtle);" onclick="alert('Fitur Remote Desktop akan segera hadir.')">
                    <i class="ri-remote-control-line"></i> Remote Access
                </button>
            </div>

            <div class="ws-body" id="chatArea">
            </div>

            <div class="ws-footer">
                <div class="input-tabs">
                    <div class="input-tab active" id="tabReply" onclick="setMode('reply')">Balas ke User (Public)</div>
                    <div class="input-tab" id="tabNote" onclick="setMode('note')"><i class="ri-lock-line"></i> Catatan Internal</div>
                </div>
                <textarea id="replyInput" placeholder="Tulis balasan solusi kepada user..."></textarea>
                
                <div class="action-bar">
                    <div style="display:flex; gap:12px; align-items:center;">
                        <select id="statusSelect" class="status-select">
                            <option value="Open">Status: Open</option>
                            <option value="Progress">Status: In Progress</option>
                            <option value="Closed">Status: Resolved (Closed)</option>
                        </select>
                        <select id="prioSelect" class="status-select">
                            <option value="Low">Priority: Low</option>
                            <option value="Normal">Priority: Normal</option>
                            <option value="Critical">Priority: Critical</option>
                        </select>
                    </div>
                    <button class="btn" onclick="submitResponse()">
                        Kirim Update <i class="ri-send-plane-fill"></i>
                    </button>
                </div>
            </div>
        </div>
    </main>
</div>

<script>
    dayjs.extend(window.dayjs_plugin_relativeTime);

    const firebaseConfig = {
        apiKey: "AIzaSyA9wgSalrlTcveIZi2i-WND86z1i9JYHKw",
        authDomain: "it-support-53eeb.firebaseapp.com",
        databaseURL: "https://it-support-53eeb-default-rtdb.firebaseio.com",
        projectId: "it-support-53eeb",
        storageBucket: "it-support-53eeb.firebasestorage.app",
        messagingSenderId: "573924501146",
        appId: "1:573924501146:web:12f34306ed675472322123"
    };
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const auth = firebase.auth();

    let currentUser = null;
    let activeTicketId = null;
    let reports = [];
    let isInternalMode = false;

    auth.onAuthStateChanged(user => {
        if (user) {
            db.ref('users/' + user.uid).once('value').then(snap => {
                const profile = snap.val();
                if (profile && (profile.role === 'Admin' || profile.role === 'Support' || profile.departemen === 'IT' || profile.status === 'approved')) {
                    currentUser = { uid: user.uid, ...profile };
                    initApp();
                } else {
                    alert("Akses ditolak. Akun tidak valid atau belum disetujui.");
                    auth.signOut();
                }
            });
        } else {
            document.getElementById('loginScreen').style.display = 'flex';
            document.getElementById('appLayout').classList.add('hidden');
        }
    });

    async function processLogin() {
        const inputId = document.getElementById('loginId').value.trim();
        const inputPass = document.getElementById('loginPass').value;
        const btn = document.getElementById('btnLogin');
        const err = document.getElementById('loginError');

        if (!inputId || !inputPass) {
            err.style.display = 'block'; err.textContent = "Mohon isi ID dan Password."; return;
        }

        btn.disabled = true; btn.innerHTML = '<i class="ri-loader-4-line ri-spin"></i> Verifikasi...';
        err.style.display = 'none';

        try {
            let targetEmail = inputId;

            if (!inputId.includes('@')) {
                const snapshot = await db.ref('users').once('value');
                const users = snapshot.val();
                let found = null;
                
                if (users) {
                    for (let key in users) {
                        if (users[key].nik == inputId) {
                            found = users[key];
                            break;
                        }
                    }
                }

                if (!found) throw new Error("NIK tidak ditemukan dalam database.");
                targetEmail = found.email;
            }

            await auth.signInWithEmailAndPassword(targetEmail, inputPass);

        } catch (e) {
            console.error(e);
            btn.disabled = false; btn.innerHTML = 'Masuk ke Workspace';
            err.style.display = 'block';
            err.textContent = e.message.includes('password') ? "Password salah." : e.message;
        }
    }

    function initApp() {
        document.getElementById('loginScreen').style.display = 'none';
        document.getElementById('appLayout').classList.remove('hidden');
        
        document.getElementById('myName').textContent = currentUser.nama || 'Technician';
        document.getElementById('myAvatar').textContent = (currentUser.nama || 'T').charAt(0);

        db.ref('reports').on('value', snap => {
            const data = snap.val();
            reports = data ? Object.keys(data).map(k => ({...data[k], id: k})) : [];
            reports.sort((a,b) => new Date(b.created_iso) - new Date(a.created_iso));
            
            const activeTab = document.querySelector('.filter-tab.active');
            const filterType = activeTab ? (activeTab.id === 'tabMine' ? 'mine' : (activeTab.id === 'tabCrit' ? 'critical' : 'all')) : 'all';
            
            renderTickets(filterType);
            
            if(activeTicketId) loadTicketDetail(reports.find(r => r.id === activeTicketId));
        });
    }

    function renderTickets(filter) {
        const listEl = document.getElementById('ticketList');
        listEl.innerHTML = '';
        
        document.querySelectorAll('.filter-tab').forEach(t => t.classList.remove('active'));
        if(filter === 'all') document.getElementById('tabAll').classList.add('active');
        if(filter === 'mine') document.getElementById('tabMine').classList.add('active');
        if(filter === 'critical') document.getElementById('tabCrit').classList.add('active');

        let filtered = reports.filter(r => !r.isDeleted && r.status !== 'Closed');

        if (filter === 'mine') filtered = filtered.filter(r => r.pic === currentUser.nama);
        if (filter === 'critical') filtered = filtered.filter(r => r.kategori === 'Critical');

        if (filtered.length === 0) {
            listEl.innerHTML = '<div style="text-align:center; padding:20px; color:#94a3b8; font-size:13px;">Tidak ada tiket ditemukan.</div>';
            return;
        }

        filtered.forEach(r => {
            const el = document.createElement('div');
            el.className = `ticket-card ${activeTicketId === r.id ? 'active' : ''}`;
            el.onclick = () => selectTicket(r.id);
            
            const timeAgo = dayjs(r.created_iso).fromNow(true);
            let badgeClass = r.status === 'Open' ? 'bg-open' : 'bg-progress';
            if (r.kategori === 'Critical') badgeClass = 'bg-critical';

            el.innerHTML = `
                <div class="t-meta">
                    <span style="font-family:var(--font-mono); font-weight:700;">${r.id}</span>
                    <span>${timeAgo}</span>
                </div>
                <div class="t-subject">${r.jenis}</div>
                <div class="t-user">
                    <div class="avatar-xs">${r.nama.charAt(0)}</div> ${r.nama}
                </div>
                <div style="margin-top:8px;">
                    <span class="badge ${badgeClass}">${r.status}</span>
                    ${r.kategori === 'Critical' ? '<span class="badge bg-critical">CRITICAL</span>' : ''}
                </div>
            `;
            listEl.appendChild(el);
        });
    }

    function selectTicket(id) {
        activeTicketId = id;
        
        const activeTab = document.querySelector('.filter-tab.active');
        const filterType = activeTab ? (activeTab.id === 'tabMine' ? 'mine' : (activeTab.id === 'tabCrit' ? 'critical' : 'all')) : 'all';
        renderTickets(filterType);

        const r = reports.find(r => r.id === id);
        
        document.getElementById('emptyState').classList.add('hidden');
        document.getElementById('activeTicket').classList.remove('hidden');
        
        loadTicketDetail(r);
    }

    function loadTicketDetail(r) {
        if(!r) return;
        
        document.getElementById('headId').textContent = r.id;
        document.getElementById('headSubject').textContent = r.jenis;
        document.getElementById('headUser').innerHTML = `<i class="ri-user-line"></i> ${r.nama}`;
        document.getElementById('headDept').innerHTML = `<i class="ri-building-line"></i> ${r.departemen || 'General'}`;
        document.getElementById('headTime').innerHTML = `<i class="ri-time-line"></i> ${dayjs(r.created_iso).format('DD MMM, HH:mm')}`;

        document.getElementById('statusSelect').value = r.status;
        document.getElementById('prioSelect').value = r.kategori;

        const chat = document.getElementById('chatArea');
        chat.innerHTML = '';

        chat.innerHTML += `
            <div class="chat-bubble chat-user">
                <div class="chat-info"><span>${r.nama}</span> <span>${dayjs(r.created_iso).format('HH:mm')}</span></div>
                <div class="chat-text">
                    <strong>${r.jenis}</strong><br>
                    ${r.catatan || 'Tidak ada deskripsi detail.'}
                </div>
            </div>
        `;

        if (r.note_internal) {
            const notes = r.note_internal.split('\n').filter(n => n.trim());
            notes.forEach(n => {
                chat.innerHTML += `<div class="chat-note"><strong><i class="ri-lock-line"></i> Log:</strong> ${n}</div>`;
            });
        }

        if (r.status === 'Progress') {
             chat.innerHTML += `
                <div class="chat-bubble chat-tech">
                    <div class="chat-info"><span>${r.pic || 'System'}</span> <span>Updated</span></div>
                    <div class="chat-text">Status tiket diperbarui menjadi <strong>In Progress</strong>. Sedang dalam penanganan.</div>
                </div>
             `;
        }
        
        chat.scrollTop = chat.scrollHeight;
    }

    window.setMode = (mode) => {
        isInternalMode = (mode === 'note');
        const box = document.getElementById('replyInput');
        
        if (isInternalMode) {
            document.getElementById('tabReply').classList.remove('active');
            document.getElementById('tabNote').classList.add('active');
            box.style.background = '#fffbeb';
            box.placeholder = "Tulis catatan rahasia untuk tim IT (User tidak akan melihat ini)...";
        } else {
            document.getElementById('tabReply').classList.add('active');
            document.getElementById('tabNote').classList.remove('active');
            box.style.background = 'white';
            box.placeholder = "Tulis balasan solusi kepada user...";
        }
    }

    window.submitResponse = () => {
        const text = document.getElementById('replyInput').value;
        const status = document.getElementById('statusSelect').value;
        const prio = document.getElementById('prioSelect').value;
        const r = reports.find(x => x.id === activeTicketId);

        let updates = {
            status: status,
            kategori: prio,
            pic: currentUser.nama
        };

        if (text) {
            if (isInternalMode) {
                const oldNote = r.note_internal || "";
                const stamp = dayjs().format('DD/MM HH:mm');
                updates.note_internal = oldNote + `\n[${stamp} ${currentUser.nama}]: ${text}`;
            } else {
                alert(`Balasan terkirim ke ${r.nama}: "${text}"`);
            }
        }

        db.ref('reports/' + activeTicketId).update(updates);
        document.getElementById('replyInput').value = '';
    };

</script>
</body>
</html>
