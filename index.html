<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Zeppelin â€” ADMIN DASHBOARD</title>
<link rel="icon" type="image/png" href="icov2.png" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.0/jspdf.plugin.autotable.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-analytics.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');
  :root{
    --bg: #f4f7fa; --card: #ffffff; --muted:#6c757d; --text:#212529; --primary:#007bff;
    --primary-hover:#0069d9; --accent:#58a6ff; --success:#16a34a; --warning: #f59e0b;
    --danger:#dc3545; --radius: 10px; --border-color: #e9ecef; --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
    --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.07), 0 2px 4px -2px rgba(0, 0, 0, 0.07);
  }
  [data-theme="dark"]{
    --bg:#0f172a; --card:#1e293b; --muted:#94a3b8; --text:#f1f5f9; --primary:#3b82f6;
    --primary-hover:#2563eb; --border-color: #334155; --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.1);
    --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
  }
  *{box-sizing:border-box}
  body{
    margin:0; font-family:'Inter', system-ui, Roboto, Arial, sans-serif; background:var(--bg);
    color:var(--text); padding:24px; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale;
  }
  .app{max-width:1400px;margin:0 auto}
  header.app-header{
    display:flex; align-items:center; gap:16px; margin-bottom:24px; padding-bottom: 20px;
    border-bottom: 1px solid var(--border-color); flex-wrap: wrap; /* (RESPONSIVE) */
  }
  .logo{
    width:48px; height:48px; border-radius:var(--radius);
    background:linear-gradient(135deg, var(--primary), var(--accent));
    display:flex; align-items:center; justify-content:center; color:#fff;
    font-weight:800; font-size:18px;
  }
  .title .name{font-size:22px;font-weight:800}
  .title .tag{font-size:13px;color:var(--muted);font-weight:500;}
  .controls{margin-left:auto;display:flex;gap:10px;align-items:center; flex-wrap: wrap;} /* (RESPONSIVE) */
  .btn{
    background:var(--primary); color:#fff; border:none; padding:9px 14px; border-radius:8px;
    cursor:pointer; font-weight:600; display:inline-flex; align-items:center; gap:6px;
    font-size:14px; transition: background-color 0.2s ease; text-decoration: none; line-height: 1;
  }
  .btn:hover{ background: var(--primary-hover); }
  .btn.ghost{ background:transparent; border:1px solid var(--border-color); color:var(--text); font-weight: 500; }
  .btn.ghost:hover{ background: var(--border-color); }
  .btn:not(.ghost){ box-shadow: var(--shadow-sm); }
  .btn svg{width:16px;height:16px;stroke-width:2.5}
  .card{
    background:var(--card); padding: 20px 24px; border-radius:var(--radius);
    box-shadow:var(--shadow-sm); border:1px solid var(--border-color);
  }
  h3 { font-size: 18px; font-weight: 700; margin-top: 0; margin-bottom: 16px; }
  .grid{ display:grid; grid-template-columns:1fr; gap:20px; margin-bottom: 20px; }
  .row { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 16px; }
  .summary-card {
    padding: 16px !important; border: 1px solid var(--border-color) !important;
    border-radius: var(--radius) !important; box-shadow: none !important;
    transition: all 0.2s ease; cursor: pointer;
  }
  .summary-card:hover { transform: translateY(-2px); box-shadow: var(--shadow-md) !important; }
  .summary-card .small { font-weight: 600; }
  .summary-card div[style*="font-weight:800"] {
    font-size: 24px !important; font-weight: 800 !important;
    color: var(--primary); margin-top: 8px;
  }
  .small{font-size:13px;color:var(--muted);font-weight:500;}
  .filter-bar{display:flex;gap:10px;align-items:center;margin-bottom:10px; flex-wrap: wrap;} /* (RESPONSIVE) */
  .filter-bar input, .filter-bar select{
    padding:9px 12px; border-radius:8px; border:1px solid var(--border-color);
    background:var(--card); color: var(--text); font-size:14px; font-family: 'Inter', sans-serif;
  }
  .filter-bar input::placeholder { color: var(--muted); }
  .filter-bar #exportCsv { background: transparent; color: var(--text); font-weight: 500; }
  .table-wrap{overflow:auto} /* Ini adalah cara terbaik untuk tabel admin yang lebar */
  table{width:100%;border-collapse:collapse;min-width:900px}
  th,td{padding:12px 14px;text-align:left;border-bottom:1px solid var(--border-color);vertical-align: middle;}
  th{
    background:var(--bg); color:var(--muted); font-size:12px; font-weight: 600;
    text-transform: uppercase; letter-spacing: 0.5px; position:relative; user-select:none;
  }
  th.sortable{cursor:pointer}
  th.sortable:hover { color: var(--text); }
  th .sort-ind{font-size:11px;margin-left:6px;opacity:0.8}
  tr:hover td{background:rgba(0, 123, 255, 0.02)}
  .status, .cat-badge {
    display:inline-block; padding: 4px 12px; border-radius:999px;
    font-weight:600; font-size:12px; line-height: 1.5;
  }
  .s-open{background:#fffbeb;color:#b45309}
  .s-progress{background:#e0f2fe;color:#0284c7}
  .s-closed{background:#dcfce7;color:#16a34a}
  .cat-low{background:#e0f2fe;color:#0284c7}
  .cat-normal{background:#fffbeb;color:#d97706}
  .cat-critical{background:#fee2e2;color:#dc2626}
  .pagination{display:flex;gap:6px;justify-content:flex-end;margin-top:16px; flex-wrap: wrap;} /* (RESPONSIVE) */
  .pagination button{
    padding:6px 12px; border-radius:6px; border:1px solid var(--border-color);
    background:var(--card); color: var(--text); font-weight: 500; cursor:pointer;
  }
  .pagination button:hover { background: var(--bg); }
  .pagination button.active{
    background:var(--primary); color:#fff; border-color:var(--primary); font-weight: 600;
  }
  .modal-backdrop{
    position:fixed; inset:0; background:rgba(0,0,0,0.6); display:none;
    align-items:center; justify-content:center; z-index:9999; padding: 16px; /* (RESPONSIVE) */
  }
  .modal{ 
    width:720px; max-width: 100%; /* (RESPONSIVE) */
    background:var(--card); padding: 24px; border-radius:12px; 
    box-shadow:0 12px 40px rgba(0,0,0,0.35); 
  }
  .form-row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  input,select,textarea{
    width:100%; padding:10px 12px; border-radius:8px; border:1px solid var(--border-color);
    background:var(--bg); color: var(--text); font-size:14px; font-family:'Inter', system-ui, Roboto, Arial;
  }
  input:focus, select:focus, textarea:focus {
    outline: none; border-color: var(--primary); box-shadow: 0 0 0 2px rgba(0,123,255,0.2);
  }
  textarea{min-height:120px;resize: vertical;}
  .flex{display:flex;gap:8px;align-items:center}
  footer.small{ margin-top:32px; text-align:center; color:var(--muted); font-size:13px; }
  
  /* (MODIFIKASI) Popup
     Sekarang menargetkan semua popup, termasuk popup user management
  */
  #logPopup, #globalLogPopup, #summaryPopup, #userManagementPopup {
    display: none; position: fixed; inset: 0; background: rgba(0, 0, 0, 0.6);
    z-index: 6000; align-items: center; justify-content: center; padding: 16px; /* (RESPONSIVE) */
  }
  #logPopup > div, #globalLogPopup > div, #summaryPopup > div, #userManagementPopup > div {
    background: var(--card); color: var(--text); padding: 24px; border-radius: 12px;
    width: 900px; /* (DIUBAH) Sedikit lebih lebar */
    max-width: 100%; /* (RESPONSIVE) */
    max-height: 85%; overflow: auto;
    box-shadow: 0 12px 40px rgba(0, 0, 0, 0.35); display: flex; flex-direction: column;
  }
  #globalLogContent, #logContent, #summaryContent, #userManagementContent {
    font-size: 14px; margin-top: 10px; line-height: 1.7;
    flex-grow: 1; overflow-y: auto; background: var(--bg); padding: 12px; border-radius: 8px;
  }
  /* (BARU) Pastikan tabel di dalam popup responsif */
  #userManagementContent table {
      min-width: 600px;
  }
  #userManagementContent .actions {
      display: flex; gap: 4px; flex-wrap: wrap;
  }
  #summaryContent table { font-size: 13px; }
  #logControlPanel, #userManagementControlPanel {
    display: flex; gap: 10px; align-items: center; margin-bottom: 16px;
    padding-bottom: 16px; border-bottom: 1px solid var(--border-color);
    flex-wrap: wrap; /* (RESPONSIVE) */
  }
  /* (ADMIN) STYLE LOGIN */
  #loginScreen {
    position: fixed; inset: 0; background: var(--bg); z-index: 10000;
    display: flex; align-items: center; justify-content: center; padding: 16px; /* (RESPONSIVE) */
  }
  #loginBox {
    width: 400px; max-width: 100%; /* (RESPONSIVE) */
    background: var(--card); padding: 28px;
    border-radius: var(--radius); border: 1px solid var(--border-color);
    box-shadow: var(--shadow-md);
  }
  #loginBox h3 { text-align: center; }
  #loginBox form div { margin-top: 10px; }
  #loginBox input { padding: 12px; }
  #loginBox button { width: 100%; justify-content: center; padding: 12px; margin-top: 16px; }
  #authError { color: var(--danger); font-size: 13px; text-align: center; margin-top: 10px; display: none; }
  .app-content { display: none; }
  
  /* (DIUBAH) Media Query yang ada disempurnakan */
  @media (max-width: 900px) {
    body { padding: 16px; }
    .app { padding: 0; }
    .modal { width: 95%; }
    .form-row { grid-template-columns: 1fr; } /* Modal form tumpuk */
    
    .controls { 
        justify-content: flex-start; /* (DIUBAH) */
        gap: 8px;
    }
    .filter-bar { 
        flex-direction: column; 
        align-items: stretch; /* (DIUBAH) */
        width: 100%; /* (BARU) */
    }
    .filter-bar input, .filter-bar select {
        width: 100%; /* (BARU) */
    }
    /* (BARU) Ringkasan jadi 2 kolom */
    .row {
        grid-template-columns: 1fr 1fr;
    }
    /* (BARU) Popup jadi lebih sempit */
    #logPopup > div, #globalLogPopup > div, #summaryPopup > div, #userManagementPopup > div {
        width: 95%;
    }
  }
  
  @media (max-width: 600px) {
    /* (BARU) Ringkasan jadi 1 kolom */
    .row {
        grid-template-columns: 1fr;
    }
    .controls {
        /* Kosongkan agar bisa ditimpa */
    }
    /* (BARU) Tata ulang header admin di mobile */
    .app-header { position: relative; }
    .controls {
        margin-left: 0;
        width: 100%;
        gap: 6px;
        justify-content: flex-start;
        flex-wrap: wrap; /* (BARU) Izinkan wrap */
    }
    .controls #userInfo { display: none; } /* Sembunyikan info user */
    .controls #logoutBtn {
        position: absolute;
        top: 20px;
        right: 0;
    }
    /* (BARU) Tombol header jadi lebih rapi di mobile */
    .controls #backupBtn, .controls #restoreBtn, .controls #showGlobalLog, .controls #showUserManagement {
        padding: 8px 10px;
        flex-grow: 1; /* (BARU) Tombol jadi rata */
    }
    .controls #newReportBtn {
        width: 100%;
        justify-content: center;
        margin-top: 8px;
    }
  }
</style>
</head>
<body data-theme="light">

<svg width="0" height="0" style="position:absolute">
  <defs>
    <svg id="icon-download" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
    <svg id="icon-upload" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>
    <svg id="icon-plus" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
    <svg id="icon-log" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"></path><rect x="8" y="2" width="8" height="4" rx="1" ry="1"></rect></svg>
    <svg id="icon-users" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>
  </defs>
</svg>

<div id="loginScreen">
  <div id="loginBox">
    <form id="loginForm" onsubmit="return false;">
      <h3>Admin Login (root)</h3>
      <div><label class="small">Username</label><input id="loginUser" type="text" required placeholder="root"></div>
      <div><label class="small">Password</label><input id="loginPass" type="password" required placeholder="adm123"></div>
      <button id="loginBtn" class="btn">Login</button>
    </form>
    <div id="authError"></div>
  </div>
</div>

<div class="app app-content">
  <header class="app-header">
    <div class="logo">ZP</div>
    <div class="title"><div class="name">Zeppelin</div><div class="tag">ADMIN DASHBOARD</div></div>
    <div class="controls">
      <div id="dateTime" class="small"></div>
      <div id="userInfo" class="small" style="text-align: right;">
        Logged in as:<br>
        <strong id="userEmailDisplay"></strong>
      </div>
      <button id="logoutBtn" class="btn ghost" title="Logout">Logout</button>
      <button id="backupBtn" class="btn ghost" title="Backup Data">
        <svg><use href="#icon-download" /></svg>
      </button>
      <input id="restoreFile" type="file" accept=".json" style="display:none" />
      <button id="restoreBtn" class="btn ghost" title="Restore Data">
        <svg><use href="#icon-upload" /></svg>
      </button>
      <button id="showGlobalLog" class="btn ghost" title="Lihat Log Aktivitas">
         <svg><use href="#icon-log" /></svg>
      </button>
      <button id="showUserManagement" class="btn ghost" title="Manajemen User">
         <svg><use href="#icon-users" /></svg>
      </button>
      <button id="newReportBtn" class="btn">
        <svg><use href="#icon-plus" /></svg>
        Buat Laporan
      </button>
    </div>
  </header>

  <main id="mainContent">
    <div class="grid">
      <div class="card">
        <h3>Ringkasan Cepat</h3>
        <div class="row" style="margin-top:12px">
          <div class="card summary-card" style="padding:10px;border-radius:10px;flex:1"><div class="small">Total</div><div id="totalCount" style="font-weight:800;font-size:18px">0</div></div>
          <div class="card summary-card" style="padding:10px;border-radius:10px;flex:1"><div class="small">Open</div><div id="openCount" style="font-weight:800;font-size:18px">0</div></div>
          <div class="card summary-card" style="padding:10px;border-radius:10px;flex:1"><div class="small">Progress</div><div id="progressCount" style="font-weight:800;font-size:18px">0</div></div>
          <div class="card summary-card" style="padding:10px;border-radius:10px;flex:1"><div class="small">Closed</div><div id="closedCount" style="font-weight:800;font-size:18px">0</div></div>
        </div>
        <div style="margin-top:12px"><div class="small">Distribusi Kategori</div><div id="categorySummary" style="display:flex;gap:8px;margin-top:8px;flex-wrap:wrap;"></div></div>
      </div>
    </div>
    <div class="card" style="margin-top:18px">
      <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:10px;">
        <h3 class="section-title" style="margin:0;">Daftar Laporan (Semua User)</h3>
        <div class="filter-bar" style="margin-bottom:0;">
          <input id="searchInput" placeholder="Cari ID, nama, jenis, PICâ€¦" style="min-width:250px;" />
          <select id="filterKategori"><option value="">Semua Kategori</option><option value="Low">Low</option><option value="Normal">Normal</option><option value="Critical">Critical</option></select>
          <select id="filterWaktu"><option value="">Semua Waktu</option><option value="today">Hari Ini</option><option value="week">Minggu Ini</option><option value="month">Bulan Ini</option></select>
          <button id="exportCsv" class="btn ghost">ðŸ“¤ Export</button>
        </div>
      </div>
      <div class="table-wrap" style="margin-top:12px;">
        <table id="reportTable" aria-describedby="Daftar laporan">
          <thead>
            <tr>
              <th class="sortable" data-key="id">ID<span class="sort-ind"></span></th>
              <th class="sortable" data-key="pic">PIC<span class="sort-ind"></span></th>
              <th class="sortable" data-key="nama">Nama<span class="sort-ind"></span></th>
              <th class="sortable" data-key="jenis">Jenis<span class="sort-ind"></span></th>
              <th class="sortable" data-key="kategori">Kategori<span class="sort-ind"></span></th>
              <th class="sortable" data-key="status">Status<span class="sort-ind"></span></th>
              <th class="sortable" data-key="created_iso">Dibuat<span class="sort-ind"></span></th>
              <th class="sortable" data-key="updated_iso">Diperbarui<span class="sort-ind"></span></th>
              <th class="sortable" data-key="durationText">Durasi<span class="sort-ind"></span></th>
              <th>Actions</th>
              <th>Catatan</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <div class="pagination" id="pagination"></div>
    </div>
    <div id="chartsArea" style="margin-top:18px;"></div>
  </main>
  <footer class="small">Zeppelin IT Support (Admin) â€” <span id="footerDate"></span></footer>
</div>

<div class="modal-backdrop" id="modalBackdrop">
  <div class="modal" role="dialog" aria-modal="true">
    <h3 id="modalTitle">Edit Laporan</h3>
    <form id="modalForm" onsubmit="return false;">
      <div class="form-row">
        <div><label class="small">PIC</label><input id="m_pic" required placeholder="PIC penindaklanjut"></div>
        <div><label class="small">Nama User</label><input id="m_nama" required placeholder="Nama pemohon" readonly></div> <div><label class="small">Jenis Masalah</label>
          <select id="m_jenis" required><option value="">Pilihâ€¦</option><option>Jaringan</option><option>Hardware</option><option>Software</option><option>Login / Akun</option><option>Lainnya</option></select>
        </div>
        <div><label class="small">Kategori</label>
          <select id="m_kategori" required><option value="">Pilihâ€¦</option><option value="Low">Low</option><option value="Normal">Normal</option><option value="Critical">Critical</option></select>
        </div>
      </div>
      <div style="margin-top:10px"><label class="small">Catatan / Detail</label><textarea id="m_catatan" placeholder="Deskripsi singkat"></textarea></div>
      <div style="margin-top:10px">
        <label class="small">Status</label>
        <select id="m_status" required>
          <option value="Open">Open</option>
          <option value="Progress">Progress</option>
          <option value="Closed">Closed</option>
        </select>
        <div class="small" style="margin-top:4px;">Jika memilih <strong>Closed</strong>, waktu selesai akan otomatis dicatat.</div>
      </div>
      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
        <button id="modalSave" class="btn">Simpan</button>
        <button id="modalCancel" type="button" class="btn ghost">Batal</button>
      </div>
    </form>
  </div>
</div>
<div id="logPopup">
  <div>
    <h3>Riwayat Perubahan</h3>
    <div id="logContent"></div>
    <div style="display:flex;gap:8px;margin-top:12px;justify-content:flex-end;">
      <button id="closeLogPopup" class="btn">Tutup</button>
    </div>
  </div>
</div>
<div id="globalLogPopup">
  <div>
    <h3>ðŸ“œ Log Aktivitas Keseluruhan</h3>
    <div id="logControlPanel">
      <select id="logFilterPeriod" style="padding:6px 8px;border-radius:8px;border:1px solid rgba(0,0,0,0.1);">
        <option value="">Semua</option><option value="today">Hari Ini</option><option value="week">Minggu Ini</option><option value="month">Bulan Ini</option>
      </select>
      <button id="downloadLogPDF" class="btn ghost">ðŸ“„ Download PDF</button>
      <span id="logCountInfo" style="margin-left:auto;font-size:13px;color:gray;"></span>
    </div>
    <div id="globalLogContent"></div>
    <div style="display:flex;gap:8px;margin-top:12px;justify-content:flex-end;">
      <button id="closeGlobalLog" class="btn">Tutup</button>
    </div>
  </div>
</div>
<div id="summaryPopup">
  <div>
    <h3 id="summaryTitle">Rincian</h3>
    <div id="summaryContent"></div>
    <div style="display:flex;gap:8px;margin-top:12px;justify-content:flex-end;">
      <button id="exportSummaryBtn" class="btn ghost">Export Excel</button>
      <button id="closeSummaryBtn" class="btn">Tutup</button>
    </div>
  </div>
</div>

<div id="userManagementPopup">
  <div>
    <h3>ðŸ‘¥ Manajemen User</h3>
    <div id="userManagementControlPanel">
      <label class="small" for="userFilterStatus">Filter Status:</label>
      <select id="userFilterStatus" style="padding:6px 8px;border-radius:8px;border:1px solid var(--border-color); background: var(--bg); color: var(--text);">
        <option value="">Semua</option>
        <option value="pending" selected>Pending</option>
        <option value="approved">Approved</option>
        <option value="rejected">Rejected</option>
      </select>
      <span id="userCountInfo" style="margin-left:auto;font-size:13px;color:var(--muted);"></span>
    </div>
    <div id="userManagementContent">
      </div>
    <div style="display:flex;gap:8px;margin-top:12px;justify-content:flex-end;">
      <button id="closeUserManagement" class="btn">Tutup</button>
    </div>
  </div>
</div>


<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// ===================================================================
// === (ADMIN) KONFIGURASI ===
// ===================================================================
const ADMIN_UID = "Ogy9lUbGHbSu8wYIYx2gQsTtFDF2";
const ADMIN_EMAIL = "root@zeppelin.center";
// ===================================================================

// === KONFIGURASI FIREBASE ===
const firebaseConfig = {
Â  apiKey: "AIzaSyA9wgSalrlTcveIZi2i-WND86z1i9JYHKw",
Â  authDomain: "it-support-53eeb.firebaseapp.com",
Â  databaseURL: "https://it-support-53eeb-default-rtdb.firebaseio.com",
Â  projectId: "it-support-53eeb",
Â  storageBucket: "it-support-53eeb.firebasestorage.app",
Â  messagingSenderId: "573924501146",
Â  appId: "1:573924501146:web:12f34306ed675472322123",
// (FIX 2) Error 'Unexpected token -' diperbaiki. 'measurementId:' ditambahkan kembali
"measurementId": "G-33K6DDE1VR"
};

firebase.initializeApp(firebaseConfig);
const analytics = firebase.analytics();
const db = firebase.database();
const auth = firebase.auth();
const reportsRef = db.ref('reports'); 
const counterRef = db.ref('counter'); 
const usersRef = db.ref('users'); /* (PENTING) Referensi ke data user */

/* Cache & State */
let allReportsCache = []; 
let allUsersCache = []; /* (BARU) Cache untuk data user */
let currentUser = null; 
let dbListenerActive = false; 

/* Utilities */
function nowString(){ return new Date().toLocaleString('id-ID', { dateStyle: 'short', timeStyle: 'medium' }); }
function isoNow(){ return new Date().toISOString(); }
function msToDuration(ms){ if(ms==null) return '-'; const s=Math.floor(ms/1000); const d=Math.floor(s/86400); const h=Math.floor((s%86400)/3600); const m=Math.floor((s%3600)/60); let p=[]; if(d) p.push(d+'d'); if(h) p.push(h+'h'); if(m||(!d&&!h)) p.push(m+'m'); return p.join(' '); }

function getReports(){ return allReportsCache; }

/* Render Dashboard (Full) */
function renderDashboard(){
  const all = getReports(); 
  document.getElementById('totalCount').textContent = all.length;
  const byStatus = {Open:0,Progress:0,Closed:0};
  const byCat = {Low:0,Normal:0,Critical:0};
  all.forEach(r=>{ 
    byStatus[r.status] = (byStatus[r.status]||0)+1; 
    byCat[r.kategori || 'Normal'] = (byCat[r.kategori || 'Normal']||0)+1; 
  });
  document.getElementById('openCount').textContent = byStatus.Open || 0;
  document.getElementById('progressCount').textContent = byStatus.Progress || 0;
  document.getElementById('closedCount').textContent = byStatus.Closed || 0;
  const cs = document.getElementById('categorySummary'); cs.innerHTML='';
  ['Low','Normal','Critical'].forEach(k=>{
    const count = byCat[k] || 0;
    const el = document.createElement('div');
    el.className = 'card summary-card';
    el.style.minWidth = '80px'; el.style.padding = '8px 12px';
    const idKey = k.toLowerCase() + 'Count';
    el.innerHTML = `<div class="small">${k}</div><div id="${idKey}" style="font-weight:800">${count}</div>`;
    cs.appendChild(el);
  });
  try { enableSummaryClicksNow(); } catch(e) {}
}

/* Sorting */
let currentSort = { key: 'created_iso', asc: false };
try{ const s = JSON.parse(sessionStorage.getItem('zeppelin_currentSort')||'null'); if(s) currentSort = s; }catch(e){}

/* Data Pipeline (Full) */
function getFilteredSortedData(){
  const data = getReports().slice(); 
  const search = (document.getElementById('searchInput').value||'').toLowerCase();
  const filterCat = document.getElementById('filterKategori').value;
  const period = document.getElementById('filterWaktu').value;
  const now = new Date();
  let start = null;
  if(period==='today'){ start = new Date(now); start.setHours(0,0,0,0); }
  else if(period==='week'){ start = new Date(now); start.setDate(now.getDate()-7); start.setHours(0,0,0,0); }
  else if(period==='month'){ start = new Date(now); start.setMonth(now.getMonth()-1); start.setHours(0,0,0,0); }
  const filtered = data.filter(d=>{
    const text = ((d.id||'')+' '+(d.nama||'')+' '+(d.jenis||'')+' '+(d.pic||'')+' '+(d.kategori||'')+' '+(d.status||'')+' '+(d.catatan||'')).toLowerCase();
    const matchSearch = !search || text.includes(search);
    const matchCat = !filterCat || d.kategori===filterCat;
    const createdDate = new Date(d.created_iso || d.created);
    const matchTime = !start || (createdDate >= start && createdDate <= now);
    return matchSearch && matchCat && matchTime;
  });
  // sorting
  if(currentSort && currentSort.key){
    const key = currentSort.key; const asc = !!currentSort.asc;
    filtered.sort((a,b)=>{
      let va = a[key]; let vb = b[key];
      if (key === 'created_iso' || key === 'updated_iso') { va = a[key] || 0; vb = b[key] || 0; } 
      else if (key === 'durationText') { va = a['durationMs'] || 0; vb = b['durationMs'] || 0; } 
      else if (key === 'id') { va = parseInt(String(va).split('-')[1] || 0); vb = parseInt(String(vb).split('-')[1] || 0); }
      if (va == null) va = ''; if (vb == null) vb = '';
      if (typeof va === 'number' && typeof vb === 'number') { return asc ? va - vb : vb - va; }
      return asc ? String(va).localeCompare(String(vb), undefined, {numeric: true}) : String(vb).localeCompare(String(va), undefined, {numeric: true});
    });
  } else {
    filtered.sort((a,b)=> new Date(b.created_iso||b.created) - new Date(a.created_iso||a.created));
  }
  return filtered;
}

/* (DIUBAH) Render Table (Menambahkan ikon Urgent) */
let currentPage = 1;
function renderTable(page = 1){
  currentPage = page;
  const perPage = 10;
  const tbody = document.querySelector('#reportTable tbody');
  const filtered = getFilteredSortedData();
  const totalPages = Math.max(1, Math.ceil(filtered.length / perPage));
  if(page > totalPages) page = totalPages;
  const pageData = filtered.slice((page-1)*perPage, page*perPage);
  
  tbody.innerHTML = pageData.map(r=>{
    const statusClass = r.status==='Open'?'s-open':(r.status==='Progress'?'s-progress':'s-closed');
    const created = r.created || '-';
    const updated = r.updated || '-';
    const dur = r.durationText || '-';
    const catClass = (r.kategori || 'normal').toLowerCase(); // default 'normal' jika kosong
    const cat = r.kategori ? `<span class="cat-badge cat-${catClass}">${r.kategori}</span>` : '...';

    // (BARU) Tambahkan ikon urgent jika r.urgent == true
    const idText = r.urgent ? `ðŸ”¥ ${r.id}` : r.id;

    const action_buttons = `
        <button class="btn ghost" onclick="openModal('${r.id}')" style="padding: 4px 8px; font-size:12px;">Edit</button>
        <button class="btn ghost" onclick="deleteReport('${r.id}')" style="padding: 4px 8px; font-size:12px;">Hapus</button>
        <button class="btn ghost" onclick="showLog('${r.id}')" style="padding: 4px 8px; font-size:12px;">Log</button>
      `;

    return `<tr>
      <td>${idText}</td> <td>${r.pic || '...'}</td>
      <td>${r.nama}</td>
      <td>${r.jenis}</td>
      <td>${cat}</td>
      <td><span class="status ${statusClass}">${r.status}</span></td>
      <td>${created}</td>
      <td>${updated}</td>
      <td>${dur}</td>
      <td class="actions">${action_buttons}</td>
      <td>${(r.catatan||'').substring(0, 50)}${ (r.catatan||'').length > 50 ? '...' : ''}</td>
    </tr>`;
  }).join('');

  const pg = document.getElementById('pagination'); pg.innerHTML = '';
  for(let i=1;i<=totalPages;i++){
    const b = document.createElement('button'); b.textContent = i;
    if(i===page) b.classList.add('active');
    b.onclick = ()=> renderTable(i);
    pg.appendChild(b);
  }
  renderDashboard();
  updateSortIndicators();
}

/* Sorting UI */
function updateSortIndicators(){
  document.querySelectorAll('#reportTable th.sortable').forEach(th=>{
    const key = th.getAttribute('data-key');
    const ind = th.querySelector('.sort-ind');
    ind.textContent = '';
    if(currentSort.key === key){ ind.textContent = currentSort.asc ? 'â–²' : 'â–¼'; }
  });
}
function enableTableSorting(){
  document.querySelectorAll('#reportTable th.sortable').forEach((th)=>{
    th.addEventListener('click', ()=>{
      const key = th.getAttribute('data-key');
      if(currentSort.key === key) currentSort.asc = !currentSort.asc;
      else { currentSort.key = key; currentSort.asc = true; }
      try{ sessionStorage.setItem('zeppelin_currentSort', JSON.stringify(currentSort)); }catch(e){}
      renderTable(1);
    });
  });
}

/* (ADMIN) CRUD */
async function deleteReport(id){ 
  if(!confirm(`Yakin ingin menghapus laporan ${id}?`)) return;
  try {
    await reportsRef.child(id).remove(); 
    showToast('Laporan dihapus ðŸ—‘ï¸');
  } catch (err) {
    console.error("Gagal hapus:", err);
    alert("Gagal menghapus data: " + err.message);
  }
}

// (DIUBAH) showToast sekarang bisa menerima tipe (success, danger, warning)
function showToast(txt, t = 3000, type = 'success') {
    const el = document.createElement('div');
    el.className = 'card';
    el.style.position = 'fixed';
    el.style.right = '18px';
    el.style.bottom = '18px';
    el.style.padding = '12px 16px';
    el.style.zIndex = 99999;
    
    if (type === 'danger') {
        el.style.background = 'var(--danger)';
    } else if (type === 'warning') {
        el.style.background = 'var(--warning)';
    } else {
        el.style.background = 'var(--primary)'; // Default
    }
    
    el.style.color = '#fff';
    el.textContent = txt;
    el.style.fontWeight = '600';
    document.body.appendChild(el);
    setTimeout(() => el.remove(), t);
}


/* Generate ID */
async function generateId() {
  try {
    const result = await counterRef.transaction((currentValue) => (currentValue || 0) + 1);
    if (result.committed) {
      const nextId = result.snapshot.val();
      return 'ZP-' + String(nextId).padStart(4, '0');
    } else { throw new Error('Gagal mendapatkan ID baru (transaksi dibatalkan).'); }
  } catch (error) {
    console.error("Gagal generate ID:", error);
    alert("Error: Tidak bisa mendapatkan ID baru dari server. Coba lagi.");
    return null;
  }
}

/* Export to Excel */
function exportToExcel(){
  const data = getFilteredSortedData();
  if(!data.length){ alert('Tidak ada data untuk diekspor.'); return; }
  const rows = data.map(r=>({
    ID:r.id, PIC:r.pic, Nama:r.nama, JenisMasalah:r.jenis, Kategori:r.kategori||'-',
    Catatan:r.catatan||'-', Status:r.status, Dibuat:r.created||'-', Diperbarui:r.updated||'-',
    Durasi:r.durationText||'-', Urgent: r.urgent ? 'YA' : 'TIDAK' // (BARU) Tambah kolom urgent
  }));
  const ws = XLSX.utils.json_to_sheet(rows);
  const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, 'Laporan');
  XLSX.writeFile(wb, `Laporan_Zeppelin_${new Date().toISOString().slice(0,10)}.xlsx`);
  showToast('Export selesai âœ…');
}

/* (ADMIN) Init */
(function init(){
  const backupBtn = document.getElementById('backupBtn');
  const restoreBtn = document.getElementById('restoreBtn');
  const restoreFile = document.getElementById('restoreFile');
  const dateTimeEl = document.getElementById('dateTime');
  const footerDate = document.getElementById('footerDate');
  footerDate.textContent = new Date().toLocaleDateString('id-ID', { year: 'numeric' });
  function updateTime(){ dateTimeEl.textContent = new Date().toLocaleString('id-ID', { weekday: 'long', day: 'numeric', month: 'short', hour: '2-digit', minute: '2-digit' }); }
  setInterval(updateTime,1000); updateTime();

  /* Backup */
  backupBtn.addEventListener('click', async ()=>{ 
    showToast('Mengambil data backup...');
    try {
      const snapshot = await reportsRef.once('value');
      const dataObj = snapshot.val();
      const dataArray = dataObj ? Object.values(dataObj) : []; 
      const dataString = JSON.stringify(dataArray, null, 2); 
      const blob = new Blob([dataString], {type:'application/json'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `backup_zeppelin_${new Date().toISOString().slice(0,10)}.json`;
      a.click();
      showToast('Backup tersimpan âœ…');
    } catch (err) {
      console.error("Backup failed:", err);
      alert('Gagal mengambil backup: ' + err.message);
    }
  });

  /* Restore */
  restoreBtn.addEventListener('click', ()=>restoreFile.click());
  restoreFile.addEventListener('change', (e)=>{ 
    const f = e.target.files[0]; if(!f) return; 
    const r = new FileReader(); 
    r.onload = async (ev) => { 
      try{ 
        const parsedArray = JSON.parse(ev.target.result); 
        if(!Array.isArray(parsedArray)) throw new Error('Format file bukan array.');
        showToast('Memulai restore...');
        const reportsObject = {};
        let maxIdNum = 0;
        parsedArray.forEach(item => {
          if (item.id) {
            reportsObject[item.id] = item;
            try {
              const idNum = parseInt(item.id.split('-')[1], 10);
              if (idNum > maxIdNum) maxIdNum = idNum;
            } catch(e) { /* abaikan */ }
          }
        });
        await reportsRef.set(reportsObject);
        await counterRef.set(maxIdNum);
        showToast('Restore berhasil âœ…'); 
      }catch(err){ 
        console.error("Restore failed:", err);
        alert('File restore tidak valid. Error: ' + err.message); 
      } 
    }; 
    r.readAsText(f); 
    restoreFile.value = '';
  });

  document.getElementById('newReportBtn').addEventListener('click', ()=>openModal(null));
  document.getElementById('exportCsv').addEventListener('click', exportToExcel);
  document.getElementById('searchInput').addEventListener('input', ()=>renderTable(1));
  document.getElementById('filterKategori').addEventListener('change', ()=>renderTable(1));
  document.getElementById('filterWaktu').addEventListener('change', ()=>renderTable(1));
  
  /* (ADMIN) KONTROL OTENTIKASI */
  const loginScreen = document.getElementById('loginScreen');
  const appContent = document.querySelector('.app-content');
  const userEmailDisplay = document.getElementById('userEmailDisplay');
  const authError = document.getElementById('authError');

  function showAuthError(msg) {
    authError.textContent = msg;
    authError.style.display = 'block';
  }

  // (ADMIN) Handle Login
  document.getElementById('loginBtn').addEventListener('click', async () => {
    const username = document.getElementById('loginUser').value;
    const pass = document.getElementById('loginPass').value;
    
    if (username.toLowerCase() !== 'root' || pass !== 'adm123') {
      showAuthError("Username atau Password salah.");
      return;
    }

    try {
      await auth.signInWithEmailAndPassword(ADMIN_EMAIL, pass);
    } catch (err) {
      showAuthError("Login Gagal. Pastikan akun 'root@zeppelin.center' (pass: adm123) sudah didaftarkan via user.html.");
    }
  });
  
  // Handle Logout
  document.getElementById('logoutBtn').addEventListener('click', async () => {
    await auth.signOut();
  });

  /* (DIUBAH) LISTENER OTENTIKASI (Menambahkan listener child_changed untuk NOTIFIKASI URGENT) */
  auth.onAuthStateChanged((user) => {
    if (user) {
      if (user.uid !== ADMIN_UID) {
        showAuthError("AKUN INI BUKAN ADMIN.");
        auth.signOut(); 
        return;
      }
      
      currentUser = user;
      loginScreen.style.display = 'none'; 
      appContent.style.display = 'block'; 
      userEmailDisplay.textContent = `ADMIN (root)`;
      
      if (!dbListenerActive) {
        // Listener Laporan (Utama, untuk render tabel)
        reportsRef.on('value', (snapshot) => {
          const dataObj = snapshot.val();
          allReportsCache = dataObj ? Object.keys(dataObj).map(key => ({ ...dataObj[key], id: key })) : [];
          renderTable(currentPage);
          renderDashboard(); 
          renderCharts(); 
          console.log('Data admin (reports) dimuat dari Firebase.');
        }, (error) => {
          console.error("Firebase read (reports) failed:", error);
          alert("Gagal terhubung ke database laporan. Periksa koneksi atau rules.");
        });

        // (BARU) Listener untuk Notifikasi Urgent (child_changed)
        reportsRef.on('child_changed', (snapshot) => {
            const changedReport = snapshot.val();
            if (!changedReport) return;
            
            // Cek data lama di cache
            const oldReport = allReportsCache.find(r => r.id === changedReport.id);
            
            // Jika status 'urgent' baru saja di-set ke 'true'
            if (changedReport.urgent && (!oldReport || !oldReport.urgent)) {
                console.log(`Notifikasi Urgent: Tiket ${changedReport.id}`);
                showToast(`ðŸ”¥ URGENT: Tiket ${changedReport.id} (${changedReport.nama}) ditandai user!`, 5000, 'danger');
                
                // (PENTING) Update cache agar notif tidak muncul 2x
                if(oldReport) {
                    oldReport.urgent = true;
                }
            }
        });

        // Listener untuk data user
        usersRef.on('value', (snapshot) => {
            const dataObj = snapshot.val();
            allUsersCache = dataObj ? Object.keys(dataObj).map(key => ({ ...dataObj[key], uid: key })) : [];
            // Auto-refresh tabel user jika sedang terbuka
            if (document.getElementById('userManagementPopup').style.display === 'flex') {
                renderUserManagementTable();
            }
            console.log('Data admin (users) dimuat dari Firebase.');
        }, (error) => {
            console.error("Firebase read (users) failed:", error);
        });

        dbListenerActive = true;
      }
      
    } else {
      currentUser = null;
      loginScreen.style.display = 'flex'; 
      appContent.style.display = 'none'; 

      if (dbListenerActive) {
        reportsRef.off(); // Ini akan mematikan SEMUA listener di reportsRef (value dan child_changed)
        usersRef.off(); 
        dbListenerActive = false;
        allReportsCache = []; 
        allUsersCache = []; 
      }
    }
  });
  enableTableSorting();
})();

/* (DIUBAH) MODAL ADD/EDIT (Menambahkan auto-clear status Urgent) */
const modalBackdrop = document.getElementById('modalBackdrop');
const modalForm = document.getElementById('modalForm');
const modalTitle = document.getElementById('modalTitle');
let modalEditingId = null;

async function openModal(editId){
  modalBackdrop.style.display = 'flex';
  modalEditingId = editId || null;
  modalForm.reset(); 
  
  if(editId){
    modalTitle.textContent = `Edit Laporan (ID: ${editId})`;
    const item = getReports().find(r => r.id === editId);
    if (!item) {
        alert("Item tidak ditemukan");
        modalBackdrop.style.display='none';
        return;
    }
    document.getElementById('m_pic').value = item.pic || '';
    document.getElementById('m_nama').value = item.nama || ''; 
    document.getElementById('m_nama').readOnly = true; 
    document.getElementById('m_jenis').value = item.jenis || 'Jaringan';
    document.getElementById('m_kategori').value = item.kategori || 'Normal';
    document.getElementById('m_catatan').value = item.catatan || '';
    document.getElementById('m_status').value = item.status || 'Open';
    
    // (BARU) Otomatis clear status urgent jika admin membukanya
    if (item.urgent) {
        try {
            await reportsRef.child(editId).update({ urgent: false });
            console.log(`Status urgent untuk ${editId} telah di-clear.`);
        } catch (err) {
            console.warn("Gagal clear status urgent:", err);
        }
    }
    
  } else {
    modalTitle.textContent = 'Tambah Laporan (Admin)';
    document.getElementById('m_status').value = 'Open';
    document.getElementById('m_kategori').value = 'Normal';
    document.getElementById('m_nama').readOnly = false;
  }
}

document.getElementById('modalCancel').addEventListener('click', ()=>{ modalBackdrop.style.display='none'; });

document.getElementById('modalSave').addEventListener('click', async (e)=>{
  e && e.preventDefault();
  
  if (!currentUser) { alert("Sesi Admin berakhir. Silakan login ulang."); return; }
  
  const pic = document.getElementById('m_pic').value;
  const nama = document.getElementById('m_nama').value;
  const jenis = document.getElementById('m_jenis').value;
  const kategori = document.getElementById('m_kategori').value;
  const catatan = document.getElementById('m_catatan').value;
  const statusVal = document.getElementById('m_status').value;
  
  if(!pic || !nama || !jenis || !kategori){ alert('PIC, Nama, Jenis, dan Kategori wajib diisi.'); return; }

  let id;
  const isNew = !modalEditingId;
  let oldEntry = {};
  let userUid; 

  if (isNew) {
    id = await generateId(); 
    if (!id) return; 
    userUid = currentUser.uid; // Dibuat oleh Admin (root)
  } else {
    id = modalEditingId;
    oldEntry = getReports().find(r => r.id === id) || {};
    userUid = oldEntry.uid || currentUser.uid; // Pertahankan UID asli
  }
  
  const createdExisting = oldEntry.created || nowString();
  const createdIsoExisting = oldEntry.created_iso || isoNow();
  let updatedVal = oldEntry.updated || null;
  let updatedIsoVal = oldEntry.updated_iso || null;
  
  if(statusVal === 'Closed' && oldEntry.status !== 'Closed'){
    updatedVal = nowString(); updatedIsoVal = isoNow();
  } else if ((statusVal !== oldEntry.status || pic !== oldEntry.pic || kategori !== oldEntry.kategori) && !isNew) {
    updatedVal = nowString(); updatedIsoVal = isoNow();
  }

  const entry = {
    id, pic, nama, jenis, kategori, catatan,
    status: statusVal,
    created: createdExisting, created_iso: createdIsoExisting,
    updated: updatedVal, updated_iso: updatedIsoVal,
    logs: oldEntry.logs || [],
    uid: userUid,
    urgent: oldEntry.urgent || false // (BARU) Pertahankan status urgent (meskipun harusnya sudah di-clear)
  };

  if(entry.updated_iso && entry.created_iso && entry.status === 'Closed'){
    const ms = new Date(entry.updated_iso).getTime() - new Date(entry.created_iso).getTime();
    entry.durationMs = ms >= 0 ? ms : 0; 
    entry.durationText = msToDuration(entry.durationMs);
  } else { 
    entry.durationMs = oldEntry.durationMs || null;
    entry.durationText = oldEntry.durationText || '-';
  }
  let logText = '';
  if (isNew) { logText = `Laporan dibuat (oleh Admin) dengan status ${entry.status}`; } 
  else {
    if(oldEntry.pic !== entry.pic) logText += `PIC: ${oldEntry.pic||'-'} â†’ ${entry.pic}. `;
    if(oldEntry.nama !== entry.nama) logText += `Nama: ${oldEntry.nama} â†’ ${entry.nama}. `;
    if(oldEntry.jenis !== entry.jenis) logText += `Jenis: ${oldEntry.jenis} â†’ ${entry.jenis}. `;
    if(oldEntry.kategori !== entry.kategori) logText += `Kategori: ${oldEntry.kategori||'-'} â†’ ${entry.kategori}. `;
    if(oldEntry.status !== entry.status) logText += `Status: ${oldEntry.status} â†’ ${entry.status}. `;
    if(oldEntry.catatan !== entry.catatan) logText += `Catatan diubah. `;
  }
  if(logText){ entry.logs.push({time: nowString(), iso: isoNow(), detail: `Admin: ${logText.trim()}`}); }

  try {
    await reportsRef.child(id).set(entry);
    if (isNew) { showToast('Laporan baru dibuat âœ…'); } 
    else { showToast('Update berhasil âœ…'); }
    modalBackdrop.style.display='none';
  } catch (err) {
    console.error("Gagal menyimpan:", err);
    alert("Gagal menyimpan data: " + err.message);
  }
});

/* (ADMIN) Log Functions (Full) */
function showLog(id){
  const item = getReports().find(r=>r.id===id); 
  const popup = document.getElementById('logPopup');
  const content = document.getElementById('logContent');
  if(!item){ return; }
  const logs = item.logs || [];
  if(!logs.length) content.textContent = 'Belum ada perubahan tercatat.';
  else content.innerHTML = logs
    .sort((a,b) => new Date(b.iso || 0) - new Date(a.iso || 0)) 
    .map(l=>`ðŸ•’ <strong>${l.time}</strong>\n${l.detail}`)
    .join('\n---------------------------\n');
  popup.style.display = 'flex';
}
document.getElementById('closeLogPopup').addEventListener('click', ()=>document.getElementById('logPopup').style.display='none');
document.getElementById('logPopup').addEventListener('click', e=>{ if(e.target.id==='logPopup') e.currentTarget.style.display='none'; });

/* Global log */
(function(){
  function parseLogDate(l) {
    if (l && l.iso) { return new Date(l.iso); }
    if (l && l.time) { const d = Date.parse(l.time); if (!isNaN(d)) { return new Date(d); } }
    return new Date(0);
  }
  function getAllLogs(){
    const data = getReports(); 
    let allLogs = [];
    data.forEach(r=>{ (r.logs||[]).forEach(l=> allLogs.push({id:r.id,pic:r.pic,detail:l.detail,time:l.time,iso:l.iso})); });
    return allLogs;
  }
  function filterLogsByPeriod(logs, period){
    if(!period) return logs;
    const now = new Date();
    let start = null;
    const end = new Date(now); end.setHours(23,59,59,999); 
    if(period === 'today'){ start = new Date(now); start.setHours(0,0,0,0); }
    else if(period === 'week'){ start = new Date(now); start.setDate(now.getDate() - 7); start.setHours(0,0,0,0); }
    else if(period === 'month'){ start = new Date(now); start.setMonth(now.getMonth() - 1); start.setHours(0,0,0,0); }
    if (start) { return logs.filter(l=>{ const dt = parseLogDate(l); return dt >= start && dt <= end; }); }
    return logs;
  }
  function renderGlobalLog(){
    const el = document.getElementById('globalLogContent');
    if(!el) return;
    const period = document.getElementById('logFilterPeriod')?.value || '';
    let allLogs = getAllLogs();
    allLogs = filterLogsByPeriod(allLogs, period);
    allLogs.sort((a,b)=> parseLogDate(b) - parseLogDate(a));
    const info = document.getElementById('logCountInfo');
    if(!allLogs.length){
      el.textContent = 'Belum ada aktivitas untuk periode ini.';
      if(info) info.textContent = `Menampilkan 0 aktivitas`;
      return;
    }
    el.innerHTML = allLogs.map(l=>`ðŸ•’ <strong>${l.time}</strong>\n[${l.id}] (${l.pic || 'N/A'}) â†’ ${l.detail}`).join('\n---------------------------\n');
    if(info) info.textContent = `Menampilkan ${allLogs.length} aktivitas`;
  }
  const showBtn = document.getElementById('showGlobalLog');
  const closeBtn = document.getElementById('closeGlobalLog');
  const popup = document.getElementById('globalLogPopup');
  const filterSelect = document.getElementById('logFilterPeriod');
  const downloadBtn = document.getElementById('downloadLogPDF');
  if(filterSelect) filterSelect.addEventListener('change', renderGlobalLog);
  if(showBtn){ showBtn.addEventListener('click', ()=>{ renderGlobalLog(); if(popup) popup.style.display = 'flex'; }); }
  if(closeBtn){ closeBtn.addEventListener('click', ()=>{ if(popup) popup.style.display='none'; }); }
  if(popup){ popup.addEventListener('click', e=>{ if(e.target.id==='globalLogPopup') popup.style.display='none'; }); }
  if(downloadBtn){
    downloadBtn.addEventListener('click', ()=>{
      const period = document.getElementById('logFilterPeriod')?.value || '';
      let logs = getAllLogs();
      logs = filterLogsByPeriod(logs, period);
      logs.sort((a,b)=> parseLogDate(b) - parseLogDate(a));
      if(!logs.length){ alert('Tidak ada data log untuk periode ini.'); return; }
      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF({ orientation:'portrait', unit:'pt', format:'a4' });
      pdf.setFontSize(14); pdf.text('Laporan Aktivitas IT Support â€” Zeppelin', 40, 40);
      pdf.setFontSize(10); pdf.text(`Periode: ${period || 'Semua'} | Dibuat: ${new Date().toLocaleString('id-ID')}`, 40, 56);
      pdf.setDrawColor(255,107,0); pdf.line(40, 70, 555, 70);
	    const rows = logs.map((l, i) => {
  		  const report = getReports().find(r => r.id === l.id);
  		  return [i + 1, l.time || '-', report?.nama || l.id, l.pic || '-', l.detail || '-'];
		  });
      pdf.autoTable({
        startY: 90, head: [['#', 'Waktu', 'User/ID', 'PIC', 'Aktivitas']], body: rows,
        styles: { fontSize: 9, cellPadding: 4, lineColor: [230, 230, 230], lineWidth: 0.5 },
        headStyles: { fillColor: [0, 123, 255], textColor: 255, halign: 'center' },
        alternateRowStyles: { fillColor: [248, 249, 250] }, margin: { left: 40, right: 40 },
      });
      const pageCount = pdf.internal.getNumberOfPages();
      for(let i=1;i<=pageCount;i++){
        pdf.setPage(i);
        pdf.setFontSize(9);
        pdf.text(`Halaman ${i} dari ${pageCount}`, 500, 820);
        pdf.text('Â© Zeppelin IT Support Dashboard', 40, 820);
      }
      pdf.save(`Log_Aktivitas_${period||'Semua'}_${new Date().toISOString().slice(0,10)}.pdf`);
    });
  }
})();

/* Charts */
function renderCharts(){
  const chartsDiv = document.getElementById('chartsArea');
  const all = getReports(); 
  const byCat = {Low:0,Normal:0,Critical:0};
  const byStatus = {Open:0,Progress:0,Closed:0};
  all.forEach(r=>{ 
    byCat[r.kategori || 'Normal'] = (byCat[r.kategori || 'Normal']||0)+1; 
    byStatus[r.status] = (byStatus[r.status]||0)+1; 
  });
  chartsDiv.innerHTML = `<div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;
    ${ (window.innerWidth < 768) ? 'grid-template-columns: 1fr;' : '' }">
    <div class="card"><h3>Distribusi Kategori</h3><canvas id="categoryChart"></canvas></div>
    <div class="card"><h3>Status Laporan</h3><canvas id="statusChart"></canvas></div>
  </div>`;
  const ctx1 = document.getElementById('categoryChart')?.getContext('d');
  const ctx2 = document.getElementById('statusChart')?.getContext('d');
  try{ window.myChart1 && window.myChart1.destroy(); window.myChart2 && window.myChart2.destroy(); }catch(e){}
  const catColors = ['#0284c7', '#d97706', '#dc2626'];
  const statColors = ['#b45309','#0284c7','#16a34a']; 
  if(ctx1){
    window.myChart1 = new Chart(ctx1, { 
      type: 'bar', data: { labels:['Low','Normal','Critical'], datasets:[{ data:[byCat.Low, byCat.Normal, byCat.Critical], backgroundColor: catColors, borderWidth: 0, borderRadius: 4, barThickness: 25 }] }, 
      options:{ indexAxis: 'y', responsive: true, plugins: { legend: { display: false } },
        scales: { x: { beginAtZero: true, grid: { display: false, drawBorder: false }, ticks: { stepSize: 1, callback: function(value) { if (Number.isInteger(value)) { return value; } } } }, y: { grid: { display: false } } }
      } 
    });
  }
  if(ctx2){
    window.myChart2 = new Chart(ctx2, { 
      type:'doughnut', data:{ labels:['Open','Progress','Closed'], datasets:[{ data:[byStatus.Open,byStatus.Progress,byStatus.Closed], backgroundColor: statColors, borderWidth: 0 }] }, 
      options:{ cutout:'65%', plugins:{ legend:{ position:'bottom', labels:{font:{weight:600}} } }, animation:{duration:600} } 
    });
  }
}

/* Summary popup */
function showSummary(type){
  const all = getReports(); 
  let filtered = [];
  if(type === 'Total') filtered = all;
  else if(type === 'Low' || type === 'Normal' || type === 'Critical'){ filtered = all.filter(r=>r.kategori === type); } 
  else { filtered = all.filter(r=>r.status === type); }
  const title = type==='Total' ? 'Semua Laporan' : 'Rincian ' + type;
  document.getElementById('summaryTitle').textContent = title;
  const content = document.getElementById('summaryContent');
  if(!filtered.length){ content.innerHTML = '<p class="small">Tidak ada data.</p>'; } 
  else {
    content.innerHTML = `<table style="width:100%;border-collapse:collapse;font-size:13px;"><thead><tr><th style="text-align:left;padding:8px">ID</th><th style="padding:8px">PIC</th><th style="padding:8px">Nama</th><th style="padding:8px">Jenis</th><th style="padding:8px">Kategori</th><th style="padding:8px">Status</th><th style="padding:8px">Dibuat</th></tr></thead><tbody>${
      filtered
        .sort((a,b) => new Date(b.created_iso) - new Date(a.created_iso))
        .map(r=>`<tr><td style="padding:8px">${r.id}</td><td style="padding:8px">${r.pic||'-'}</td><td style="padding:8px">${r.nama}</td><td style="padding:8px">${r.jenis}</td><td style="padding:8px">${r.kategori||'-'}</td><td style="padding:8px">${r.status}</td><td style="padding:8px">${r.created}</td></tr>`).join('')
    }</tbody></table>`;
  }
  document.getElementById('summaryPopup').style.display = 'flex';
  document.getElementById('exportSummaryBtn').onclick = function(){
    if(!filtered.length){ alert('Tidak ada data untuk diekspor.'); return; }
    const rows = filtered.map(r=>({ ID:r.id, PIC:r.pic, Nama:r.nama, Jenis:r.jenis, Kategori:r.kategori, Status:r.status, Dibuat:r.created }));
    const ws = XLSX.utils.json_to_sheet(rows);
    const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, `Rincian_${type}`);
    XLSX.writeFile(wb, `Rincian_${type}_${new Date().toISOString().slice(0,10)}.xlsx`);
  };
}
document.getElementById('closeSummaryBtn')?.addEventListener('click', ()=>{ document.getElementById('summaryPopup').style.display='none'; });
document.getElementById('summaryPopup')?.addEventListener('click', (e)=>{ if(e.target.id==='summaryPopup') e.currentTarget.style.display='none'; });
function enableSummaryClicksNow(){
  document.querySelectorAll('.summary-card').forEach(card=>{
    card.style.cursor = 'pointer';
    card.onclick = null; 
    card.addEventListener('click', ()=>{
      const labelEl = card.querySelector('.small');
      const label = labelEl ? labelEl.textContent.trim() : '';
      if(label === 'Total') showSummary('Total');
      else if(label === 'Open') showSummary('Open');
      else if(label === 'Progress') showSummary('Progress');
      else if(label === 'Closed') showSummary('Closed');
      else if(label === 'Low') showSummary('Low');
      else if(label === 'Normal') showSummary('Normal');
      else if(label === 'Critical') showSummary('Critical');
    });
  });
}
try{ enableSummaryClicksNow(); }catch(e){}

/* (BARU) === FUNGSI MANAJEMEN USER === */
        
// Render tabel user
function renderUserManagementTable() {
    const content = document.getElementById('userManagementContent');
    const filter = document.getElementById('userFilterStatus').value;
    const info = document.getElementById('userCountInfo');
    
    if (!allUsersCache.length) {
        content.innerHTML = '<p class="small" style="text-align:center; padding: 20px;">Tidak ada user terdaftar.</p>';
        if (info) info.textContent = `Menampilkan 0 user`;
        return;
    }

    const filteredUsers = allUsersCache.filter(user => {
        // (BARU) Jangan tampilkan admin (root) di daftar user management
        if (user.uid === ADMIN_UID) return false; 
            
        if (filter === "") return true; 
        const userStatus = user.status || 'pending'; 
        return userStatus === filter; 
    });
    
    if (info) info.textContent = `Menampilkan ${filteredUsers.length} user`;
    
    if (!filteredUsers.length) {
        content.innerHTML = `<p class="small" style="text-align:center; padding: 20px;">Tidak ada user dengan status '${filter}'.</p>`;
        return;
    }
    
    // Buat tabel
    content.innerHTML = `
        <div class="table-wrap" style="margin-top:0;">
        <table style="width:100%; min-width: 600px;">
            <thead>
                <tr>
                    <th>Nama</th>
                    <th>Email</th>
                    <th>Status</th>
                    <th>Aksi</th>
                </tr>
            </thead>
            <tbody>
                ${filteredUsers
                    .sort((a,b) => (a.nama || '').localeCompare(b.nama || '')) // Urutkan A-Z
                    .map(user => {
                    const status = user.status || 'pending'; // default ke pending
                    let statusClass = 'cat-normal'; // Kuning (Pending)
                    if (status === 'approved') statusClass = 's-closed'; // Hijau (Approved)
                    if (status === 'rejected') statusClass = 'cat-critical'; // Merah (Rejected)

                    // Tentukan tombol aksi
                    let actions = '';
                    if (status !== 'approved') {
                        actions += `<button class="btn" onclick="approveUser('${user.uid}')" style="padding: 4px 8px; font-size:12px; background:var(--success); color: #fff;">Approve</button> `;
                    }
                    if (status !== 'rejected') {
                        actions += `<button class="btn" onclick="rejectUser('${user.uid}')" style="padding: 4px 8px; font-size:12px; background:var(--danger); color: #fff;">Reject</button> `;
                    }
                    if (status === 'approved' || status === 'rejected') {
                        actions += `<button class="btn ghost" onclick="makePending('${user.uid}')" style="padding: 4px 8px; font-size:12px;">Set Pending</button>`;
                    }

                    return `
                        <tr>
                            <td>${user.nama || 'N/A'}</td>
                            <td>${user.email || 'N/A'}</td>
                            <td><span class="status ${statusClass}">${status}</span></td>
                            <td class="actions">${actions}</td>
                        </tr>
                    `;
                }).join('')}
            </tbody>
        </table>
        </div>
    `;
}

// Aksi admin
async function approveUser(uid) {
    if (!uid) return;
    try {
        await usersRef.child(uid).update({ status: 'approved' });
        showToast('User disetujui âœ…');
    } catch (e) {
        alert('Gagal update user: ' + e.message);
    }
}

async function rejectUser(uid) {
    if (!uid) return;
    try {
        await usersRef.child(uid).update({ status: 'rejected' });
        showToast('User ditolak âŒ');
    } catch (e) {
        alert('Gagal update user: ' + e.message);
    }
}

async function makePending(uid) {
    if (!uid) return;
    try {
        await usersRef.child(uid).update({ status: 'pending' });
        showToast('User di-set ke Pending â³');
    } catch (e) {
        alert('Gagal update user: ' + e.message);
    }
}

// Event listener untuk popup
(function initUserManagement() {
    document.getElementById('showUserManagement')?.addEventListener('click', () => {
        renderUserManagementTable();
        document.getElementById('userManagementPopup').style.display = 'flex';
    });
    document.getElementById('closeUserManagement')?.addEventListener('click', () => {
        document.getElementById('userManagementPopup').style.display = 'none';
    });
    document.getElementById('userFilterStatus')?.addEventListener('change', renderUserManagementTable);
})();

/* === AKHIR FUNGSI MANAJEMEN USER === */


// Expose functions to global
window.openModal = openModal;
window.deleteReport = deleteReport;
window.showLog = showLog;
// (BARU) Expose fungsi user
window.approveUser = approveUser;
window.rejectUser = rejectUser;
window.makePending = makePending;

</script>

</body>
</html>
