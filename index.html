<!doctype html>
<html lang="id">
<head>
<meta charset="utf-f" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Zeppelin â€” ADMIN DASHBOARD</title>
<link rel="icon" type="image/png" href="icov2.png" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.0/jspdf.plugin.autotable.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-analytics.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');
  :root{
    --bg: #f4f7fa; --card: #ffffff; --muted:#6c757d; --text:#212529; --primary:#007bff;
    --primary-hover:#0069d9; --accent:#58a6ff; --success:#16a34a; --warning: #f59e0b;
    --danger:#dc3545; --radius: 10px; --border-color: #e9ecef; --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
    --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.07), 0 2px 4px -2px rgba(0, 0, 0, 0.07);
  }
  [data-theme="dark"]{
    --bg:#0f172a; --card:#1e293b; --muted:#94a3b8; --text:#f1f5f9; --primary:#3b82f6;
    --primary-hover:#2563eb; --border-color: #334155; --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.1);
    --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
  }
  *{box-sizing:border-box}
  
  /* === PERBAIKAN KRITIS 1: Mencegah Horizontal Scrolling Global === */
  html, body {
      overflow-x: hidden; 
      width: 100%;
      min-width: 320px; 
  }
  body{
    margin:0; font-family:'Inter', system-ui, Roboto, Arial, sans-serif; background:var(--bg);
    color:var(--text); padding:24px; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale;
  }
  .app{max-width:1400px;margin:0 auto}
  header.app-header{
    display:flex; align-items:center; gap:16px; margin-bottom:24px; padding-bottom: 20px;
    border-bottom: 1px solid var(--border-color); flex-wrap: wrap; /* (RESPONSIVE) */
  }
  .logo{
    width:48px; height:48px; border-radius:var(--radius);
    background:linear-gradient(135deg, var(--primary), var(--accent));
    display:flex; align-items:center; justify-content:center; color:#fff;
    font-weight:800; font-size:18px;
  }
  .title .name{font-size:22px;font-weight:800}
  .title .tag{font-size:13px;color:var(--muted);font-weight:500;}
  .controls{margin-left:auto;display:flex;gap:10px;align-items:center; flex-wrap: wrap;} /* (RESPONSIVE) */
  .btn{
    background:var(--primary); color:#fff; border:none; padding:9px 14px; border-radius:8px;
    cursor:pointer; font-weight:600; display:inline-flex; align-items:center; gap:6px;
    font-size:14px; transition: background-color 0.2s ease; text-decoration: none; line-height: 1;
    position: relative; /* Untuk badge notif */
  }
  .btn:hover{ background: var(--primary-hover); }
  .btn.ghost{ background:transparent; border:1px solid var(--border-color); color:var(--text); font-weight: 500; }
  .btn.ghost:hover{ background: var(--border-color); }
  .btn:not(.ghost){ box-shadow: var(--shadow-sm); }
  .btn svg{width:16px;height:16px;stroke-width:2.5}
  
  /* Badge Notifikasi Chat */
  .chat-notification-badge {
    position: absolute;
    top: -5px;
    right: -5px;
    background-color: var(--danger);
    color: white;
    font-size: 10px;
    font-weight: 700;
    border-radius: 50%;
    padding: 3px 6px;
    min-width: 20px;
    text-align: center;
    line-height: 1;
    box-shadow: 0 0 0 2px var(--card);
    display: none; /* Default hidden */
  }

  .btn-link {
    background: none; border: none; padding: 0;
    color: var(--primary); font-weight: 600; cursor: pointer;
    text-align: left; font-size: 14px; font-family: 'Inter', sans-serif;
  }
  .btn-link:hover { text-decoration: underline; }

  .card{
    background:var(--card); padding: 20px 24px; border-radius:var(--radius);
    box-shadow:var(--shadow-sm); border:1px solid var(--border-color);
  }
  h3 { font-size: 18px; font-weight: 700; margin-top: 0; margin-bottom: 16px; }
  h4 { font-size: 16px; font-weight: 600; margin-top: 20px; margin-bottom: 10px; }
  .grid{ display:grid; grid-template-columns:1fr; gap:20px; margin-bottom: 20px; }
  .row { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 16px; }
  .summary-card {
    padding: 16px !important; border: 1px solid var(--border-color) !important;
    border-radius: var(--radius) !important; box-shadow: none !important;
    transition: all 0.2s ease; cursor: pointer;
  }
  .summary-card:hover { transform: translateY(-2px); box-shadow: var(--shadow-md) !important; }
  .summary-card .small { font-weight: 600; }
  .summary-card div[style*="font-weight:800"] {
    font-size: 24px !important; font-weight: 800 !important;
    color: var(--primary); margin-top: 8px;
  }
  .small{font-size:13px;color:var(--muted);font-weight:500;}
  .filter-bar{display:flex;gap:10px;align-items:center;margin-bottom:10px; flex-wrap: wrap;} /* (RESPONSIVE) */
  .filter-bar input, .filter-bar select{
    padding:9px 12px; border-radius:8px; border:1px solid var(--border-color);
    background:var(--card); color: var(--text); font-size:14px; font-family: 'Inter', sans-serif;
  }
  .filter-bar input::placeholder { color: var(--muted); }
  .filter-bar #exportCsv { background: transparent; color: var(--text); font-weight: 500; }
  
  /* PERBAIKAN KRITIS 2: Memastikan tabel tidak meluap, hanya di-scroll */
  .table-wrap{overflow-x: auto;}
  table{width:100%;border-collapse:collapse;min-width:900px}
  th,td{padding:12px 14px;text-align:left;border-bottom:1px solid var(--border-color);vertical-align: middle;}
  th{
    background:var(--bg); color:var(--muted); font-size:12px; font-weight: 600;
    text-transform: uppercase; letter-spacing: 0.5px; position:relative; user-select:none;
  }
  th.sortable{cursor:pointer}
  th.sortable:hover { color: var(--text); }
  th .sort-ind{font-size:11px;margin-left:6px;opacity:0.8}
  tr:hover td{background:rgba(0, 123, 255, 0.02)}
  .status, .cat-badge {
    display:inline-block; padding: 4px 12px; border-radius:999px;
    font-weight:600; font-size:12px; line-height: 1.5;
  }
  .s-open{background:#fffbeb;color:#b45309}
  .s-progress{background:#e0f2fe;color:#0284c7}
  .s-closed{background:#dcfce7;color:#16a34a}
  .cat-low{background:#e0f2fe;color:#0284c7}
  .cat-normal{background:#fffbeb;color:#d97706}
  .cat-critical{background:#fee2e2;color:#dc2626}
  .pagination{display:flex;gap:6px;justify-content:flex-end;margin-top:16px; flex-wrap: wrap;}
  .pagination button{
    padding:6px 12px; border-radius:6px; border:1px solid var(--border-color);
    background:var(--card); color: var(--text); font-weight: 500; cursor:pointer;
  }
  .pagination button:hover { background: var(--bg); }
  .pagination button.active{
    background:var(--primary); color:#fff; border-color:var(--primary); font-weight: 600;
  }
  
  .modal-backdrop, #announcementModalBackdrop, #announcementDetailModal {
    position:fixed; inset:0; background:rgba(0,0,0,0.6); display:none;
    align-items:center; justify-content:center; z-index:9999; padding: 16px;
  }
  .modal, #announcementModalBackdrop > .modal, #announcementDetailModal > .modal { 
    width:720px; max-width: 100%;
    background:var(--card); padding: 24px; border-radius:12px; 
    box-shadow:0 12px 40px rgba(0,0,0,0.35); 
  }
  .form-row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  input,select,textarea{
    width:100%; padding:10px 12px; border-radius:8px; border:1px solid var(--border-color);
    background:var(--bg); color: var(--text); font-size:14px; font-family:'Inter', system-ui, Roboto, Arial;
  }
  input:focus, select:focus, textarea:focus {
    outline: none; border-color: var(--primary); box-shadow: 0 0 0 2px rgba(0,123,255,0.2);
  }
  textarea{min-height:120px;resize: vertical;}
  .flex{display:flex;gap:8px;align-items:center}
  footer.small{ margin-top:32px; text-align:center; color:var(--muted); font-size:13px; }
  
  #logPopup, #globalLogPopup, #summaryPopup {
    position:fixed; inset:0; background:rgba(0,0,0,0.6); display:none;
    align-items:center; justify-content:center; z-index:6000; padding: 16px;
  }
  #logPopup > div, #globalLogPopup > div, #summaryPopup > div {
    background: var(--card); color: var(--text); padding: 24px; border-radius: 12px;
    width: 900px; 
    max-width: 100%;
    max-height: 85%; overflow: auto;
    box-shadow: 0 12px 40px rgba(0, 0, 0, 0.35); display: flex; flex-direction: column;
  }

  #globalLogContent, #logContent {
    font-size: 14px; margin-top: 10px; line-height: 1.7;
    flex-grow: 1; overflow-y: auto; background: var(--bg); padding: 12px; border-radius: 8px;
    white-space: pre-wrap; 
  }
  #summaryContent {
    font-size: 14px; margin-top: 10px; line-height: 1.7;
    flex-grow: 1; overflow-y: auto; background: var(--bg); padding: 12px; border-radius: 8px;
  }

  #summaryContent table { font-size: 13px; }
  #logControlPanel {
    display: flex; gap: 10px; align-items: center; margin-bottom: 16px;
    padding-bottom: 16px; border-bottom: 1px solid var(--border-color);
    flex-wrap: wrap;
  }

  .detail-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(130px, 1fr));
      gap: 12px;
  }
  .detail-card .count {
      font-size: 22px;
      font-weight: 800;
      margin-top: 8px;
      color: var(--primary);
  }
  .detail-card .small {
      font-weight: 600;
  }
  .stat-col { text-align: center !important; font-weight: 600; }
  .stat-col-urgent { color: var(--danger); font-weight: 800; }


  /* (ADMIN) STYLE LOGIN */
  #loginScreen {
    position: fixed; inset: 0; background: var(--bg); z-index: 10000;
    display: flex; align-items: center; justify-content: center; padding: 16px;
  }
  #loginBox {
    width: 400px; max-width: 100%;
    background: var(--card); padding: 28px;
    border-radius: var(--radius); border: 1px solid var(--border-color);
    box-shadow: var(--shadow-md);
  }
  #loginBox h3 { text-align: center; }
  #loginBox form div { margin-top: 10px; }
  #loginBox input { padding: 12px; }
  #loginBox button { width: 100%; justify-content: center; padding: 12px; margin-top: 16px; }
  #authError { color: var(--danger); font-size: 13px; text-align: center; margin-top: 10px; display: none; }
  .app-content { display: none; }
  
  @media (max-width: 900px) {
    body { padding: 16px; }
    .app { padding: 0; }
    .modal { width: 95%; }
    .form-row { grid-template-columns: 1fr; } 
    
    .controls { 
        justify-content: flex-start; 
        gap: 8px;
    }
    .filter-bar { 
        flex-direction: column; 
        align-items: stretch; 
        width: 100%; 
    }
    .filter-bar input, .filter-bar select {
        width: 100%; 
    }
    .row {
        grid-template-columns: 1fr 1fr;
    }
    #logPopup > div, #globalLogPopup > div, #summaryPopup > div {
        width: 95%;
    }
  }
  
  @media (max-width: 600px) {
    body { padding: 12px; } /* Padding body sedikit dikurangi */
    .app { padding: 0; }

    .row {
        grid-template-columns: 1fr; /* Ringkasan menjadi kolom tunggal */
    }
    /* Mengubah header menjadi position: relative agar tombol logout bisa absolute di dalamnya */
    .app-header { 
        position: relative; 
        padding-left: 0px; 
        padding-right: 0px;
        margin-bottom: 16px;
        padding-bottom: 12px;
    }
    .logo { margin-left: 10px; }
    .title { margin-left: -6px; }
    
    /* Tombol Logout (dipindahkan ke kanan atas) */
    /* Dipindahkan ke luar alur controls utama */
    #logoutBtn {
        position: absolute !important; 
        top: 12px;
        right: 12px; 
        padding: 6px 10px !important; 
        font-size: 0.8rem;
        display: inline-flex !important;
        width: auto !important;
        height: auto !important;
        z-index: 10;
    }

    /* Ikon Notifikasi Chat (dibuat lebih kecil) */
    /* Dipindahkan ke luar alur controls utama */
    #chatNotificationBtn {
        padding: 8px !important; /* Ukuran icon-only */
        width: 38px !important;
        height: 38px !important;
        position: absolute !important; 
        top: 12px;
        right: 80px; 
        display: inline-flex !important;
        z-index: 10;
    }
    #chatNotificationBtn svg {
        width: 20px;
        height: 20px;
    }
    .controls #chatUnreadBadge {
        top: 0px; 
        right: 0px; 
        font-size: 8px;
        min-width: 16px;
        padding: 2px 4px;
    }

    /* === Kontrol Lain di Bawah Header (Mobile) === */
    .controls {
        margin-left: 0;
        width: 100%;
        gap: 6px;
        justify-content: flex-start;
        flex-wrap: wrap; 
        padding: 0 10px; /* Padding horizontal untuk konten controls */
        margin-top: 10px; 
    }
    
    .controls #dateTime, .controls #userInfo { 
        display: none; 
    } 
    
    /* Tombol Icon-Only (Semua tombol ghost) */
    .controls .btn.ghost {
        padding: 8px;
        flex-grow: 0;
        width: 38px;
        height: 38px;
        display: inline-flex; 
        justify-content: center;
        align-items: center;
    }
    
    .controls #newReportBtn {
        width: 100%;
        justify-content: center;
        margin-top: 8px;
        flex-basis: 100%; 
        padding: 10px;
    }
    
    .controls > * {
        margin-bottom: 6px; 
    }

    /* Perbaikan: Atur lebar filter bar agar tidak meluap */
    .filter-bar {
        width: 100%;
        padding: 0; 
        margin-bottom: 10px;
    }
    .filter-bar input, .filter-bar select {
        width: 100%;
        margin-bottom: 8px;
    }

    /* Memastikan card tidak meluap */
    .grid > .card, .card-announcement {
        padding-left: 10px !important;
        padding-right: 10px !important;
        margin-left: -12px; /* Mengimbangi padding body 12px */
        margin-right: -12px;
        width: calc(100% + 24px); /* Penuh lebar */
        max-width: none;
    }
    .card-announcement-header {
        padding-left: 12px;
        padding-right: 12px;
    }
    .simple-announcement-item {
        padding-left: 12px;
        padding-right: 12px;
    }
    
    /* Memastikan tabel tetap di-scroll horizontal */
    .table-wrap {
        margin-left: -12px;
        margin-right: -12px;
        width: calc(100% + 24px);
    }
    .table-wrap table {
        min-width: 600px; /* Lebar minimum untuk memastikan scrolling horizontal */
    }
  }

  /* (REWORK) CSS UNTUK LIST PENGUMUMAN (SIMPLE) */
  #announcementList {
    display: flex;
    flex-direction: column;
    padding: 8px 0; 
  }
  .simple-announcement-item {
    padding: 12px 24px; 
    border-bottom: 1px solid var(--border-color);
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    transition: background-color 0.2s ease;
    display: flex;
    align-items: center;
    gap: 8px;
  }
  .simple-announcement-item:last-child {
    border-bottom: none;
  }
  .simple-announcement-item:hover {
    background-color: var(--bg);
  }
  .simple-announcement-item .pin-icon {
    font-size: 12px;
    color: var(--warning);
  }
  .simple-announcement-item .category-tag {
    font-weight: 700;
    color: var(--primary);
  }
  .simple-announcement-item .category-tag.critical { color: var(--danger); }
  .simple-announcement-item .category-tag.event { color: var(--warning); }
  
  /* (REWORK) Menyesuaikan padding card pengumuman */
  .card-announcement {
    padding: 0 !important; 
    overflow: hidden; 
  }
  .card-announcement-header {
    display:flex;
    justify-content:space-between;
    align-items:center;
    flex-wrap:wrap;
    gap:10px;
    padding: 20px 24px; 
    border-bottom: 1px solid var(--border-color);
  }
  
  /* (BARU) CSS untuk Modal Detail */
  #annDetailMeta {
    font-size: 13px;
    color: var(--muted);
    font-weight: 500;
    margin-bottom: 16px;
    padding-bottom: 16px;
    border-bottom: 1px solid var(--border-color);
    line-height: 1.5;
  }
  #annDetailMeta strong {
    color: var(--text);
    font-weight: 600;
  }
  #annDetailContent {
    max-height: 50vh;
    overflow-y: auto;
    line-height: 1.7;
    font-size: 15px;
    white-space: normal; 
  }
  #annDetailContent p { margin-bottom: 1em; }
  #annDetailContent ol, #annDetailContent ul { margin-left: 1.5em; margin-bottom: 1em; }
  
  /* (MODIFIKASI) ID am_title sekarang adalah textarea */
  #am_title {
      min-height: 150px;
  }

</style>
</head>
<body data-theme="light">

<svg width="0" height="0" style="position:absolute">
  <defs>
    <svg id="icon-download" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
    <svg id="icon-upload" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>
    <svg id="icon-plus" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
    <svg id="icon-log" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"></path><rect x="8" y="2" width="8" height="4" rx="1" ry="1"></rect></svg>
    <svg id="icon-users" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>
    <svg id="icon-bell" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path><path d="M13.73 21a2 2 0 0 1-3.46 0"></path></svg>
    <svg id="icon-laptop" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 16V7a2 2 0 0 0-2-2H6a2 2 0 0 0-2 2v9m16 0h-2m2 0v2a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2v-2m-2 0h2m-2 0H4m0 0v-9m16 9h-2M6 5H4m16 0v2m-1.9 8H6.1m8 0h.1m-8.2 0h.1M6 16v-2m0 2H4"></path></svg>
    <svg id="icon-archive" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="21 8 21 21 3 21 3 8"></polyline><rect x="1" y="3" width="22" height="5"></rect><line x1="10" y1="12" x2="14" y2="12"></line></svg>
    <svg id="icon-message-circle" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 11.5a8.38 8.38 0 0 1-.95 3.19c-.58.94-1.39 1.77-2.39 2.45-1.02.69-2.18 1.14-3.4 1.34L12 22l-1.26-2.52c-1.22-.2-2.38-.65-3.4-1.34-1-.68-1.81-1.51-2.39-2.45A8.38 8.38 0 0 1 3 11.5V11a8 8 0 0 1 16 0c0 1.22-.22 2.38-.65 3.4-1.34 2.18-3.5 3.5-5.9 3.5H12"></path><circle cx="12" cy="11" r="5"></circle></svg>
    </defs>
</svg>
<div id="loginScreen">
  <div id="loginBox">
    <form id="loginForm" onsubmit="return false;">
      <h3>Admin Login (root)</h3>
      <div><label class="small">Username</label><input id="loginUser" type="text" required placeholder="root"></div>
      <div><label class="small">Password</label><input id="loginPass" type="password" required placeholder="adm123"></div>
      <button id="loginBtn" class="btn">Login</button>
    </form>
    <div id="authError"></div>
  </div>
</div>

<div class="app app-content">
  <header class="app-header">
    <div class="logo">ZP</div>
    <div class="title"><div class="name">Zeppelin</div><div class="tag">ADMIN DASHBOARD</div></div>
    
    <div class="controls">
      <div id="dateTime" class="small"></div>
      <div id="userInfo" class="small" style="text-align: right;">
        Logged in as:<br>
        <strong id="userEmailDisplay"></strong>
      </div>
      <button id="logoutBtn" class="btn ghost" title="Logout">Logout</button>
      
      <a href="chatadm.html" id="chatNotificationBtn" class="btn ghost" title="Pesan Baru" style="padding: 9px 14px;">
         <svg><use href="#icon-message-circle" /></svg>
         <span id="chatUnreadBadge" class="chat-notification-badge"></span>
      </a>
      
      <button id="backupBtn" class="btn ghost" title="Backup Data">
        <svg><use href="#icon-download" /></svg>
      </button>
      <input id="restoreFile" type="file" accept=".json" style="display:none" />
      <button id="restoreBtn" class="btn ghost" title="Restore Data">
        <svg><use href="#icon-upload" /></svg>
      </button>
      <button id="showGlobalLog" class="btn ghost" title="Lihat Log Aktivitas">
         <svg><use href="#icon-log" /></svg>
      </button>
      
      <a href="usermanagement.html" id="showUserManagement" class="btn ghost" title="Manajemen User">
         <svg><use href="#icon-users" /></svg>
      </a>
      
      
      <a href="permintaanadmin.html" id="showRequestManagement" class="btn ghost" title="Manajemen Permintaan">
         <svg><use href="#icon-laptop" /></svg>
      </a>
      
      <a href="https://itdevhiro-glitch.github.io/widget/asset.html" target="_blank" id="showAssetManager" class="btn ghost" title="Manajemen Aset">
         <svg><use href="#icon-archive" /></svg>
      </a>
      
      <button id="newReportBtn" class="btn">
        <svg><use href="#icon-plus" /></svg>
        Buat Laporan
      </button>
    </div>
    </header>

  <main id="mainContent">
    <div class="grid">
      <div class="card">
        <h3>Ringkasan Cepat</h3>
        <div class="row" style="margin-top:12px">
          <div class="card summary-card" style="padding:10px;border-radius:10px;flex:1"><div class="small">Total</div><div id="totalCount" style="font-weight:800;font-size:18px">0</div></div>
          <div class="card summary-card" style="padding:10px;border-radius:10px;flex:1"><div class="small">Open</div><div id="openCount" style="font-weight:800;font-size:18px">0</div></div>
          <div class="card summary-card" style="padding:10px;border-radius:10px;flex:1"><div class="small">Progress</div><div id="progressCount" style="font-weight:800;font-size:18px">0</div></div>
          <div class="card summary-card" style="padding:10px;border-radius:10px;flex:1"><div class="small">Closed</div><div id="closedCount" style="font-weight:800;font-size:18px">0</div></div>
        </div>
        <div style="margin-top:12px"><div class="small">Distribusi Kategori</div><div id="categorySummary" style="display:flex;gap:8px;margin-top:8px;flex-wrap:wrap;"></div></div>
      </div>
    </div>
    
    <div class="card card-announcement" style="margin-top:18px">
      <div class="card-announcement-header">
        <h3 class="section-title" style="margin:0;">ðŸ“¢ Pengumuman</h3>
        <button id="newAnnouncementBtn" class="btn">
          <svg><use href="#icon-plus" /></svg>
          Buat Baru
        </button>
      </div>
      <div id="announcementList">
        </div>
    </div>
    
    <div class="card" style="margin-top:18px">
      <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:10px;">
        <h3 class="section-title" style="margin:0;">Daftar Laporan (Semua User)</h3>
        <div class="filter-bar" style="margin-bottom:0;">
          <input id="searchInput" placeholder="Cari ID, nama, jenis, PICâ€¦" style="min-width:250px;" />
          <select id="filterKategori"><option value="">Semua Kategori</option><option value="Low">Low</option><option value="Normal">Normal</option><option value="Critical">Critical</option></select>
          <select id="filterWaktu"><option value="">Semua Waktu</option><option value="today">Hari Ini</option><option value="week">Minggu Ini</option><option value="month">Bulan Ini</option></select>
          <button id="exportCsv" class="btn ghost">ðŸ“¤ Export</button>
        </div>
      </div>
      <div class="table-wrap" style="margin-top:12px;">
        <table id="reportTable" aria-describedby="Daftar laporan">
          <thead>
            <tr>
              <th class="sortable" data-key="id">ID<span class="sort-ind"></span></th>
              <th class="sortable" data-key="pic">PIC<span class="sort-ind"></span></th>
              <th class="sortable" data-key="nama">Nama<span class="sort-ind"></span></th>
              <th class="sortable" data-key="jenis">Jenis<span class="sort-ind"></span></th>
              <th class="sortable" data-key="kategori">Kategori<span class="sort-ind"></span></th>
              <th class="sortable" data-key="status">Status<span class="sort-ind"></span></th>
              <th class="sortable" data-key="created_iso">Dibuat<span class="sort-ind"></span></th>
              <th class="sortable" data-key="updated_iso">Diperbarui<span class="sort-ind"></span></th>
              <th class="sortable" data-key="durationText">Durasi<span class="sort-ind"></span></th>
              <th>Actions</th>
              <th>Catatan</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <div class="pagination" id="pagination"></div>
    </div>
    <div id="chartsArea" style="margin-top:18px;"></div>
  </main>
  <footer class="small">Zeppelin IT Support (Admin) â€” <span id="footerDate"></span></footer>
</div>

<div class="modal-backdrop" id="modalBackdrop">
  <div class="modal" role="dialog" aria-modal="true">
    <h3 id="modalTitle">Edit Laporan</h3>
    <form id="modalForm" onsubmit="return false;">
      <div class="form-row">
        <div><label class="small">PIC</label><input id="m_pic" required placeholder="PIC penindaklanjut"></div>
        <div><label class="small">Nama User</label><input id="m_nama" required placeholder="Nama pemohon" readonly></div> <div><label class="small">Jenis Masalah</label>
          <select id="m_jenis" required><option value="">Pilihâ€¦</option><option>Jaringan</option><option>Hardware</option><option>Software</option><option>Login / Akun</option><option>Lainnya</option></select>
        </div>
        <div><label class="small">Kategori</label>
          <select id="m_kategori" required><option value="">Pilihâ€¦</option><option value="Low">Low</option><option value="Normal">Normal</option><option value="Critical">Critical</option></select>
        </div>
      </div>
      <div style="margin-top:10px"><label class="small">Catatan / Detail</label><textarea id="m_catatan" placeholder="Deskripsi singkat"></textarea></div>
      <div style="margin-top:10px">
        <label class="small">Status</label>
        <select id="m_status" required>
          <option value="Open">Open</option>
          <option value="Progress">Progress</option>
          <option value="Closed">Closed</option>
        </select>
        <div class="small" style="margin-top:4px;">Jika memilih <strong>Closed</strong>, waktu selesai akan otomatis dicatat.</div>
      </div>
      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
        <button id="modalSave" class="btn">Simpan</button>
        <button id="modalCancel" type="button" class="btn ghost">Batal</button>
      </div>
    </form>
  </div>
</div>
<div id="logPopup">
  <div>
    <h3>Riwayat Perubahan</h3>
    <div id="logContent"></div>
    <div style="display:flex;gap:8px;margin-top:12px;justify-content:flex-end;">
      <button id="closeLogPopup" class="btn">Tutup</button>
    </div>
  </div>
</div>
<div id="globalLogPopup">
  <div>
    <h3>ðŸ“œ Log Aktivitas Keseluruhan</h3>
    <div id="logControlPanel">
      <select id="logFilterPeriod" style="padding:6px 8px;border-radius:8px;border:1px solid rgba(0,0,0,0.1);">
        <option value="">Semua</option><option value="today">Hari Ini</option><option value="week">Minggu Ini</option><option value="month">Bulan Ini</option>
      </select>
      <button id="downloadLogPDF" class="btn ghost">ðŸ“„ Download PDF</button>
      <span id="logCountInfo" style="margin-left:auto;font-size:13px;color:gray;"></span>
    </div>
    <div id="globalLogContent"></div>
    <div style="display:flex;gap:8px;margin-top:12px;justify-content:flex-end;">
      <button id="closeGlobalLog" class="btn">Tutup</button>
    </div>
  </div>
</div>
<div id="summaryPopup">
  <div>
    <h3 id="summaryTitle">Rincian</h3>
    <div id="summaryContent"></div>
    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
      <button id="exportSummaryBtn" class="btn ghost">Export Excel</button>
      <button id="closeSummaryBtn" class="btn">Tutup</button>
    </div>
  </div>
</div>

<div class="modal-backdrop" id="announcementModalBackdrop">
  <div class="modal" role="dialog" aria-modal="true">
    <h3 id="announcementModalTitle">Buat Pengumuman Baru</h3>
    <form id="announcementModalForm" onsubmit="return false;">
      
      <div>
        <label class="small">Judul Pengumuman</label>
        <input id="am_headline" type="text" required placeholder="Judul singkat, cth: Libur Nasional">
      </div>

      <div style="margin-top:10px">
        <label class="small">Isi Pengumuman (Mendukung format tebal, miring, link, list)</label>
        <textarea id="am_title" required placeholder="Tulis isi pengumuman di sini..."></textarea>
        <div class="small" style="margin-top:4px;">Catatan: Di halaman HRD, ini akan tampil sebagai Rich Text. Di sini, Anda bisa gunakan tag HTML dasar jika perlu (cth: &lt;b&gt;tebal&lt;/b&gt;).</div>
      </div>

      <div class="form-row" style="margin-top:10px">
        <div>
          <label class="small">Oleh (Author)</label>
          <input id="am_author" required readonly value="Admin (root)">
        </div>
        
        <div>
          <label class="small">Kategori</label>
          <select id="am_category" required>
            <option value="Umum">Umum</option>
            <option value="Penting">Penting</option>
            <option value="Event">Event</option>
            <option value="Peraturan">Peraturan</option>
          </select>
        </div>
      </div>
      
      <div style="margin-top:10px">
        <label class="small">Berlaku Sampai (Opsional)</label>
        <input id="am_expires" type="date">
        <div class="small" style="margin-top:4px;">Kosongkan jika ingin tampil selamanya.</div>
      </div>
      
      <div style="display:flex;gap:8px;justify-content:space-between;align-items:center;margin-top:12px">
        <div class="flex" style="background: var(--bg); padding: 8px 12px; border-radius: 8px;">
          <input id="am_isPinned" type="checkbox" style="width: 16px; height: 16px; margin-right: 8px; flex-shrink: 0;">
          <label for="am_isPinned" class="small" style="font-weight: 600; cursor: pointer; color: var(--text);">Sematkan Pengumuman</label>
        </div>
        <div style="display:flex;gap:8px;">
          <button id="announcementModalSave" class="btn">Publikasikan</button>
          <button id="announcementModalCancel" type="button" class="btn ghost">Batal</button>
        </div>
      </div>
    </form>
  </div>
</div>

<div class="modal-backdrop" id="announcementDetailModal">
  <div class="modal" role="dialog" aria-modal="true">
    <h3 id="annDetailTitle" style="margin-bottom: 8px;">Judul Detail Pengumuman</h3>
    <div id="annDetailMeta">
      </div>
    <div id="annDetailContent">
      </div>
    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:20px">
      <button id="annDetailClose" type="button" class="btn">Tutup</button>
    </div>
  </div>
</div>


<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// ===================================================================
// === (ADMIN) KONFIGURASI ===
// ===================================================================
const ADMIN_UID = "Ogy9lUbGHbSu8wYIYx2gQsTtFDF2";
const ADMIN_EMAIL = "root@zeppelin.center";
// ===================================================================

// === KONFIGURASI FIREBASE ===
const firebaseConfig = {
  apiKey: "AIzaSyA9wgSalrlTcveIZi2i-WND86z1i9JYHKw",
  authDomain: "it-support-53eeb.firebaseapp.com",
  databaseURL: "https://it-support-53eeb-default-rtdb.firebaseio.com",
  projectId: "it-support-53eeb",
  storageBucket: "it-support-53eeb.firebasestorage.app",
  messagingSenderId: "573924501146",
  appId: "1:573924501146:web:12f34306ed675472322123",
  measurementId: "G-33K6DDE1VR"
};

firebase.initializeApp(firebaseConfig);
const analytics = firebase.analytics();
const db = firebase.database();
const auth = firebase.auth();
const reportsRef = db.ref('reports'); 
const counterRef = db.ref('counter'); 
const announcementsRef = db.ref('announcements'); 
const usersRef = db.ref('users'); 
const groupChatsRef = db.ref('chats/group_chats'); 
const privateChatsRef = db.ref('chats/private_chats'); 

/* Cache & State */
let allReportsCache = []; 
let allAnnouncementsCache = []; 
let currentUser = null; 
let dbListenerActive = false; 

// === STATE CHAT NOTIFIKASI ===
let chatUnreadCounts = {}; 
let lastReadTimestamps = {};
let totalUnreadChat = 0;
const chatUnreadBadgeEl = document.getElementById('chatUnreadBadge');
const chatNotificationBtn = document.getElementById('chatNotificationBtn');


/* Utilities */
function nowString(){ return new Date().toLocaleString('id-ID', { dateStyle: 'short', timeStyle: 'medium' }); }
function isoNow(){ return new Date().toISOString(); }
function msToDuration(ms){ if(ms==null) return '-'; const s=Math.floor(ms/1000); const d=Math.floor(s/86400); const h=Math.floor((s%86400)/3600); const m=Math.floor((s%3600)/60); let p=[]; if(d) p.push(d+'d'); if(h) p.push(h+'h'); if(m||(!d&&!h)) p.push(m+'m'); return p.join(' '); }
function escapeHTML(str) {
    if (!str) return '';
    return str.replace(/[&<>"']/g, function(match) {
        return { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[match];
    });
}
function nl2br(str) {
    if (!str) return '';
    return str.replace(/(\r\n|\n\r|\r|\n)/g, '<br>');
}


function getReports(){ return allReportsCache; }

/* Render Dashboard (Full) */
function renderDashboard(){
  const all = getReports(); 
  document.getElementById('totalCount').textContent = all.length;
  const byStatus = {Open:0,Progress:0,Closed:0};
  const byCat = {Low:0,Normal:0,Critical:0};
  all.forEach(r=>{ 
    byStatus[r.status] = (byStatus[r.status]||0)+1; 
    byCat[r.kategori || 'Normal'] = (byCat[r.kategori || 'Normal']||0)+1; 
  });
  document.getElementById('openCount').textContent = byStatus.Open || 0;
  document.getElementById('progressCount').textContent = byStatus.Progress || 0;
  document.getElementById('closedCount').textContent = byStatus.Closed || 0;
  const cs = document.getElementById('categorySummary'); cs.innerHTML='';
  ['Low','Normal','Critical'].forEach(k=>{
    const count = byCat[k] || 0;
    const el = document.createElement('div');
    el.className = 'card summary-card';
    el.style.minWidth = '80px'; el.style.padding = '8px 12px';
    const idKey = k.toLowerCase() + 'Count';
    el.innerHTML = `<div class="small">${k}</div><div id="${idKey}" style="font-weight:800">${count}</div>`;
    cs.appendChild(el);
  });
  try { enableSummaryClicksNow(); } catch(e) {}
}

/* Sorting */
let currentSort = { key: 'created_iso', asc: false };
try{ const s = JSON.parse(sessionStorage.getItem('zeppelin_currentSort')||'null'); if(s) currentSort = s; }catch(e){}

/* Data Pipeline (Full) */
function getFilteredSortedData(){
  const data = getReports().slice(); 
  const search = (document.getElementById('searchInput').value||'').toLowerCase();
  const filterCat = document.getElementById('filterKategori').value;
  const period = document.getElementById('filterWaktu').value;
  const now = new Date();
  let start = null;
  if(period==='today'){ start = new Date(now); start.setHours(0,0,0,0); }
  else if(period==='week'){ start = new Date(now); start.setDate(now.getDate()-7); start.setHours(0,0,0,0); }
  else if(period==='month'){ start = new Date(now); start.setMonth(now.getMonth()-1); start.setHours(0,0,0,0); }
  const filtered = data.filter(d=>{
    const text = ((d.id||'')+' '+(d.nama||'')+' '+(d.jenis||'')+' '+(d.pic||'')+' '+(d.kategori||'')+' '+(d.status||'')+' '+(d.catatan||'')).toLowerCase();
    const matchSearch = !search || text.includes(search);
    const matchCat = !filterCat || d.kategori===filterCat;
    const createdDate = new Date(d.created_iso || d.created);
    const matchTime = !start || (createdDate >= start && createdDate <= now);
    return matchSearch && matchCat && matchTime;
  });
  // sorting
  if(currentSort && currentSort.key){
    const key = currentSort.key; const asc = !!currentSort.asc;
    filtered.sort((a,b)=>{
      let va = a[key]; let vb = b[key];
      if (key === 'created_iso' || key === 'updated_iso') { va = a[key] || 0; vb = b[key] || 0; } 
      else if (key === 'durationText') { va = a['durationMs'] || 0; vb = b['durationMs'] || 0; } 
      else if (key === 'id') { va = parseInt(String(va).split('-')[1] || 0); vb = parseInt(String(vb).split('-')[1] || 0); }
      if (va == null) va = ''; if (vb == null) vb = '';
      if (typeof va === 'number' && typeof vb === 'number') { return asc ? va - vb : vb - va; }
      return asc ? String(va).localeCompare(String(vb), undefined, {numeric: true}) : String(vb).localeCompare(String(va), undefined, {numeric: true});
    });
  } else {
    filtered.sort((a,b)=> new Date(b.created_iso||b.created) - new Date(a.created_iso||a.created));
  }
  return filtered;
}

/* Render Table */
let currentPage = 1;
function renderTable(page = 1){
  currentPage = page;
  const perPage = 10;
  const tbody = document.querySelector('#reportTable tbody');
  const filtered = getFilteredSortedData();
  const totalPages = Math.max(1, Math.ceil(filtered.length / perPage));
  if(page > totalPages) page = totalPages;
  const pageData = filtered.slice((page-1)*perPage, page*perPage);
  
  tbody.innerHTML = pageData.map(r=>{
    const statusClass = r.status==='Open'?'s-open':(r.status==='Progress'?'s-progress':'s-closed');
    const created = r.created || '-';
    const updated = r.updated || '-';
    const dur = r.durationText || '-';
    const catClass = (r.kategori || 'normal').toLowerCase(); 
    const cat = r.kategori ? `<span class="cat-badge cat-${catClass}">${r.kategori}</span>` : '...';
    const idText = r.urgent ? `ðŸ”¥ ${r.id}` : r.id;
    const action_buttons = `
        <button class="btn ghost" onclick="openModal('${r.id}')" style="padding: 4px 8px; font-size:12px;">Edit</button>
        <button class="btn ghost" onclick="deleteReport('${r.id}')" style="padding: 4px 8px; font-size:12px;">Hapus</button>
        <button class="btn ghost" onclick="showLog('${r.id}')" style="padding: 4px 8px; font-size:12px;">Log</button>
      `;
    return `<tr>
      <td>${idText}</td> <td>${r.pic || '...'}</td>
      <td>${r.nama}</td>
      <td>${r.jenis}</td>
      <td>${cat}</td>
      <td><span class="status ${statusClass}">${r.status}</span></td>
      <td>${created}</td>
      <td>${updated}</td>
      <td>${dur}</td>
      <td class="actions">${action_buttons}</td>
      <td>${(r.catatan||'').substring(0, 50)}${ (r.catatan||'').length > 50 ? '...' : ''}</td>
    </tr>`;
  }).join('');

  const pg = document.getElementById('pagination'); pg.innerHTML = '';
  for(let i=1;i<=totalPages;i++){
    const b = document.createElement('button'); b.textContent = i;
    if(i===page) b.classList.add('active');
    b.onclick = ()=> renderTable(i);
    pg.appendChild(b);
  }
  renderDashboard();
  updateSortIndicators();
}

/* Sorting UI */
function updateSortIndicators(){
  document.querySelectorAll('#reportTable th.sortable').forEach(th=>{
    const key = th.getAttribute('data-key');
    const ind = th.querySelector('.sort-ind');
    ind.textContent = '';
    if(currentSort.key === key){ ind.textContent = currentSort.asc ? 'â–²' : 'â–¼'; }
  });
}
function enableTableSorting(){
  document.querySelectorAll('#reportTable th.sortable').forEach((th)=>{
    th.addEventListener('click', ()=>{
      const key = th.getAttribute('data-key');
      if(currentSort.key === key) currentSort.asc = !currentSort.asc;
      else { currentSort.key = key; currentSort.asc = true; }
      try{ sessionStorage.setItem('zeppelin_currentSort', JSON.stringify(currentSort)); }catch(e){}
      renderTable(1);
    });
  });
}

/* (ADMIN) CRUD */
async function deleteReport(id){ 
  if(!confirm(`Yakin ingin menghapus laporan ${id}?`)) return;
  try {
    await reportsRef.child(id).remove(); 
    showToast('Laporan dihapus ðŸ—‘ï¸');
  } catch (err) {
    console.error("Gagal hapus:", err);
    alert("Gagal menghapus data: " + err.message);
  }
}

function showToast(txt, t = 3000, type = 'success') {
    const el = document.createElement('div');
    el.className = 'card';
    el.style.position = 'fixed';
    el.style.right = '18px';
    el.style.bottom = '18px';
    el.style.padding = '12px 16px';
    el.style.zIndex = 99999;
    
    if (type === 'danger') {
        el.style.background = 'var(--danger)';
    } else if (type === 'warning') {
        el.style.background = 'var(--warning)';
    } else {
        el.style.background = 'var(--primary)'; // Default
    }
    
    el.style.color = '#fff';
    el.style.fontWeight = '600';
    el.textContent = txt; 
    document.body.appendChild(el);
    setTimeout(() => el.remove(), t);
}


/* Generate ID */
async function generateId() {
  try {
    const result = await counterRef.transaction((currentValue) => (currentValue || 0) + 1);
    if (result.committed) {
      const nextId = result.snapshot.val();
      return 'ZP-' + String(nextId).padStart(4, '0');
    } else { throw new Error('Gagal mendapatkan ID baru (transaksi dibatalkan).'); }
  } catch (error) {
    console.error("Gagal generate ID:", error);
    alert("Error: Tidak bisa mendapatkan ID baru dari server. Coba lagi.");
    return null;
  }
}

/* Export to Excel */
function exportToExcel(){
  const data = getFilteredSortedData();
  if(!data.length){ alert('Tidak ada data untuk diekspor.'); return; }
  const rows = data.map(r=>({
    ID:r.id, PIC:r.pic, Nama:r.nama, JenisMasalah:r.jenis, Kategori:r.kategori||'-',
    Catatan:r.catatan||'-', Status:r.status, Dibuat:r.created||'-', Diperbarui:r.updated||'-',
    Durasi:r.durationText||'-', Urgent: r.urgent ? 'YA' : 'TIDAK' 
  }));
  const ws = XLSX.utils.json_to_sheet(rows);
  const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, 'Laporan');
  XLSX.writeFile(wb, `Laporan_Zeppelin_${new Date().toISOString().slice(0,10)}.xlsx`);
  showToast('Export selesai âœ…');
}

/* (ADMIN) Init */
(function init(){
  const backupBtn = document.getElementById('backupBtn');
  const restoreBtn = document.getElementById('restoreBtn');
  const restoreFile = document.getElementById('restoreFile');
  const dateTimeEl = document.getElementById('dateTime');
  const footerDate = document.getElementById('footerDate');
  footerDate.textContent = new Date().toLocaleDateString('id-ID', { year: 'numeric' });
  function updateTime(){ dateTimeEl.textContent = new Date().toLocaleString('id-ID', { weekday: 'long', day: 'numeric', month: 'short', hour: '2-digit', minute: '2-digit' }); }
  setInterval(updateTime,1000); updateTime();

  /* Backup */
  backupBtn.addEventListener('click', async ()=>{ 
    showToast('Mengambil data backup...');
    try {
      const snapshot = await reportsRef.once('value');
      const dataObj = snapshot.val();
      const dataArray = dataObj ? Object.values(dataObj) : []; 
      const dataString = JSON.stringify(dataArray, null, 2); 
      const blob = new Blob([dataString], {type:'application/json'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `backup_zeppelin_${new Date().toISOString().slice(0,10)}.json`;
      a.click();
      showToast('Backup tersimpan âœ…');
    } catch (err) {
      console.error("Backup failed:", err);
      alert('Gagal mengambil backup: ' + err.message);
    }
  });

  /* Restore */
  restoreBtn.addEventListener('click', ()=>restoreFile.click());
  restoreFile.addEventListener('change', (e)=>{ 
    const f = e.target.files[0]; if(!f) return; 
    const r = new FileReader(); 
    r.onload = async (ev) => { 
      try{ 
        const parsedArray = JSON.parse(ev.target.result); 
        if(!Array.isArray(parsedArray)) throw new Error('Format file bukan array.');
        showToast('Memulai restore...');
        const reportsObject = {};
        let maxIdNum = 0;
        parsedArray.forEach(item => {
          if (item.id) {
            reportsObject[item.id] = item;
            try {
              const idNum = parseInt(item.id.split('-')[1], 10);
              if (idNum > maxIdNum) maxIdNum = idNum;
            } catch(e) { /* abaikan */ }
          }
        });
        await reportsRef.set(reportsObject);
        await counterRef.set(maxIdNum);
        showToast('Restore berhasil âœ…'); 
      }catch(err){ 
        console.error("Restore failed:", err);
        alert('File restore tidak valid. Error: ' + err.message); 
      } 
    }; 
    r.readText(f); 
    restoreFile.value = '';
  });

  document.getElementById('newReportBtn').addEventListener('click', ()=>openModal(null));
  document.getElementById('exportCsv').addEventListener('click', exportToExcel);
  document.getElementById('searchInput').addEventListener('input', ()=>renderTable(1));
  document.getElementById('filterKategori').addEventListener('change', ()=>renderTable(1));
  document.getElementById('filterWaktu').addEventListener('change', ()=>renderTable(1));
  
  /* (ADMIN) KONTROL OTENTIKASI */
  const loginScreen = document.getElementById('loginScreen');
  const appContent = document.querySelector('.app-content');
  const userEmailDisplay = document.getElementById('userEmailDisplay');
  const authError = document.getElementById('authError');

  function showAuthError(msg) {
    authError.textContent = msg;
    authError.style.display = 'block';
  }

  // (ADMIN) Handle Login
  document.getElementById('loginBtn').addEventListener('click', async () => {
    const username = document.getElementById('loginUser').value;
    const pass = document.getElementById('loginPass').value;
    
    authError.style.display = 'none'; // Sembunyikan error lama
    if (username.toLowerCase() !== 'root' || pass !== 'adm123') {
      showAuthError("Username atau Password salah.");
      return;
    }

    try {
      await auth.signInWithEmailAndPassword(ADMIN_EMAIL, pass);
    } catch (err) {
      console.error("Login Gagal:", err);
      showAuthError("Login Gagal. Pastikan akun 'root@zeppelin.center' (pass: adm123) sudah ada & aktif.");
    }
  });
  
  // Handle Logout
  document.getElementById('logoutBtn').addEventListener('click', async () => {
    // Stop all listeners before signing out
    if (dbListenerActive) {
        reportsRef.off(); 
        announcementsRef.off(); 
        if (monitorChatListeners) {
            monitorChatListeners.forEach(off => off());
            monitorChatListeners = [];
        }
    }
    await auth.signOut();
  });

  /* LISTENER OTENTIKASI */
  auth.onAuthStateChanged((user) => {
    if (user) {
      if (user.uid !== ADMIN_UID) {
        showAuthError("AKUN INI BUKAN ADMIN.");
        auth.signOut(); 
        return;
      }
      
      currentUser = user;
      loginScreen.style.display = 'none'; 
      appContent.style.display = 'block'; 
      userEmailDisplay.textContent = `ADMIN (root)`;
      
      if (!dbListenerActive) {
        // Listener Laporan (Utama)
        reportsRef.on('value', (snapshot) => {
          const dataObj = snapshot.val();
          allReportsCache = dataObj ? Object.keys(dataObj).map(key => ({ ...dataObj[key], id: key })) : [];
          renderTable(currentPage);
          renderDashboard(); 
          renderCharts();
          console.log('Data admin (reports) dimuat dari Firebase.');
        }, (error) => {
          console.error("Firebase read (reports) failed:", error);
          alert("Gagal terhubung ke database laporan. Periksa koneksi atau rules.");
        });

        // Listener Notifikasi Urgent (child_changed)
        reportsRef.on('child_changed', (snapshot) => {
            const changedReport = snapshot.val();
            if (!changedReport) return;
            const oldReport = allReportsCache.find(r => r.id === changedReport.id);
            if (changedReport.urgent && (!oldReport || !oldReport.urgent)) {
                console.log(`Notifikasi Urgent: Tiket ${changedReport.id}`);
                showToast(`ðŸ”¥ URGENT: Tiket ${changedReport.id} (${changedReport.nama}) ditandai user!`, 5000, 'danger');
                if(oldReport) {
                    oldReport.urgent = true; 
                    renderTable(currentPage);
                }
            }
        });

        // Listener untuk data pengumuman
        announcementsRef.on('value', (snapshot) => {
            const dataObj = snapshot.val();
            allAnnouncementsCache = dataObj ? Object.keys(dataObj).map(key => ({ ...dataObj[key], key: key })) : [];
            renderAnnouncementsList(); 
            console.log('Data admin (announcements) dimuat dari Firebase.');
        }, (error) => {
            console.error("Firebase read (announcements) failed:", error);
        });
        
        // Mulai monitor chat notifikasi
        monitorAllChatsForNotifications();

        dbListenerActive = true;
      }
      
    } else {
      currentUser = null;
      loginScreen.style.display = 'flex'; 
      appContent.style.display = 'none'; 

      if (dbListenerActive) {
        reportsRef.off(); 
        announcementsRef.off(); 
        if (monitorChatListeners) {
            monitorChatListeners.forEach(off => off());
            monitorChatListeners = [];
        }
        dbListenerActive = false;
        allReportsCache = []; 
        allAnnouncementsCache = []; 
      }
    }
  });
  enableTableSorting();
  
  // (BARU) Event listener untuk modal detail (menggunakan event delegation)
  document.getElementById('announcementList').addEventListener('click', (e) => {
    const item = e.target.closest('.simple-announcement-item');
    if (item) {
      const key = item.dataset.key;
      openAnnouncementDetails(key);
    }
  });
  
  // (BARU) Listener untuk tombol tutup modal detail
  document.getElementById('annDetailClose').addEventListener('click', () => {
    document.getElementById('announcementDetailModal').style.display = 'none';
  });
  
})();

// ===================================================================
// === FUNGSI NOTIFIKASI CHAT (DUPLIKASI LOGIKA DARI CHATADM) ===
// ===================================================================

let monitorChatListeners = [];

function updateChatNotificationBadge() {
    let total = 0;
    Object.keys(chatUnreadCounts).forEach(key => {
        total += chatUnreadCounts[key];
    });
    totalUnreadChat = total;
    
    if (total > 0) {
        chatUnreadBadgeEl.textContent = total > 99 ? '99+' : total;
        chatUnreadBadgeEl.style.display = 'block';
    } else {
        chatUnreadBadgeEl.style.display = 'none';
    }
}

function monitorAllChatsForNotifications() {
    // Pastikan user sudah login
    if (!ADMIN_UID) return;
    
    const lastReadRef = usersRef.child(ADMIN_UID).child('lastRead');
    
    // 1. Ambil status terakhir dibaca Admin
    const unsubscribeLastRead = lastReadRef.on('value', (snapshot) => {
        lastReadTimestamps = snapshot.val() || {};
        // Perubahan lastRead memicu hitungan ulang badge global (meskipun chat listeners sudah melakukannya)
        updateChatNotificationBadge(); 
    });
    monitorChatListeners.push(() => lastReadRef.off('value', unsubscribeLastRead));

    // 2. Monitor semua grup chat
    const unsubscribeGroups = groupChatsRef.on('value', (groupSnapshot) => {
        if (groupSnapshot.exists()) {
            groupSnapshot.forEach(chatSnapshot => {
                const chatId = `group_${chatSnapshot.key}`;
                calculateUnread(chatId, chatSnapshot);
            });
        }
    });
    monitorChatListeners.push(() => groupChatsRef.off('value', unsubscribeGroups));
    
    // 3. Monitor semua private chat
    const unsubscribePrivate = privateChatsRef.on('value', (privateSnapshot) => {
         if (privateSnapshot.exists()) {
             privateSnapshot.forEach(chatSnapshot => {
                 const combinedId = chatSnapshot.key;
                 // Hanya monitor chat yang melibatkan Admin (Root)
                 if (combinedId.includes(ADMIN_UID)) { 
                     // ID chat untuk lastRead/UI adalah UID lawan
                     const targetUID = combinedId.split('_').find(uid => uid !== ADMIN_UID);
                     if (targetUID) {
                         calculateUnread(targetUID, chatSnapshot);
                     }
                 }
             });
         }
     });
     monitorChatListeners.push(() => privateChatsRef.off('value', unsubscribePrivate));
}


function calculateUnread(chatId, chatSnapshot) {
    let newUnreadCount = 0;
    
    // Ambil timestamp terakhir dibaca DARI STATE GLOBAL lastReadTimestamps
    const lastReadTimestamp = lastReadTimestamps[chatId] || 0;
    
    chatSnapshot.forEach(messageSnapshot => {
        const message = messageSnapshot.val();
        
        // Hitung pesan yang DITERIMA dan terjadi SETELAH lastRead
        if (message.senderId !== ADMIN_UID && message.timestamp > lastReadTimestamp) {
            newUnreadCount++;
        }
    });
    
    const oldUnreadCount = chatUnreadCounts[chatId] || 0;
    chatUnreadCounts[chatId] = newUnreadCount;
    
    // Hanya panggil update badge global jika hitungan berubah
    if (newUnreadCount !== oldUnreadCount) {
        updateChatNotificationBadge();
    }
}


// ===================================================================
// === END FUNGSI NOTIFIKASI CHAT ===
// ===================================================================


/* MODAL ADD/EDIT (Laporan) */
const modalBackdrop = document.getElementById('modalBackdrop');
const modalForm = document.getElementById('modalForm');
const modalTitle = document.getElementById('modalTitle');
let modalEditingId = null;

async function openModal(editId){
  modalBackdrop.style.display = 'flex';
  modalEditingId = editId || null;
  modalForm.reset(); 
  
  if(editId){
    modalTitle.textContent = `Edit Laporan (ID: ${editId})`;
    const item = getReports().find(r => r.id === editId);
    if (!item) {
        alert("Item tidak ditemukan");
        modalBackdrop.style.display='none';
        return;
    }
    document.getElementById('m_pic').value = item.pic || '';
    document.getElementById('m_nama').value = item.nama || ''; 
    document.getElementById('m_nama').readOnly = true; 
    document.getElementById('m_jenis').value = item.jenis || 'Jaringan';
    document.getElementById('m_kategori').value = item.kategori || 'Normal';
    document.getElementById('m_catatan').value = item.catatan || '';
    document.getElementById('m_status').value = item.status || 'Open';
    
    if (item.urgent) {
        try {
            await reportsRef.child(editId).update({ urgent: false });
            console.log(`Status urgent untuk ${editId} telah di-clear.`);
            item.urgent = false; 
            renderTable(currentPage); 
        } catch (err) {
            console.warn("Gagal clear status urgent:", err);
        }
    }
    
  } else {
    modalTitle.textContent = 'Tambah Laporan (Admin)';
    document.getElementById('m_status').value = 'Open';
    document.getElementById('m_kategori').value = 'Normal';
    document.getElementById('m_nama').readOnly = false;
  }
}

document.getElementById('modalCancel').addEventListener('click', ()=>{ modalBackdrop.style.display='none'; });

document.getElementById('modalSave').addEventListener('click', async (e)=>{
  e && e.preventDefault();
  
  if (!currentUser) { alert("Sesi Admin berakhir. Silakan login ulang."); return; }
  
  const pic = document.getElementById('m_pic').value;
  const nama = document.getElementById('m_nama').value;
  const jenis = document.getElementById('m_jenis').value;
  const kategori = document.getElementById('m_kategori').value;
  const catatan = document.getElementById('m_catatan').value;
  const statusVal = document.getElementById('m_status').value;
  
  if(!pic || !nama || !jenis || !kategori){ alert('PIC, Nama, Jenis, dan Kategori wajib diisi.'); return; }

  let id;
  const isNew = !modalEditingId;
  let oldEntry = {};
  let userUid; 

  if (isNew) {
    id = await generateId(); 
    if (!id) return; 
    userUid = currentUser.uid; // Dibuat oleh Admin (root)
  } else {
    id = modalEditingId;
    oldEntry = getReports().find(r => r.id === id) || {};
    userUid = oldEntry.uid || currentUser.uid; 
  }
  
  const createdExisting = oldEntry.created || nowString();
  const createdIsoExisting = oldEntry.created_iso || isoNow();
  let updatedVal = oldEntry.updated || null;
  let updatedIsoVal = oldEntry.updated_iso || null;
  
  if(statusVal === 'Closed' && oldEntry.status !== 'Closed'){
    updatedVal = nowString(); updatedIsoVal = isoNow();
  } else if ((statusVal !== oldEntry.status || pic !== oldEntry.pic || kategori !== oldEntry.kategori) && !isNew) {
    updatedVal = nowString(); updatedIsoVal = isoNow();
  }

  const entry = {
    id, pic, nama, jenis, kategori, catatan,
    status: statusVal,
    created: createdExisting, created_iso: createdIsoExisting,
    updated: updatedVal, updated_iso: updatedIsoVal,
    uid: userUid,
    urgent: oldEntry.urgent || false 
  };
  
  if(entry.updated_iso && entry.created_iso && entry.status === 'Closed'){
    const ms = new Date(entry.updated_iso).getTime() - new Date(entry.created_iso).getTime();
    entry.durationMs = ms >= 0 ? ms : 0; 
    entry.durationText = msToDuration(entry.durationMs);
  } else { 
    entry.durationMs = oldEntry.durationMs || null;
    entry.durationText = oldEntry.durationText || '-';
  }
  
  let logText = '';
  if (isNew) { logText = `Laporan dibuat (oleh Admin) dengan status ${entry.status}`; } 
  else {
    if(oldEntry.pic !== entry.pic) logText += `PIC: ${oldEntry.pic||'-'} â†’ ${entry.pic}. `;
    if(oldEntry.nama !== entry.nama) logText += `Nama: ${oldEntry.nama} â†’ ${entry.nama}. `;
    if(oldEntry.jenis !== entry.jenis) logText += `Jenis: ${oldEntry.jenis} â†’ ${entry.jenis}. `;
    if(oldEntry.kategori !== entry.kategori) logText += `Kategori: ${oldEntry.kategori||'-'} â†’ ${entry.kategori}. `;
    if(oldEntry.status !== entry.status) logText += `Status: ${oldEntry.status} â†’ ${entry.status}. `;
    if(oldEntry.catatan !== oldEntry.catatan) logText += `Catatan diubah. `;
  }

  try {
    if (isNew) {
        await reportsRef.child(id).set(entry);
    } else {
        await reportsRef.child(id).update(entry);
    }
    
    if(logText){ 
        await reportsRef.child(id).child('logs').push({
            time: nowString(), iso: isoNow(), detail: `Admin: ${logText.trim()}`
        });
    }

    if (isNew) { showToast('Laporan baru dibuat âœ…'); } 
    else { showToast('Update berhasil âœ…'); }
    modalBackdrop.style.display='none';
  } catch (err) {
    console.error("Gagal menyimpan:", err);
    alert("Gagal menyimpan data: " + err.message);
  }
});


/* Log Functions */
function showLog(id){
  const item = getReports().find(r=>r.id===id); 
  const popup = document.getElementById('logPopup');
  const content = document.getElementById('logContent');
  if(!item){ return; }
  
  const logs = item.logs ? Object.values(item.logs) : [];

  if(!logs.length) content.textContent = 'Belum ada perubahan tercatat.';
  else content.innerHTML = logs
    .sort((a,b) => new Date(b.iso || 0) - new Date(a.iso || 0)) 
    .map(l=>`ðŸ•’ <strong>${l.time}</strong>\n${l.detail}`)
    .join('\n---------------------------\n');
  popup.style.display = 'flex';
}
document.getElementById('closeLogPopup').addEventListener('click', ()=>document.getElementById('logPopup').style.display='none');
document.getElementById('logPopup').addEventListener('click', e=>{ if(e.target.id==='logPopup') e.currentTarget.style.display='none'; });

/* Global log */
(function(){
  function parseLogDate(l) {
    if (l && l.iso) { return new Date(l.iso); }
    if (l && l.time) { const d = Date.parse(l.time); if (!isNaN(d)) { return new Date(d); } }
    return new Date(0);
  }
  function getAllLogs(){
    const data = getReports(); 
    let allLogs = [];
    data.forEach(r=>{ 
        const logs = r.logs ? Object.values(r.logs) : [];
        logs.forEach(l=> allLogs.push({id:r.id,pic:r.pic,detail:l.detail,time:l.time,iso:l.iso})); 
    });
    return allLogs;
  }
  function filterLogsByPeriod(logs, period){
    if(!period) return logs;
    const now = new Date();
    let start = null;
    const end = new Date(now); end.setHours(23,59,59,999); 
    if(period === 'today'){ start = new Date(now); start.setHours(0,0,0,0); }
    else if(period === 'week'){ start = new Date(now); start.setDate(now.getDate() - 7); start.setHours(0,0,0,0); }
    else if(period === 'month'){ start = new Date(now); start.setMonth(now.getMonth() - 1); start.setHours(0,0,0,0); }
    if (start) { return logs.filter(l=>{ const dt = parseLogDate(l); return dt >= start && dt <= end; }); }
    return logs;
  }
  function renderGlobalLog(){
    const el = document.getElementById('globalLogContent');
    if(!el) return;
    const period = document.getElementById('logFilterPeriod')?.value || '';
    let allLogs = getAllLogs();
    allLogs = filterLogsByPeriod(allLogs, period);
    allLogs.sort((a,b)=> parseLogDate(b) - parseLogDate(a));
    const info = document.getElementById('logCountInfo');
    if(!allLogs.length){
      el.textContent = 'Belum ada aktivitas untuk periode ini.';
      if(info) info.textContent = `Menampilkan 0 aktivitas`;
      return;
    }
    el.innerHTML = allLogs.map(l=>`ðŸ•’ <strong>${l.time}</strong>\n[${l.id}] (${l.pic || 'N/A'}) â†’ ${l.detail}`).join('\n---------------------------\n');
    if(info) info.textContent = `Menampilkan ${allLogs.length} aktivitas`;
  }
  const showBtn = document.getElementById('showGlobalLog');
  const closeBtn = document.getElementById('closeGlobalLog');
  const popup = document.getElementById('globalLogPopup');
  const filterSelect = document.getElementById('logFilterPeriod');
  const downloadBtn = document.getElementById('downloadLogPDF');
  if(filterSelect) filterSelect.addEventListener('change', renderGlobalLog);
  if(showBtn){ showBtn.addEventListener('click', ()=>{ renderGlobalLog(); if(popup) popup.style.display = 'flex'; }); }
  if(closeBtn){ closeBtn.addEventListener('click', ()=>{ if(popup) popup.style.display='none'; }); }
  if(popup){ popup.addEventListener('click', e=>{ if(e.target.id==='globalLogPopup') popup.style.display='none'; }); }
  if(downloadBtn){
    downloadBtn.addEventListener('click', ()=>{
      const period = document.getElementById('logFilterPeriod')?.value || '';
      let logs = getAllLogs();
      logs = filterLogsByPeriod(logs, period);
      logs.sort((a,b)=> parseLogDate(b) - parseLogDate(a));
      if(!logs.length){ alert('Tidak ada data log untuk periode ini.'); return; }
      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF({ orientation:'portrait', unit:'pt', format:'a4' });
      pdf.setFontSize(14); pdf.text('Laporan Aktivitas IT Support â€” Zeppelin', 40, 40);
      pdf.setFontSize(10); pdf.text(`Periode: ${period || 'Semua'} | Dibuat: ${new Date().toLocaleString('id-ID')}`, 40, 56);
      pdf.setDrawColor(255,107,0); pdf.line(40, 70, 555, 70);
	    const rows = logs.map((l, i) => {
  		  const report = getReports().find(r => r.id === l.id);
  		  return [i + 1, l.time || '-', report?.nama || l.id, l.pic || '-', l.detail || '-'];
		  });
      pdf.autoTable({
        startY: 90, head: [['#', 'Waktu', 'User/ID', 'PIC', 'Aktivitas']], body: rows,
        styles: { fontSize: 9, cellPadding: 4, lineColor: [230, 230, 230], lineWidth: 0.5 },
        headStyles: { fillColor: [0, 123, 255], textColor: 255, halign: 'center' },
        alternateRowStyles: { fillColor: [248, 249, 250] }, margin: { left: 40, right: 40 },
      });
      const pageCount = pdf.internal.getNumberOfPages();
      for(let i=1;i<=pageCount;i++){
        pdf.setPage(i);
        pdf.setFontSize(9);
        pdf.text(`Halaman ${i} dari ${pageCount}`, 500, 820);
        pdf.text('Â© Zeppelin IT Support Dashboard', 40, 820);
      }
      pdf.save(`Log_Aktivitas_${period||'Semua'}_${new Date().toISOString().slice(0,10)}.pdf`);
    });
  }
})();

/* Charts */
function renderCharts(){
  const chartsDiv = document.getElementById('chartsArea');
  const all = getReports(); 
  const byCat = {Low:0,Normal:0,Critical:0};
  const byStatus = {Open:0,Progress:0,Closed:0};
  all.forEach(r=>{ 
    byCat[r.kategori || 'Normal'] = (byCat[r.kategori || 'Normal']||0)+1; 
    byStatus[r.status] = (byStatus[r.status]||0)+1; 
  });
  chartsDiv.innerHTML = `<div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;
    ${ (window.innerWidth < 768) ? 'grid-template-columns: 1fr;' : '' }">
    <div class="card"><h3>Distribusi Kategori</h3><canvas id="categoryChart"></canvas></div>
    <div class="card"><h3>Status Laporan</h3><canvas id="statusChart"></canvas></div>
  </div>`;
  const ctx1 = document.getElementById('categoryChart')?.getContext('2d');
  const ctx2 = document.getElementById('statusChart')?.getContext('2d');
  try{ window.myChart1 && window.myChart1.destroy(); window.myChart2 && window.myChart2.destroy(); }catch(e){}
  const catColors = ['#0284c7', '#d97706', '#dc2626'];
  const statColors = ['#b45309','#0284c7','#16a34a']; 
  if(ctx1){
    window.myChart1 = new Chart(ctx1, { 
      type: 'bar', data: { labels:['Low','Normal','Critical'], datasets:[{ data:[byCat.Low, byCat.Normal, byCat.Critical], backgroundColor: catColors, borderWidth: 0, borderRadius: 4, barThickness: 25 }] }, 
      options:{ indexAxis: 'y', responsive: true, plugins: { legend: { display: false } },
        scales: { x: { beginAtZero: true, grid: { display: false, drawBorder: false }, ticks: { stepSize: 1, callback: function(value) { if (Number.isInteger(value)) { return value; } } } }, y: { grid: { display: false } } }
      } 
    });
  }
  if(ctx2){
    window.myChart2 = new Chart(ctx2, { 
      type:'doughnut', data:{ labels:['Open','Progress','Closed'], datasets:[{ data:[byStatus.Open,byStatus.Progress,byStatus.Closed], backgroundColor: statColors, borderWidth: 0 }] }, 
      options:{ cutout:'65%', plugins:{ legend:{ position:'bottom', labels:{font:{weight:600}} } }, animation:{duration:600} } 
    });
  }
}

/* Summary popup */
function showSummary(type){
  const all = getReports(); 
  let filtered = [];
  if(type === 'Total') filtered = all;
  else if(type === 'Low' || type === 'Normal' || type === 'Critical'){ filtered = all.filter(r=>r.kategori === type); } 
  else { filtered = all.filter(r=>r.status === type); }
  const title = type==='Total' ? 'Semua Laporan' : 'Rincian ' + type;
  document.getElementById('summaryTitle').textContent = title;
  const content = document.getElementById('summaryContent');
  if(!filtered.length){ content.innerHTML = '<p class="small">Tidak ada data.</p>'; } 
  else {
    content.innerHTML = `<table style="width:100%;border-collapse:collapse;font-size:13px;"><thead><tr><th style="text-align:left;padding:8px">ID</th><th style="padding:8px">PIC</th><th style="padding:8px">Nama</th><th style="padding:8px">Jenis</th><th style="padding:8px">Kategori</th><th style="padding:8px">Status</th><th style="padding:8px">Dibuat</th></tr></thead><tbody>${
      filtered
        .sort((a,b) => new Date(b.created_iso) - new Date(a.created_iso))
        .map(r=>`<tr><td style="padding:8px">${r.id}</td><td style="padding:8px">${r.pic||'-'}</td><td style="padding:8px">${r.nama}</td><td style="padding:8px">${r.jenis}</td><td style="padding:8px">${r.kategori||'-'}</td><td style="padding:8px">${r.status}</td><td style="padding:8px">${r.created}</td></tr>`).join('')
    }</tbody></table>`;
  }
  document.getElementById('summaryPopup').style.display = 'flex';
  document.getElementById('exportSummaryBtn').onclick = function(){
    if(!filtered.length){ alert('Tidak ada data untuk diekspor.'); return; }
    const rows = filtered.map(r=>({ ID:r.id, PIC:r.pic, Nama:r.nama, Jenis:r.jenis, Kategori:r.kategori, Status:r.status, Dibuat:r.created }));
    const ws = XLSX.utils.json_to_sheet(rows);
    const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, `Rincian_${type}`);
    XLSX.writeFile(wb, `Rincian_${type}_${new Date().toISOString().slice(0,10)}.xlsx`);
  };
}
document.getElementById('closeSummaryBtn')?.addEventListener('click', ()=>{ document.getElementById('summaryPopup').style.display='none'; });
document.getElementById('summaryPopup')?.addEventListener('click', (e)=>{ if(e.target.id==='summaryPopup') e.currentTarget.style.display='none'; });
function enableSummaryClicksNow(){
  document.querySelectorAll('.summary-card').forEach(card=>{
    card.style.cursor = 'pointer';
    card.onclick = null; 
    card.addEventListener('click', ()=>{
      const labelEl = card.querySelector('.small');
      const label = labelEl ? labelEl.textContent.trim() : '';
      if(label === 'Total') showSummary('Total');
      else if(label === 'Open') showSummary('Open');
      else if(label === 'Progress') showSummary('Progress');
      else if(label === 'Closed') showSummary('Closed');
      else if(label === 'Low') showSummary('Low');
      else if(label === 'Normal') showSummary('Normal');
      else if(label === 'Critical') showSummary('Critical');
    });
  });
}
try{ enableSummaryClicksNow(); }catch(e){}


/* === (REWORK) FUNGSI CRUD PENGUMUMAN (v4 - Simple List + Popup) === */

const annModalBackdrop = document.getElementById('announcementModalBackdrop');
const annModalForm = document.getElementById('announcementModalForm');
const annModalTitle = document.getElementById('announcementModalTitle');
let annModalEditingId = null; 

// (REWORK) Render list pengumuman sederhana
function renderAnnouncementsList() {
    const listContainer = document.getElementById('announcementList');
    if (!listContainer) return;

    const now = new Date();
    const year = now.getFullYear();
    const month = String(now.getMonth() + 1).padStart(2, '0');
    const day = String(now.getDate()).padStart(2, '0');
    const todayStr = `${year}-${month}-${day}`;
    
    const activeAnnouncements = allAnnouncementsCache.filter(item => {
        if (item.expiresAt && item.expiresAt < todayStr) {
            return false; 
        }
        return true;
    });

    const sortedData = activeAnnouncements.sort((a, b) => {
        if (a.isPinned && !b.isPinned) return -1;
        if (!a.isPinned && b.isPinned) return 1;
        return (b.timestamp || 0) - (a.timestamp || 0); 
    });
    
    if (sortedData.length === 0) {
        listContainer.innerHTML = '<div style="text-align: center; color: var(--muted); padding: 20px 24px;">Belum ada pengumuman aktif.</div>';
        return;
    }

    // (REWORK) Render sebagai item list sederhana
    listContainer.innerHTML = sortedData.map(item => {
        const headline = escapeHTML(item.title) || '(Tanpa Judul)';
        
        let categoryClass = '';
        if (item.category === 'Penting') categoryClass = 'critical';
        else if (item.category === 'Event' || item.category === 'Peraturan') categoryClass = 'event';
        const categoryTag = item.category === 'Umum' ? '' : `<span class="category-tag ${categoryClass}">[${escapeHTML(item.category)}]</span>`;
        
        const pinTag = item.isPinned ? '<span class="pin-icon">ðŸ“Œ</span>' : '';

        return `
            <div class="simple-announcement-item" data-key="${item.key}">
                ${pinTag}
                ${categoryTag}
                <span class="title-text">${headline}</span>
            </div>
        `;
    }).join('');
}

// (BARU) Fungsi untuk membuka modal detail
function openAnnouncementDetails(key) {
    const item = allAnnouncementsCache.find(a => a.key === key);
    if (!item) return;
    
    const modal = document.getElementById('announcementDetailModal');
    
    // Isi Judul
    document.getElementById('annDetailTitle').textContent = item.title || '(Tanpa Judul)';
    
    // Isi Meta
    const time = item.timestamp ? new Date(item.timestamp).toLocaleString('id-ID', { dateStyle: 'long', timeStyle: 'short' }) : 'N/A';
    let metaHTML = `Oleh: <strong>${escapeHTML(item.author)}</strong><br>Diterbitkan: <strong>${time}</strong><br>Kategori: <strong>${escapeHTML(item.category)}</strong>`;
    if (item.expiresAt) {
        metaHTML += `<br><span style="color: var(--danger);">Berakhir: <strong>${item.expiresAt}</strong></span>`;
    }
    document.getElementById('annDetailMeta').innerHTML = metaHTML;
    
    // Isi Konten
    let contentHTML = item.content || '(Tidak ada isi)';
    if (!contentHTML.startsWith('<')) {
        contentHTML = nl2br(escapeHTML(contentHTML));
    }
    document.getElementById('annDetailContent').innerHTML = contentHTML;
    
    // Tampilkan Modal
    modal.style.display = 'flex';
}

// (C + U) Buka Modal Edit/Create
function openAnnouncementModal(editKey) {
    annModalEditingId = editKey || null;
    annModalForm.reset();
    
    if (editKey) {
        annModalTitle.textContent = 'Edit Pengumuman';
        const item = allAnnouncementsCache.find(a => a.key === editKey);
        if (item) {
            document.getElementById('am_headline').value = item.title || '';
            document.getElementById('am_title').value = item.content || ''; 
            document.getElementById('am_author').value = item.author || 'Admin (root)';
            document.getElementById('am_category').value = item.category || 'Umum';
            document.getElementById('am_isPinned').checked = item.isPinned || false;
            document.getElementById('am_expires').value = item.expiresAt || ''; 
        }
    } else {
        annModalTitle.textContent = 'Buat Pengumuman Baru';
        document.getElementById('am_author').value = 'Admin (root)'; 
        document.getElementById('am_category').value = 'Umum';
        document.getElementById('am_isPinned').checked = false;
        document.getElementById('am_expires').value = '';
    }
    
    annModalBackdrop.style.display = 'flex';
}

// (D) Hapus Pengumuman
async function deleteAnnouncement(key) {
    if (!key) return;
    if (!confirm('Yakin ingin menghapus pengumuman ini?')) return;
    
    try {
        await announcementsRef.child(key).remove();
        showToast('Pengumuman dihapus ðŸ—‘ï¸');
    } catch (err) {
        console.error("Gagal hapus pengumuman:", err);
        showToast('Gagal menghapus âŒ', 3000, 'danger');
    }
}

// Event Listeners untuk Modal Create/Edit
document.getElementById('newAnnouncementBtn').addEventListener('click', () => openAnnouncementModal(null));
document.getElementById('announcementModalCancel').addEventListener('click', () => {
    annModalBackdrop.style.display = 'none';
});

// (C + U) Simpan Pengumuman
document.getElementById('announcementModalSave').addEventListener('click', async () => {
    const title = document.getElementById('am_headline').value.trim();
    const content = document.getElementById('am_title').value.trim(); 
    const author = document.getElementById('am_author').value.trim();
    const category = document.getElementById('am_category').value;
    const isPinned = document.getElementById('am_isPinned').checked;
    const expiresAt = document.getElementById('am_expires').value; 

    if (!title || !content) {
        alert('Judul dan Isi Pengumuman tidak boleh kosong.');
        return;
    }

    // (MODIFIKASI) Struktur data tetap sama
    const data = {
        title: title,
        content: content, // Disimpan dari textarea
        author: author,
        category: category,
        isPinned: isPinned,
        expiresAt: expiresAt || null, 
        timestamp: firebase.database.ServerValue.TIMESTAMP 
    };

    try {
        if (annModalEditingId) {
            delete data.timestamp; 
            await announcementsRef.child(annModalEditingId).update(data);
            showToast('Pengumuman diperbarui âœ…');
        } else {
            await announcementsRef.push(data);
            showToast('Pengumuman dipublikasikan âœ…');
        }
        annModalBackdrop.style.display = 'none';
    } catch (err) {
        console.error("Gagal simpan pengumuman:", err);
        showToast('Gagal menyimpan âŒ', 3000, 'danger');
    }
});


// Expose functions to global
window.openModal = openModal;
window.deleteReport = deleteReport;
window.showLog = showLog;
window.openAnnouncementModal = openAnnouncementModal;
window.deleteAnnouncement = deleteAnnouncement;
window.openAnnouncementDetails = openAnnouncementDetails; // (BARU) Expose fungsi detail

</script>

</body>
</html>
