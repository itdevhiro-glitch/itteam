<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Zeppelin â€” Enterprise Command Center</title>
<link rel="icon" type="image/png" href="icov2.png" />

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400&display=swap" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.0/jspdf.plugin.autotable.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>

<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-analytics.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>

<style>
    :root {
        /* LIGHT THEME (Default) */
        --bg-body: #f8fafc;
        --bg-sidebar: #ffffff;
        --bg-card: #ffffff;
        --bg-hover: #f1f5f9;
        --border-color: #e2e8f0;
        
        --text-primary: #0f172a;
        --text-secondary: #64748b;
        --text-tertiary: #94a3b8;
        
        --primary: #2563eb;
        --primary-light: #eff6ff;
        --primary-dark: #1d4ed8;
        
        --success: #10b981;
        --warning: #f59e0b;
        --danger: #ef4444;
        --info: #06b6d4;

        --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
        --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1);
        --radius: 12px;
        --font-main: 'Inter', sans-serif;
    }

    [data-theme="dark"] {
        --bg-body: #0f172a;
        --bg-sidebar: #1e293b;
        --bg-card: #1e293b;
        --bg-hover: #334155;
        --border-color: #334155;
        
        --text-primary: #f8fafc;
        --text-secondary: #94a3b8;
        --text-tertiary: #64748b;

        --primary: #3b82f6;
        --primary-light: rgba(59, 130, 246, 0.1);
    }

    * { box-sizing: border-box; outline: none; }
    body { margin: 0; font-family: var(--font-main); background: var(--bg-body); color: var(--text-primary); transition: background 0.3s, color 0.3s; height: 100vh; overflow: hidden; }

    /* LAYOUT GRID */
    .app-layout {
        display: grid;
        grid-template-columns: 260px 1fr;
        grid-template-rows: 64px 1fr;
        height: 100vh;
        width: 100vw;
    }

    /* SIDEBAR */
    .sidebar {
        grid-row: 1 / -1;
        background: var(--bg-sidebar);
        border-right: 1px solid var(--border-color);
        display: flex; flex-direction: column;
        padding: 24px 16px;
        z-index: 50;
    }
    .brand {
        display: flex; align-items: center; gap: 12px;
        margin-bottom: 32px; padding: 0 12px;
    }
    .brand-icon {
        width: 36px; height: 36px;
        background: linear-gradient(135deg, var(--primary), #8b5cf6);
        border-radius: 8px; color: white;
        display: flex; align-items: center; justify-content: center;
        font-weight: 800; font-size: 18px;
    }
    .brand-text { font-size: 18px; font-weight: 700; letter-spacing: -0.5px; }
    
    .nav-menu { list-style: none; padding: 0; margin: 0; display: flex; flex-direction: column; gap: 4px; flex: 1; }
    .nav-item {
        display: flex; align-items: center; gap: 12px;
        padding: 10px 12px; border-radius: 8px;
        color: var(--text-secondary); font-weight: 500; font-size: 14px;
        cursor: pointer; transition: all 0.2s; text-decoration: none;
    }
    .nav-item:hover, .nav-item.active { background: var(--bg-hover); color: var(--text-primary); }
    .nav-item.active { background: var(--primary-light); color: var(--primary); font-weight: 600; }
    .nav-item i { font-size: 18px; }

    /* HEADER */
    .topbar {
        grid-column: 2;
        background: var(--bg-sidebar); /* Matches sidebar in dark mode */
        border-bottom: 1px solid var(--border-color);
        display: flex; align-items: center; justify-content: space-between;
        padding: 0 32px;
    }
    .search-box {
        position: relative; width: 400px;
    }
    .search-box input {
        width: 100%; padding: 10px 16px 10px 40px;
        border-radius: 99px; border: 1px solid var(--border-color);
        background: var(--bg-body); color: var(--text-primary);
        font-size: 14px; transition: all 0.2s;
    }
    .search-box input:focus { border-color: var(--primary); box-shadow: 0 0 0 3px var(--primary-light); }
    .search-box i { position: absolute; left: 14px; top: 50%; transform: translateY(-50%); color: var(--text-secondary); }

    .header-actions { display: flex; align-items: center; gap: 16px; }
    .icon-btn {
        width: 40px; height: 40px; border-radius: 50%;
        display: flex; align-items: center; justify-content: center;
        color: var(--text-secondary); cursor: pointer; position: relative;
        transition: background 0.2s; border: none; background: transparent;
    }
    .icon-btn:hover { background: var(--bg-hover); color: var(--text-primary); }
    .badge-dot {
        position: absolute; top: 8px; right: 8px;
        width: 8px; height: 8px; background: var(--danger);
        border-radius: 50%; border: 2px solid var(--bg-sidebar);
        display: none;
    }

    /* MAIN CONTENT */
    .main-content {
        grid-column: 2;
        background: var(--bg-body);
        padding: 32px;
        overflow-y: auto;
    }

    /* DASHBOARD WIDGETS */
    .stats-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 24px; margin-bottom: 32px; }
    .stat-card {
        background: var(--bg-card); padding: 24px; border-radius: var(--radius);
        border: 1px solid var(--border-color); box-shadow: var(--shadow-sm);
        display: flex; align-items: flex-start; justify-content: space-between;
        cursor: pointer; transition: transform 0.2s, box-shadow 0.2s;
    }
    .stat-card:hover { transform: translateY(-4px); box-shadow: var(--shadow-md); border-color: var(--primary); }
    .stat-info h4 { margin: 0; font-size: 14px; color: var(--text-secondary); font-weight: 500; }
    .stat-info h2 { margin: 8px 0 0; font-size: 28px; color: var(--text-primary); font-weight: 700; }
    .stat-icon {
        width: 48px; height: 48px; border-radius: 12px;
        background: var(--primary-light); color: var(--primary);
        display: flex; align-items: center; justify-content: center; font-size: 24px;
    }
    .stat-card.overdue .stat-icon { background: #fee2e2; color: var(--danger); }

    /* VIEW TOGGLE & FILTERS */
    .view-controls { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; flex-wrap: wrap; gap: 16px; }
    .btn-group { display: flex; background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 8px; padding: 2px; }
    .btn-toggle {
        padding: 8px 12px; border: none; background: transparent;
        color: var(--text-secondary); cursor: pointer; border-radius: 6px; font-weight: 500; font-size: 13px; display: flex; gap: 6px; align-items: center;
    }
    .btn-toggle.active { background: var(--bg-hover); color: var(--text-primary); font-weight: 600; shadow: var(--shadow-sm); }

    /* TABLE STYLES */
    .table-responsive {
        background: var(--bg-card); border-radius: var(--radius);
        border: 1px solid var(--border-color); overflow: hidden;
    }
    table { width: 100%; border-collapse: collapse; }
    th {
        background: var(--bg-hover); color: var(--text-secondary);
        font-size: 12px; text-transform: uppercase; letter-spacing: 0.05em;
        padding: 16px 24px; text-align: left; font-weight: 600;
    }
    td { padding: 16px 24px; border-bottom: 1px solid var(--border-color); font-size: 14px; vertical-align: middle; }
    tr:last-child td { border-bottom: none; }
    tr:hover td { background: var(--bg-hover); }

    /* KANBAN BOARD STYLES */
    .kanban-board {
        display: grid; grid-template-columns: repeat(3, 1fr); gap: 24px;
        align-items: start; height: 100%; overflow-x: auto;
    }
    .kanban-col {
        background: var(--bg-hover); border-radius: var(--radius);
        padding: 16px; min-height: 200px;
    }
    .kanban-header {
        display: flex; justify-content: space-between; align-items: center;
        margin-bottom: 16px; padding: 0 4px;
    }
    .kanban-header h3 { margin: 0; font-size: 14px; font-weight: 700; text-transform: uppercase; color: var(--text-secondary); }
    .kanban-count { background: var(--border-color); padding: 2px 8px; border-radius: 12px; font-size: 12px; }
    
    .kanban-card {
        background: var(--bg-card); padding: 16px; border-radius: 8px;
        margin-bottom: 12px; box-shadow: var(--shadow-sm); border: 1px solid var(--border-color);
        cursor: grab; transition: transform 0.2s;
    }
    .kanban-card:hover { transform: translateY(-2px); box-shadow: var(--shadow-md); border-color: var(--primary); }
    .k-card-top { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 12px; color: var(--text-tertiary); }
    .k-card-title { font-weight: 600; margin-bottom: 8px; font-size: 14px; line-height: 1.4; }
    .k-card-footer { display: flex; justify-content: space-between; align-items: center; margin-top: 12px; }

    /* TAGS & BADGES */
    .badge { padding: 4px 10px; border-radius: 99px; font-size: 11px; font-weight: 700; display: inline-flex; align-items: center; gap: 4px; }
    .status-Open { background: #fff7ed; color: #c2410c; border: 1px solid #ffedd5; }
    .status-Progress { background: #eff6ff; color: #1d4ed8; border: 1px solid #dbeafe; }
    .status-Closed { background: #f0fdf4; color: #15803d; border: 1px solid #dcfce7; }
    
    .cat-Low { color: var(--info); background: rgba(6, 182, 212, 0.1); }
    .cat-Normal { color: var(--warning); background: rgba(245, 158, 11, 0.1); }
    .cat-Critical { color: var(--danger); background: rgba(239, 68, 68, 0.1); }

    /* BUTTONS */
    .btn {
        display: inline-flex; align-items: center; gap: 8px;
        padding: 10px 20px; border-radius: 8px; font-weight: 600; font-size: 14px;
        cursor: pointer; border: none; transition: all 0.2s;
        background: var(--primary); color: white;
    }
    .btn:hover { background: var(--primary-dark); transform: translateY(-1px); }
    .btn-outline { background: transparent; border: 1px solid var(--border-color); color: var(--text-secondary); }
    .btn-outline:hover { border-color: var(--text-primary); color: var(--text-primary); }
    .btn-danger { background: var(--danger); color: white; }

    /* MODAL */
    .modal-overlay {
        position: fixed; inset: 0; background: rgba(0,0,0,0.5);
        backdrop-filter: blur(4px); z-index: 1000;
        display: none; align-items: center; justify-content: center;
    }
    .modal-content {
        background: var(--bg-card); width: 100%; max-width: 600px;
        padding: 32px; border-radius: 16px; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1);
        animation: slideUp 0.3s ease;
    }
    @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

    /* LOGIN SCREEN */
    #loginScreen {
        position: fixed; inset: 0; background: var(--bg-body); z-index: 9999;
        display: flex; align-items: center; justify-content: center;
    }
    .login-card {
        background: var(--bg-card); padding: 48px; border-radius: 24px;
        box-shadow: 0 25px 50px -12px rgba(0,0,0,0.1); width: 400px;
        border: 1px solid var(--border-color); text-align: center;
    }

    /* UTILS & RESPONSIVE */
    .hidden { display: none !important; }
    .flex-col { display: flex; flex-direction: column; gap: 4px; }
    
    @media (max-width: 1024px) {
        .app-layout { grid-template-columns: 1fr; grid-template-rows: 64px 1fr; }
        .sidebar { display: none; position: fixed; height: 100%; width: 260px; box-shadow: 0 0 20px rgba(0,0,0,0.1); }
        .sidebar.open { display: flex; }
        .topbar { grid-column: 1; padding: 0 16px; }
        .main-content { grid-column: 1; padding: 16px; }
        #mobileMenuBtn { display: block !important; }
        .search-box { display: none; }
        .kanban-board { grid-template-columns: 1fr; gap: 16px; }
    }
    #mobileMenuBtn { display: none; font-size: 24px; color: var(--text-primary); cursor: pointer; }

    /* SLA Timer */
    .sla-progress { height: 4px; background: var(--border-color); border-radius: 2px; margin-top: 8px; overflow: hidden; }
    .sla-bar { height: 100%; background: var(--success); transition: width 0.3s; }
    .overdue .sla-bar { background: var(--danger); }
</style>
</head>
<body data-theme="light">

<div id="loginScreen">
    <div class="login-card">
        <div class="brand-icon" style="width:56px; height:56px; font-size:24px; margin:0 auto 24px;">Z</div>
        <h2 style="margin-bottom:8px;">Zeppelin Enterprise</h2>
        <p style="color:var(--text-secondary); font-size:14px; margin-bottom:32px;">Secure Admin Access Point</p>
        
        <div style="text-align:left; margin-bottom:16px;">
            <label style="font-size:12px; font-weight:600; color:var(--text-secondary);">USERNAME</label>
            <input id="loginUser" type="text" placeholder="root" style="width:100%; padding:12px; border-radius:8px; border:1px solid var(--border-color); background:var(--bg-body); margin-top:4px; color:var(--text-primary);">
        </div>
        <div style="text-align:left; margin-bottom:24px;">
            <label style="font-size:12px; font-weight:600; color:var(--text-secondary);">PASSWORD</label>
            <input id="loginPass" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢" style="width:100%; padding:12px; border-radius:8px; border:1px solid var(--border-color); background:var(--bg-body); margin-top:4px; color:var(--text-primary);">
        </div>
        <button id="loginBtn" class="btn" style="width:100%; justify-content:center; padding:14px;">Masuk Dashboard</button>
        <p id="authError" style="color:var(--danger); font-size:13px; margin-top:16px; display:none;"></p>
    </div>
</div>

<div class="app-layout hidden" id="appInterface">
    <aside class="sidebar" id="sidebar">
        <div class="brand">
            <div class="brand-icon">Z</div>
            <div class="brand-text">Zeppelin<span style="color:var(--primary);">.io</span></div>
        </div>
        
        <ul class="nav-menu">
            <li class="nav-item active" onclick="switchTab('dashboard')">
                <i class="ri-dashboard-line"></i> Dashboard
            </li>
            <li class="nav-item" onclick="switchTab('tickets')">
                <i class="ri-ticket-line"></i> Tiket & Insiden
            </li>
            <li class="nav-item" onclick="switchTab('users')">
                <i class="ri-group-line"></i> User Management
            </li>
            <li class="nav-item" onclick="switchTab('requests')">
                <i class="ri-macbook-line"></i> Permintaan Aset
            </li>
        </ul>

        <div style="margin-top:auto; padding-top:24px; border-top:1px solid var(--border-color);">
            <div class="nav-item text-danger" id="logoutBtn">
                <i class="ri-logout-box-line"></i> Sign Out
            </div>
            <div style="font-size:11px; color:var(--text-tertiary); margin-top:16px; text-align:center;">
                v3.0.1 Stable
            </div>
        </div>
    </aside>

    <header class="topbar">
        <div style="display:flex; align-items:center; gap:16px;">
            <i class="ri-menu-2-line" id="mobileMenuBtn"></i>
            <div class="search-box">
                <i class="ri-search-line"></i>
                <input type="text" id="globalSearch" placeholder="Cari tiket, user, atau aset (Cmd + K)...">
            </div>
        </div>

        <div class="header-actions">
            <button class="icon-btn" id="themeToggle" title="Ganti Tema">
                <i class="ri-moon-line"></i>
            </button>
            
            <a href="chatadm.html" class="icon-btn" title="Pesan Masuk">
                <i class="ri-message-3-line"></i>
                <span class="badge-dot" id="chatBadge"></span>
            </a>

            <div style="height:24px; width:1px; background:var(--border-color);"></div>
            <button class="icon-btn" id="backupBtn" title="Backup Data"><i class="ri-download-cloud-2-line"></i></button>
            <input id="restoreFile" type="file" hidden accept=".json">
            <button class="icon-btn" id="restoreBtn" title="Restore Data"><i class="ri-upload-cloud-2-line"></i></button>
            
            <div style="width:36px; height:36px; background:var(--primary); color:white; border-radius:50%; display:flex; align-items:center; justify-content:center; font-weight:700; font-size:14px;">A</div>
        </div>
    </header>

    <main class="main-content">
        
        <div id="view-dashboard">
            <h1 style="font-size:24px; font-weight:700; margin-bottom:24px;">Command Center</h1>
            
            <div class="stats-row">
                <div class="stat-card" onclick="filterByStat('All')">
                    <div class="stat-info">
                        <h4>Total Tiket</h4>
                        <h2 id="statTotal">0</h2>
                    </div>
                    <div class="stat-icon"><i class="ri-folder-open-line"></i></div>
                </div>
                <div class="stat-card" onclick="filterByStat('Open')">
                    <div class="stat-info">
                        <h4>Open (Action Needed)</h4>
                        <h2 id="statOpen" style="color:var(--warning)">0</h2>
                    </div>
                    <div class="stat-icon" style="background:#fffbeb; color:var(--warning)"><i class="ri-loader-2-line"></i></div>
                </div>
                <div class="stat-card" onclick="filterByStat('Closed')">
                    <div class="stat-info">
                        <h4>Selesai Bulan Ini</h4>
                        <h2 id="statClosed" style="color:var(--success)">0</h2>
                    </div>
                    <div class="stat-icon" style="background:#ecfdf5; color:var(--success)"><i class="ri-check-double-line"></i></div>
                </div>
                <div class="stat-card overdue" onclick="filterByStat('Overdue')">
                    <div class="stat-info">
                        <h4 style="color:var(--danger)">SLA Overdue</h4>
                        <h2 id="statOverdue" style="color:var(--danger)">0</h2>
                    </div>
                    <div class="stat-icon"><i class="ri-alarm-warning-line"></i></div>
                </div>
            </div>

            <div style="display:grid; grid-template-columns: 2fr 1fr; gap:24px;">
                <div style="background:var(--bg-card); padding:24px; border-radius:var(--radius); border:1px solid var(--border-color);">
                    <div style="display:flex; justify-content:space-between; margin-bottom:16px;">
                        <h3 style="font-size:16px; font-weight:600;">Analitik Kinerja</h3>
                        <select style="border:none; background:transparent; font-size:12px; color:var(--text-secondary);"><option>7 Hari Terakhir</option></select>
                    </div>
                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:16px;">
                        <canvas id="chartCategory" height="150"></canvas>
                        <canvas id="chartSLA" height="150"></canvas>
                    </div>
                </div>

                <div style="background:var(--bg-card); padding:24px; border-radius:var(--radius); border:1px solid var(--border-color); display:flex; flex-direction:column;">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
                        <h3 style="font-size:16px; font-weight:600;">ðŸ“¢ Pengumuman</h3>
                        <button class="btn-toggle" onclick="openAnnModal(null)"><i class="ri-add-line"></i> Baru</button>
                    </div>
                    <div id="announcementFeed" style="flex:1; overflow-y:auto; max-height:300px; display:flex; flex-direction:column; gap:12px;">
                        </div>
                </div>
            </div>
        </div>

        <div id="view-tickets" class="hidden">
            <div class="view-controls">
                <div>
                    <h1 style="font-size:24px; font-weight:700;">Manajemen Tiket</h1>
                    <p style="color:var(--text-secondary); font-size:14px;">Pantau dan selesaikan laporan user.</p>
                </div>
                <div style="display:flex; gap:12px;">
                    <div class="btn-group">
                        <button class="btn-toggle active" id="btnList" onclick="toggleViewMode('list')"><i class="ri-list-check"></i> List</button>
                        <button class="btn-toggle" id="btnKanban" onclick="toggleViewMode('kanban')"><i class="ri-kanban-view"></i> Board</button>
                    </div>
                    <button class="btn" onclick="openReportModal(null)"><i class="ri-add-line"></i> Tiket Baru</button>
                    <button class="btn btn-outline" onclick="toggleTrash()"><i class="ri-delete-bin-line"></i></button>
                </div>
            </div>
            
            <div style="display:flex; gap:12px; margin-bottom:16px; flex-wrap:wrap;">
                <select id="filterCat" class="btn-outline" style="padding:8px; border-radius:8px;">
                    <option value="">Semua Kategori</option>
                    <option value="Low">Low</option>
                    <option value="Normal">Normal</option>
                    <option value="Critical">Critical</option>
                </select>
                <input type="text" id="ticketSearch" placeholder="Filter..." style="padding:8px 12px; border-radius:8px; border:1px solid var(--border-color); background:var(--bg-card); color:var(--text-primary);">
            </div>

            <div id="cont-list" class="table-responsive">
                <table id="reportTable">
                    <thead>
                        <tr>
                            <th>ID & User</th>
                            <th>Subjek Masalah</th>
                            <th>Status & SLA</th>
                            <th>PIC</th>
                            <th>Updated</th>
                            <th style="text-align:right">Aksi</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>

            <div id="cont-kanban" class="hidden" style="height:calc(100vh - 200px);">
                <div class="kanban-board">
                    <div class="kanban-col">
                        <div class="kanban-header">
                            <h3>Open / Baru</h3>
                            <span class="kanban-count" id="countOpen">0</span>
                        </div>
                        <div id="kb-Open"></div>
                    </div>
                    <div class="kanban-col">
                        <div class="kanban-header">
                            <h3>In Progress</h3>
                            <span class="kanban-count" id="countProgress">0</span>
                        </div>
                        <div id="kb-Progress"></div>
                    </div>
                    <div class="kanban-col">
                        <div class="kanban-header">
                            <h3>Closed / Selesai</h3>
                            <span class="kanban-count" id="countClosed">0</span>
                        </div>
                        <div id="kb-Closed"></div>
                    </div>
                </div>
            </div>
        </div>

        <div id="view-users" class="hidden">
            <h1>User Management</h1>
            <p>Silakan akses modul lengkap di <a href="usermanagement.html" style="color:var(--primary)">Halaman User Management</a>.</p>
        </div>
        <div id="view-requests" class="hidden">
            <h1>Permintaan Aset</h1>
            <p>Silakan akses modul lengkap di <a href="permintaanadmin.html" style="color:var(--primary)">Halaman Permintaan</a>.</p>
        </div>

    </main>
</div>

<div class="modal-overlay" id="modalTicket">
    <div class="modal-content">
        <h2 style="margin-top:0;">Detail Tiket</h2>
        <form id="formTicket" onsubmit="return false;">
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:16px; margin-bottom:16px;">
                <div>
                    <label style="font-size:12px; font-weight:600;">Pelapor</label>
                    <input id="t_nama" class="btn-outline" style="width:100%; padding:10px; border-radius:8px; margin-top:4px;" required placeholder="Nama User">
                </div>
                <div>
                    <label style="font-size:12px; font-weight:600;">PIC Teknisi</label>
                    <input id="t_pic" class="btn-outline" style="width:100%; padding:10px; border-radius:8px; margin-top:4px;" required placeholder="Nama Anda">
                </div>
            </div>
            
            <div style="margin-bottom:16px;">
                <label style="font-size:12px; font-weight:600;">Jenis & Kategori</label>
                <div style="display:flex; gap:12px; margin-top:4px;">
                    <select id="t_jenis" style="flex:1; padding:10px; border-radius:8px; border:1px solid var(--border-color); background:var(--bg-body); color:var(--text-primary);">
                        <option>Jaringan</option><option>Hardware</option><option>Software</option><option>Akun</option>
                    </select>
                    <select id="t_kategori" style="flex:1; padding:10px; border-radius:8px; border:1px solid var(--border-color); background:var(--bg-body); color:var(--text-primary);">
                        <option value="Low">Low (48h)</option>
                        <option value="Normal">Normal (24h)</option>
                        <option value="Critical">Critical (4h)</option>
                    </select>
                </div>
            </div>

            <div style="margin-bottom:16px;">
                <label style="font-size:12px; font-weight:600;">Catatan Publik (Dilihat User)</label>
                <textarea id="t_note" rows="3" style="width:100%; padding:10px; border-radius:8px; border:1px solid var(--border-color); background:var(--bg-body); margin-top:4px; color:var(--text-primary);"></textarea>
            </div>

            <div style="margin-bottom:24px;">
                <label style="font-size:12px; font-weight:600; color:var(--primary);">ðŸ”’ Catatan Internal (Admin Only)</label>
                <textarea id="t_internal" rows="3" style="width:100%; padding:10px; border-radius:8px; border:1px solid var(--border-color); background:var(--bg-hover); margin-top:4px; color:var(--text-primary);"></textarea>
            </div>

            <div style="display:flex; justify-content:space-between; align-items:center;">
                <select id="t_status" style="padding:10px; border-radius:8px; font-weight:600; border:2px solid var(--border-color);">
                    <option value="Open">Status: Open</option>
                    <option value="Progress">Status: Progress</option>
                    <option value="Closed">Status: Closed</option>
                </select>
                <div style="display:flex; gap:12px;">
                    <button class="btn btn-outline" onclick="closeModal('modalTicket')">Batal</button>
                    <button class="btn" onclick="saveTicket()">Simpan</button>
                </div>
            </div>
        </form>
    </div>
</div>

<div class="modal-overlay" id="modalAnn">
    <div class="modal-content">
        <h2 style="margin-top:0;">Buat Pengumuman</h2>
        <input id="a_title" placeholder="Judul Pengumuman" style="width:100%; padding:12px; font-weight:700; border:1px solid var(--border-color); border-radius:8px; margin-bottom:12px;">
        <textarea id="a_content" rows="5" placeholder="Isi pengumuman..." style="width:100%; padding:12px; border:1px solid var(--border-color); border-radius:8px; margin-bottom:12px; font-family:inherit;"></textarea>
        
        <div style="display:flex; gap:12px; margin-bottom:24px;">
            <select id="a_cat" style="padding:10px; border-radius:8px;">
                <option value="Umum">Umum</option>
                <option value="Penting">Penting</option>
                <option value="Event">Event</option>
            </select>
            <label style="display:flex; align-items:center; gap:8px; cursor:pointer;">
                <input type="checkbox" id="a_pin"> Sematkan (Pin)
            </label>
        </div>
        
        <div style="display:flex; justify-content:flex-end; gap:12px;">
            <button class="btn btn-outline" onclick="closeModal('modalAnn')">Batal</button>
            <button class="btn" onclick="saveAnnouncement()">Publikasikan</button>
        </div>
    </div>
</div>

<div id="toast" style="position:fixed; bottom:-100px; left:50%; transform:translateX(-50%); background:var(--text-primary); color:var(--bg-body); padding:12px 24px; border-radius:50px; font-weight:600; transition:all 0.3s; z-index:99999; box-shadow:var(--shadow-md);">
    Notification
</div>

<script>
    // === CONFIGURATION ===
    const ADMIN_UID = "Ogy9lUbGHbSu8wYIYx2gQsTtFDF2";
    const ADMIN_EMAIL = "root@zeppelin.center";
    const firebaseConfig = {
        apiKey: "AIzaSyA9wgSalrlTcveIZi2i-WND86z1i9JYHKw",
        authDomain: "it-support-53eeb.firebaseapp.com",
        databaseURL: "https://it-support-53eeb-default-rtdb.firebaseio.com",
        projectId: "it-support-53eeb",
        storageBucket: "it-support-53eeb.firebasestorage.app",
        messagingSenderId: "573924501146",
        appId: "1:573924501146:web:12f34306ed675472322123",
        measurementId: "G-33K6DDE1VR"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const auth = firebase.auth();
    const SLA_HOURS = { Low: 48, Normal: 24, Critical: 4 };

    // === STATE ===
    let reports = [];
    let announcements = [];
    let isTrashMode = false;
    let editingId = null;

    // === UTILS ===
    const $ = (sel) => document.querySelector(sel);
    const showToast = (msg) => {
        const t = $('#toast'); t.textContent = msg; t.style.bottom = "32px";
        setTimeout(() => t.style.bottom = "-100px", 3000);
    };
    const nowISO = () => new Date().toISOString();

    // === AUTH & INIT ===
    auth.onAuthStateChanged(user => {
        if (user && user.uid === ADMIN_UID) {
            $('#loginScreen').classList.add('hidden');
            $('#appInterface').classList.remove('hidden');
            initApp();
        } else {
            $('#loginScreen').classList.remove('hidden');
            $('#appInterface').classList.add('hidden');
        }
    });

    $('#loginBtn').onclick = async () => {
        const u = $('#loginUser').value; const p = $('#loginPass').value;
        if (u !== 'root' || p !== 'adm123') return $('#authError').textContent = "Invalid Credentials";
        try { await auth.signInWithEmailAndPassword(ADMIN_EMAIL, p); } 
        catch (e) { $('#authError').textContent = e.message; $('#authError').style.display = 'block'; }
    };
    $('#logoutBtn').onclick = () => auth.signOut();

    function initApp() {
        // Theme
        const theme = localStorage.getItem('theme') || 'light';
        document.body.setAttribute('data-theme', theme);
        $('#themeToggle').onclick = () => {
            const newTheme = document.body.getAttribute('data-theme') === 'light' ? 'dark' : 'light';
            document.body.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
        };

        // Mobile Menu
        $('#mobileMenuBtn').onclick = () => $('#sidebar').classList.toggle('open');

        // Listeners
        db.ref('reports').on('value', snap => {
            const val = snap.val();
            reports = val ? Object.keys(val).map(k => ({...val[k], id: k})) : [];
            renderAll();
        });

        db.ref('announcements').on('value', snap => {
            const val = snap.val();
            announcements = val ? Object.keys(val).map(k => ({...val[k], key: k})) : [];
            renderAnnouncements();
        });

        // Chat Badge (Simulated for this snippet)
        db.ref('chats/private_chats').on('value', snap => {
            let unread = 0; // Simplified logic
            if(snap.exists()) unread = 1; // Dummy indicator logic if any chat exists
            $('#chatBadge').style.display = unread ? 'block' : 'none';
        });

        // Backup
        $('#backupBtn').onclick = () => {
            const blob = new Blob([JSON.stringify(reports)], {type:'application/json'});
            const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'backup.json'; a.click();
        };
        $('#restoreBtn').onclick = () => $('#restoreFile').click();
        $('#restoreFile').onchange = (e) => {
            const r = new FileReader();
            r.onload = async (ev) => {
                const data = JSON.parse(ev.target.result);
                const map = {}; data.forEach(x => map[x.id] = x);
                await db.ref('reports').update(map);
                showToast("Restore Successful");
            };
            r.readText(e.target.files[0]);
        };
    }

    // === RENDERING CORE ===
    function renderAll() {
        renderStats();
        renderTable();
        renderKanban();
        renderCharts();
    }

    function renderStats() {
        const active = reports.filter(r => !r.isDeleted);
        $('#statTotal').textContent = active.length;
        $('#statOpen').textContent = active.filter(r => r.status === 'Open').length;
        $('#statClosed').textContent = active.filter(r => r.status === 'Closed').length;
        
        const now = Date.now();
        const overdue = active.filter(r => {
            if(r.status === 'Closed') return false;
            const limit = new Date(r.created_iso).getTime() + (SLA_HOURS[r.kategori]*3600000);
            return now > limit;
        }).length;
        $('#statOverdue').textContent = overdue;
    }

    function renderTable() {
        const tbody = $('#reportTable tbody');
        tbody.innerHTML = '';
        const search = ($('#ticketSearch').value || $('#globalSearch').value).toLowerCase();
        
        const filtered = reports.filter(r => {
            if(isTrashMode) return r.isDeleted;
            if(r.isDeleted) return false;
            return JSON.stringify(r).toLowerCase().includes(search);
        }).sort((a,b) => new Date(b.created_iso) - new Date(a.created_iso));

        filtered.forEach(r => {
            const slaLimit = new Date(r.created_iso).getTime() + (SLA_HOURS[r.kategori]*3600000);
            const timeLeft = slaLimit - Date.now();
            const percent = Math.max(0, Math.min(100, (timeLeft / (SLA_HOURS[r.kategori]*3600000)) * 100));
            const isOverdue = timeLeft < 0 && r.status !== 'Closed';
            
            let slaColor = 'var(--success)';
            if(percent < 50) slaColor = 'var(--warning)';
            if(percent < 10 || isOverdue) slaColor = 'var(--danger)';

            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>
                    <div style="font-weight:700;">${r.id}</div>
                    <div style="font-size:12px; color:var(--text-secondary);">${r.nama}</div>
                </td>
                <td>
                    <div style="font-weight:500;">${r.jenis}</div>
                    <div style="font-size:12px; color:var(--text-tertiary); text-overflow:ellipsis; overflow:hidden; white-space:nowrap; max-width:200px;">${r.catatan || '-'}</div>
                </td>
                <td>
                    <span class="badge status-${r.status}">${r.status}</span>
                    <span class="badge cat-${r.kategori}">${r.kategori}</span>
                    ${r.status !== 'Closed' ? `
                    <div class="sla-progress" title="${isOverdue ? 'Overdue' : 'SLA Time Left'}">
                        <div class="sla-bar" style="width:${percent}%; background:${slaColor}"></div>
                    </div>
                    ` : ''}
                </td>
                <td>${r.pic || '-'}</td>
                <td>${new Date(r.updated_iso || r.created_iso).toLocaleDateString()}</td>
                <td style="text-align:right;">
                    <button class="icon-btn" onclick="openReportModal('${r.id}')"><i class="ri-edit-line"></i></button>
                    <button class="icon-btn" style="color:${isTrashMode ? 'var(--success)' : 'var(--danger)'}" onclick="${isTrashMode ? `restore('${r.id}')` : `softDelete('${r.id}')`}">
                        <i class="ri-${isTrashMode ? 'refresh-line' : 'delete-bin-line'}"></i>
                    </button>
                </td>
            `;
            tbody.appendChild(tr);
        });
    }

    function renderKanban() {
        ['Open', 'Progress', 'Closed'].forEach(status => {
            const container = $(`#kb-${status}`);
            container.innerHTML = '';
            const items = reports.filter(r => !r.isDeleted && r.status === status);
            $(`#count${status}`).textContent = items.length;

            items.forEach(r => {
                const div = document.createElement('div');
                div.className = 'kanban-card';
                div.onclick = () => openReportModal(r.id);
                div.innerHTML = `
                    <div class="k-card-top">
                        <span>${r.id}</span>
                        <span>${new Date(r.created_iso).toLocaleDateString()}</span>
                    </div>
                    <div class="k-card-title">${r.jenis} - ${r.nama}</div>
                    <div class="badge cat-${r.kategori}">${r.kategori}</div>
                    <div class="k-card-footer">
                        <div style="font-size:12px; color:var(--text-secondary);"><i class="ri-user-smile-line"></i> ${r.pic || '?'}</div>
                        ${r.note_internal ? '<i class="ri-lock-2-line" style="font-size:12px; color:var(--primary)"></i>' : ''}
                    </div>
                `;
                container.appendChild(div);
            });
        });
    }

    function renderAnnouncements() {
        const feed = $('#announcementFeed');
        feed.innerHTML = announcements.sort((a,b) => b.timestamp - a.timestamp).map(a => `
            <div style="padding:12px; border:1px solid var(--border-color); border-radius:8px; position:relative; background:var(--bg-body);">
                ${a.isPinned ? '<i class="ri-pushpin-fill" style="position:absolute; top:8px; right:8px; color:var(--warning)"></i>' : ''}
                <div style="font-size:11px; font-weight:700; color:var(--primary); text-transform:uppercase;">${a.category}</div>
                <div style="font-weight:600; margin-top:2px;">${a.title}</div>
                <div style="font-size:12px; color:var(--text-secondary); margin-top:4px; line-height:1.4;">${a.content}</div>
                <div style="font-size:10px; color:var(--text-tertiary); margin-top:8px; text-align:right;">
                    ${new Date(a.timestamp).toLocaleDateString()} â€¢ <span onclick="deleteAnn('${a.key}')" style="cursor:pointer; color:var(--danger)">Hapus</span>
                </div>
            </div>
        `).join('');
    }

    // === ACTIONS & LOGIC ===
    function switchTab(tab) {
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        event.currentTarget.classList.add('active');
        
        ['dashboard', 'tickets', 'users', 'requests'].forEach(id => {
            $(`#view-${id}`).classList.add('hidden');
        });
        $(`#view-${tab}`).classList.remove('hidden');

        // Mobile close
        if(window.innerWidth < 1024) $('#sidebar').classList.remove('open');
    }

    function toggleViewMode(mode) {
        if(mode === 'list') {
            $('#cont-list').classList.remove('hidden'); $('#cont-kanban').classList.add('hidden');
            $('#btnList').classList.add('active'); $('#btnKanban').classList.remove('active');
        } else {
            $('#cont-list').classList.add('hidden'); $('#cont-kanban').classList.remove('hidden');
            $('#btnList').classList.remove('active'); $('#btnKanban').classList.add('active');
        }
    }

    // --- Ticket CRUD ---
    window.openReportModal = (id) => {
        editingId = id;
        $('#modalTicket').style.display = 'flex';
        $('#formTicket').reset();
        
        if(id) {
            const r = reports.find(x => x.id === id);
            $('#t_nama').value = r.nama; $('#t_nama').readOnly = true;
            $('#t_pic').value = r.pic || '';
            $('#t_jenis').value = r.jenis;
            $('#t_kategori').value = r.kategori;
            $('#t_status').value = r.status;
            $('#t_note').value = r.catatan || '';
            $('#t_internal').value = r.note_internal || '';
        } else {
            $('#t_nama').readOnly = false;
            $('#t_status').value = 'Open';
        }
    };

    window.saveTicket = async () => {
        const nama = $('#t_nama').value;
        const pic = $('#t_pic').value;
        if(!nama || !pic) return alert("Nama & PIC Wajib diisi");

        let id = editingId;
        let oldData = {};

        if(!id) {
            const snap = await db.ref('counter').transaction(c => (c||0)+1);
            id = 'ZP-' + String(snap.snapshot.val()).padStart(4, '0');
        } else {
            oldData = reports.find(r => r.id === id);
        }

        const data = {
            id, nama, pic,
            jenis: $('#t_jenis').value,
            kategori: $('#t_kategori').value,
            status: $('#t_status').value,
            catatan: $('#t_note').value,
            note_internal: $('#t_internal').value,
            updated_iso: nowISO(),
            created_iso: oldData.created_iso || nowISO(),
            uid: oldData.uid || auth.currentUser.uid
        };

        // Duration calculation
        if(data.status === 'Closed' && oldData.status !== 'Closed') {
            data.durationMs = new Date().getTime() - new Date(data.created_iso).getTime();
        }

        await db.ref('reports/' + id).update(data);
        closeModal('modalTicket');
        showToast("Tiket Berhasil Disimpan");
    };

    window.softDelete = (id) => {
        if(confirm("Pindahkan ke sampah?")) {
            db.ref(`reports/${id}`).update({isDeleted: true});
            showToast("Moved to Trash");
        }
    };
    window.restore = (id) => {
        db.ref(`reports/${id}`).update({isDeleted: null});
        showToast("Ticket Restored");
    };
    window.toggleTrash = () => {
        isTrashMode = !isTrashMode;
        renderTable();
        showToast(isTrashMode ? "Mode: Trash Bin" : "Mode: Active Tickets");
    };

    // --- Announcement CRUD ---
    window.openAnnModal = () => $('#modalAnn').style.display = 'flex';
    window.saveAnnouncement = async () => {
        const title = $('#a_title').value;
        const content = $('#a_content').value;
        if(!title) return;

        await db.ref('announcements').push({
            title, content, 
            category: $('#a_cat').value,
            isPinned: $('#a_pin').checked,
            timestamp: firebase.database.ServerValue.TIMESTAMP
        });
        closeModal('modalAnn');
        showToast("Pengumuman Terbit");
    };
    window.deleteAnn = (key) => {
        if(confirm("Hapus?")) db.ref(`announcements/${key}`).remove();
    };

    window.closeModal = (id) => $(`#${id}`).style.display = 'none';

    // === SEARCH LISTENER ===
    $('#ticketSearch').oninput = renderTable;
    $('#globalSearch').oninput = renderTable;

    // === CHART.JS (Simple Implementation) ===
    let chartCat = null;
    function renderCharts() {
        const cats = { Low:0, Normal:0, Critical:0 };
        reports.filter(r=>!r.isDeleted).forEach(r => cats[r.kategori] = (cats[r.kategori]||0)+1);
        
        const ctx = $('#chartCategory').getContext('2d');
        if(chartCat) chartCat.destroy();
        chartCat = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: Object.keys(cats),
                datasets: [{data: Object.values(cats), backgroundColor: ['#06b6d4', '#f59e0b', '#ef4444']}]
            },
            options: { plugins: { legend: {position:'right'} } }
        });
    }
</script>
</body>
</html>
