<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Zeppelin â€” Enterprise Command Center</title>
<link rel="icon" type="image/png" href="icov2.png" />

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400&display=swap" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.0/jspdf.plugin.autotable.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>

<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>

<style>
    :root {
        --bg-body: #f1f5f9;
        --bg-sidebar: #ffffff;
        --bg-card: #ffffff;
        --bg-hover: #f8fafc;
        --border-color: #e2e8f0;
        
        --text-primary: #0f172a;
        --text-secondary: #64748b;
        --text-tertiary: #94a3b8;
        
        --primary: #2563eb;
        --primary-light: #eff6ff;
        --primary-dark: #1d4ed8;
        
        --success: #10b981;
        --warning: #f59e0b;
        --danger: #ef4444;
        --info: #06b6d4;
        
        --shadow-xs: 0 1px 2px 0 rgb(0 0 0 / 0.05);
        --shadow-sm: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
        --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        
        --radius: 12px;
        --font-main: 'Inter', sans-serif;
    }

    [data-theme="dark"] {
        --bg-body: #0f172a;
        --bg-sidebar: #1e293b;
        --bg-card: #1e293b;
        --bg-hover: #334155;
        --border-color: #334155;
        --text-primary: #f8fafc;
        --text-secondary: #94a3b8;
        --text-tertiary: #64748b;
        --primary: #3b82f6;
        --primary-light: rgba(59, 130, 246, 0.1);
    }

    * { box-sizing: border-box; outline: none; }
    body { margin: 0; font-family: var(--font-main); background: var(--bg-body); color: var(--text-primary); height: 100vh; overflow: hidden; }

    /* LAYOUT UTAMA */
    .app-layout { display: grid; grid-template-columns: 260px 1fr; grid-template-rows: 64px 1fr; height: 100vh; width: 100vw; }
    
    /* SIDEBAR */
    .sidebar { grid-row: 1 / -1; background: var(--bg-sidebar); border-right: 1px solid var(--border-color); display: flex; flex-direction: column; padding: 24px 16px; z-index: 50; }
    .brand { display: flex; align-items: center; gap: 12px; margin-bottom: 32px; padding: 0 12px; }
    .brand-icon { width: 36px; height: 36px; background: linear-gradient(135deg, var(--primary), #8b5cf6); border-radius: 8px; color: white; display: flex; align-items: center; justify-content: center; font-weight: 800; font-size: 18px; box-shadow: var(--shadow-sm); }
    .brand-text { font-size: 18px; font-weight: 700; letter-spacing: -0.5px; }
    
    .nav-menu { list-style: none; padding: 0; margin: 0; display: flex; flex-direction: column; gap: 4px; flex: 1; }
    .nav-item { display: flex; align-items: center; gap: 12px; padding: 10px 12px; border-radius: 8px; color: var(--text-secondary); font-weight: 500; font-size: 14px; cursor: pointer; transition: all 0.2s; text-decoration: none; }
    .nav-item:hover { background: var(--bg-hover); color: var(--text-primary); }
    .nav-item.active { background: var(--primary-light); color: var(--primary); font-weight: 600; }
    .nav-item i { font-size: 18px; }

    /* TOPBAR */
    .topbar { grid-column: 2; background: var(--bg-sidebar); border-bottom: 1px solid var(--border-color); display: flex; align-items: center; justify-content: space-between; padding: 0 32px; z-index: 40; }
    .search-box { position: relative; width: 400px; }
    .search-box input { width: 100%; padding: 10px 16px 10px 40px; border-radius: 8px; border: 1px solid var(--border-color); background: var(--bg-body); color: var(--text-primary); font-size: 13px; transition: all 0.2s; }
    .search-box input:focus { border-color: var(--primary); background: var(--bg-card); box-shadow: 0 0 0 3px var(--primary-light); }
    .search-box i { position: absolute; left: 14px; top: 50%; transform: translateY(-50%); color: var(--text-secondary); }

    .header-actions { display: flex; align-items: center; gap: 12px; }
    .icon-btn { width: 36px; height: 36px; border-radius: 8px; display: flex; align-items: center; justify-content: center; color: var(--text-secondary); cursor: pointer; position: relative; transition: all 0.2s; border: 1px solid transparent; background: transparent; }
    .icon-btn:hover { background: var(--bg-hover); color: var(--text-primary); border-color: var(--border-color); }
    .badge-dot { position: absolute; top: 8px; right: 8px; width: 8px; height: 8px; background: var(--danger); border-radius: 50%; border: 2px solid var(--bg-sidebar); display: none; }

    /* CONTENT AREA */
    .main-content { grid-column: 2; background: var(--bg-body); padding: 32px; overflow-y: auto; }

    /* STATS CARDS */
    .stats-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 24px; margin-bottom: 32px; }
    .stat-card { background: var(--bg-card); padding: 24px; border-radius: var(--radius); border: 1px solid var(--border-color); box-shadow: var(--shadow-sm); display: flex; align-items: flex-start; justify-content: space-between; cursor: pointer; transition: all 0.2s; }
    .stat-card:hover { transform: translateY(-2px); box-shadow: var(--shadow-md); border-color: var(--primary); }
    .stat-info h4 { margin: 0; font-size: 13px; color: var(--text-secondary); font-weight: 500; text-transform: uppercase; letter-spacing: 0.5px; }
    .stat-info h2 { margin: 8px 0 0; font-size: 28px; color: var(--text-primary); font-weight: 700; letter-spacing: -1px; }
    .stat-icon { width: 48px; height: 48px; border-radius: 12px; background: var(--primary-light); color: var(--primary); display: flex; align-items: center; justify-content: center; font-size: 22px; }
    .stat-card.overdue .stat-icon { background: #fee2e2; color: var(--danger); }

    /* TOOLBARS & FILTERS (UNIFIED STYLE) */
    .view-header { display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 24px; }
    .view-title h1 { font-size: 24px; font-weight: 700; margin: 0 0 4px 0; color: var(--text-primary); }
    .view-title p { color: var(--text-secondary); margin: 0; font-size: 14px; }
    
    .table-toolbar { 
        background: var(--bg-card); 
        border: 1px solid var(--border-color); 
        border-radius: var(--radius); 
        padding: 12px 16px; 
        display: flex; 
        align-items: center; 
        justify-content: space-between; 
        gap: 16px; 
        margin-bottom: 24px; 
        box-shadow: var(--shadow-sm);
        flex-wrap: wrap;
    }
    .toolbar-left { display: flex; gap: 12px; align-items: center; flex: 1; }
    .toolbar-right { display: flex; gap: 12px; align-items: center; }

    /* TABLE STYLING - REFINED */
    .table-container { background: var(--bg-card); border-radius: var(--radius); border: 1px solid var(--border-color); overflow: hidden; box-shadow: var(--shadow-sm); }
    .table-responsive { overflow-x: auto; }
    table { width: 100%; border-collapse: collapse; min-width: 900px; }
    th { background: #f8fafc; color: var(--text-secondary); font-size: 11px; text-transform: uppercase; letter-spacing: 0.08em; padding: 16px 24px; text-align: left; font-weight: 600; border-bottom: 1px solid var(--border-color); }
    td { padding: 16px 24px; border-bottom: 1px solid var(--border-color); font-size: 14px; vertical-align: middle; color: var(--text-primary); }
    tr:last-child td { border-bottom: none; }
    tr:hover td { background: var(--bg-hover); }

    .pagination-container { display: flex; justify-content: space-between; align-items: center; padding: 14px 24px; border-top: 1px solid var(--border-color); background: var(--bg-card); }
    .page-btn { padding: 6px 12px; border: 1px solid var(--border-color); background: var(--bg-card); color: var(--text-secondary); border-radius: 6px; cursor: pointer; font-size: 13px; transition: all 0.2s; }
    .page-btn:hover { border-color: var(--text-tertiary); color: var(--text-primary); }
    .page-btn.active { background: var(--primary); color: white; border-color: var(--primary); }

    /* KANBAN */
    .kanban-board { display: grid; grid-template-columns: repeat(3, 1fr); gap: 24px; height: calc(100vh - 240px); overflow-x: auto; padding-bottom: 16px; }
    .kanban-col { background: var(--bg-hover); border-radius: var(--radius); padding: 16px; display: flex; flex-direction: column; max-height: 100%; border: 1px solid var(--border-color); }
    .kanban-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; padding: 0 4px; }
    .kanban-card { background: var(--bg-card); padding: 16px; border-radius: 8px; box-shadow: var(--shadow-sm); border: 1px solid var(--border-color); cursor: pointer; transition: all 0.2s; margin-bottom: 12px; }
    .kanban-card:hover { transform: translateY(-3px); box-shadow: var(--shadow-md); border-color: var(--primary); }
    .btn-toggle { padding: 6px 12px; border: none; background: transparent; color: var(--text-secondary); cursor: pointer; border-radius: 6px; font-weight: 500; font-size: 13px; display: flex; gap: 6px; align-items: center; transition: all 0.2s; }
    .btn-toggle.active { background: var(--bg-card); color: var(--text-primary); font-weight: 600; box-shadow: var(--shadow-xs); }
    .btn-group { display: flex; background: var(--bg-hover); border-radius: 8px; padding: 3px; border: 1px solid var(--border-color); }

    /* COMPONENTS */
    .badge { padding: 4px 10px; border-radius: 6px; font-size: 11px; font-weight: 600; display: inline-flex; align-items: center; gap: 4px; letter-spacing: 0.3px; }
    .status-Open { background: #fff7ed; color: #c2410c; border: 1px solid #ffedd5; }
    .status-Progress { background: #eff6ff; color: #1d4ed8; border: 1px solid #dbeafe; }
    .status-Closed { background: #f0fdf4; color: #15803d; border: 1px solid #dcfce7; }
    .cat-Low { color: var(--info); background: rgba(6, 182, 212, 0.1); border: 1px solid rgba(6, 182, 212, 0.2); }
    .cat-Normal { color: var(--warning); background: rgba(245, 158, 11, 0.1); border: 1px solid rgba(245, 158, 11, 0.2); }
    .cat-Critical, .cat-High { color: var(--danger); background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.2); }

    .btn { display: inline-flex; align-items: center; gap: 8px; padding: 10px 18px; border-radius: 8px; font-weight: 600; font-size: 13px; cursor: pointer; border: 1px solid transparent; transition: all 0.2s; background: var(--primary); color: white; justify-content: center; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
    .btn:hover { background: var(--primary-dark); transform: translateY(-1px); box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }
    .btn-outline { background: white; border: 1px solid var(--border-color); color: var(--text-secondary); box-shadow: var(--shadow-xs); }
    .btn-outline:hover { border-color: var(--text-secondary); color: var(--text-primary); background: var(--bg-hover); }
    .btn-danger { background: var(--danger); color: white; }
    .btn-create { background: var(--primary); color: #fff; }

    /* FORMS */
    select, input, textarea { width: 100%; padding: 10px 12px; border-radius: 8px; border: 1px solid var(--border-color); background: var(--bg-card); color: var(--text-primary); font-family: inherit; font-size: 14px; transition: border 0.2s, box-shadow 0.2s; }
    input:focus, select:focus, textarea:focus { border-color: var(--primary); outline: none; box-shadow: 0 0 0 3px var(--primary-light); }

    /* MODAL */
    .modal-overlay { position: fixed; inset: 0; background: rgba(15, 23, 42, 0.6); backdrop-filter: blur(4px); z-index: 1000; display: none; align-items: center; justify-content: center; opacity: 0; transition: opacity 0.2s; }
    .modal-overlay.active { opacity: 1; }
    .modal-content { background: var(--bg-card); width: 100%; max-width: 600px; padding: 32px; border-radius: 16px; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1); transform: scale(0.95); transition: transform 0.2s; max-height: 90vh; overflow-y: auto; }
    .modal-overlay.active .modal-content { transform: scale(1); }

    #loginScreen { position: fixed; inset: 0; background: #f8fafc; z-index: 9999; display: flex; align-items: center; justify-content: center; }
    .login-card { background: white; padding: 48px; border-radius: 24px; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.1); width: 400px; border: 1px solid #e2e8f0; text-align: center; }

    /* LOADING SCREEN PROFESSIONAL */
    .loader-overlay { 
        position: fixed; inset: 0; background: #ffffff; z-index: 100000; 
        display: flex; flex-direction: column; justify-content: center; align-items: center;
        transition: opacity 0.5s ease-in-out, visibility 0.5s;
    }
    .loader-logo {
        width: 64px; height: 64px; background: linear-gradient(135deg, var(--primary), #8b5cf6);
        border-radius: 16px; color: white; display: flex; align-items: center; justify-content: center;
        font-weight: 800; font-size: 32px; margin-bottom: 24px;
        box-shadow: 0 10px 25px -5px rgba(37, 99, 235, 0.4);
        animation: pulse 2s infinite;
    }
    @keyframes pulse { 0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(37, 99, 235, 0.4); } 70% { transform: scale(1.05); box-shadow: 0 0 0 15px rgba(37, 99, 235, 0); } 100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(37, 99, 235, 0); } }
    .loader-bar-bg { width: 200px; height: 4px; background: #f1f5f9; border-radius: 99px; overflow: hidden; position: relative; }
    .loader-bar { width: 50%; height: 100%; background: var(--primary); border-radius: 99px; position: absolute; left: 0; animation: loadBar 1.5s infinite ease-in-out; }
    @keyframes loadBar { 0% { left: -50%; width: 50%; } 50% { left: 25%; width: 75%; } 100% { left: 100%; width: 20%; } }

    .hidden { display: none !important; }
    .text-sm { font-size: 13px; color: var(--text-secondary); margin-top: 16px; font-weight: 500; }
    
    @media (max-width: 1024px) {
        .app-layout { grid-template-columns: 1fr; grid-template-rows: 64px 1fr; }
        .sidebar { display: none; position: fixed; height: 100%; width: 260px; box-shadow: 0 0 20px rgba(0,0,0,0.1); }
        .sidebar.open { display: flex; }
        .topbar { grid-column: 1; padding: 0 16px; }
        .main-content { grid-column: 1; padding: 16px; }
        #mobileMenuBtn { display: block !important; }
        .search-box { display: none; }
        .kanban-board { grid-template-columns: 1fr; gap: 16px; }
        .table-toolbar { flex-direction: column; align-items: stretch; }
        .toolbar-left, .toolbar-right { flex-direction: column; width: 100%; }
        .btn-group { width: 100%; } .btn-group button { flex: 1; justify-content: center; }
    }
    #mobileMenuBtn { display: none; font-size: 24px; color: var(--text-primary); cursor: pointer; }
    .sla-progress { height: 4px; background: var(--border-color); border-radius: 2px; margin-top: 8px; overflow: hidden; }
    .sla-bar { height: 100%; background: var(--success); transition: width 0.3s; }
</style>
</head>
<body data-theme="light">

<div id="appLoader" class="loader-overlay">
    <div class="loader-logo">Z</div>
    <div class="loader-bar-bg"><div class="loader-bar"></div></div>
    <div class="text-sm">Initializing Secure Environment...</div>
</div>

<div id="loginScreen" class="hidden"> 
    <div class="login-card">
        <div class="brand-icon" style="width:56px; height:56px; font-size:24px; margin:0 auto 24px;">Z</div>
        <h2 style="margin-bottom:8px; font-weight:800; color:#1e293b;">Zeppelin Enterprise</h2>
        <p style="color:#64748b; font-size:14px; margin-bottom:32px;">Secure Admin Access Point</p>
        <div style="text-align:left; margin-bottom:16px;">
            <label style="font-size:12px; font-weight:600; color:#64748b; margin-bottom:6px; display:block;">USERNAME</label>
            <input id="loginUser" type="text" placeholder="root" style="width:100%;">
        </div>
        <div style="text-align:left; margin-bottom:24px;">
            <label style="font-size:12px; font-weight:600; color:#64748b; margin-bottom:6px; display:block;">PASSWORD</label>
            <input id="loginPass" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢" style="width:100%;">
        </div>
        <button id="loginBtn" class="btn" style="width:100%; padding:14px; font-size:14px;">Masuk Dashboard</button>
        <p id="authError" style="color:var(--danger); font-size:13px; margin-top:16px; display:none;"></p>
    </div>
</div>

<div class="app-layout hidden" id="appInterface">
    <aside class="sidebar" id="sidebar">
        <div class="brand"><div class="brand-icon">Z</div><div class="brand-text">Zeppelin<span style="color:var(--primary);">.center</span></div></div>
        <ul class="nav-menu">
            <li class="nav-item active" onclick="switchTab('dashboard')"><i class="ri-dashboard-3-line"></i> Dashboard</li>
            <li class="nav-item" onclick="switchTab('tickets')"><i class="ri-ticket-2-line"></i> Tiket & Insiden</li>
            <li class="nav-item" onclick="switchTab('users')"><i class="ri-team-line"></i> User Management</li>
            <li class="nav-item" onclick="switchTab('requests')"><i class="ri-macbook-line"></i> Permintaan Aset</li>
        </ul>
        <div style="margin-top:auto; padding-top:24px; border-top:1px solid var(--border-color);">
            <div class="nav-item" style="color:var(--danger);" id="logoutBtn"><i class="ri-logout-box-line"></i> Sign Out</div>
            <div style="font-size:11px; color:var(--text-tertiary); margin-top:16px; text-align:center;">v4.1.0 (Fixed Filters)</div>
        </div>
    </aside>

    <header class="topbar">
        <div style="display:flex; align-items:center; gap:16px;">
            <i class="ri-menu-2-line" id="mobileMenuBtn"></i>
            <div class="search-box"><i class="ri-search-line"></i><input type="text" id="globalSearch" placeholder="Cari tiket, user, atau aset (Cmd + K)..."></div>
        </div>
        <div class="header-actions">
            <button class="icon-btn" id="themeToggle" title="Ganti Tema"><i class="ri-moon-line"></i></button>
            <a href="chatadm.html" class="icon-btn" title="Pesan Masuk"><i class="ri-message-3-line"></i><span class="badge-dot" id="chatBadge"></span></a>
            <div style="height:20px; width:1px; background:var(--border-color);"></div>
            <button class="icon-btn" id="backupBtn" title="Download Backup"><i class="ri-download-cloud-2-line"></i></button>
            <input id="restoreFile" type="file" hidden accept=".json">
            <button class="icon-btn" id="restoreBtn" title="Restore Data"><i class="ri-upload-cloud-2-line"></i></button>
            <div style="width:36px; height:36px; background:linear-gradient(to bottom, #3b82f6, #2563eb); color:white; border-radius:50%; display:flex; align-items:center; justify-content:center; font-weight:700; font-size:14px; margin-left:8px; box-shadow:0 2px 4px rgba(37,99,235,0.2);">A</div>
        </div>
    </header>

    <main class="main-content">
        <div id="view-dashboard">
            <div class="view-header">
                <div class="view-title"><h1>Command Center</h1><p>Ringkasan aktivitas sistem hari ini.</p></div>
            </div>
            <div class="stats-row">
                <div class="stat-card" onclick="filterByStat('All')"><div class="stat-info"><h4>Total Tiket</h4><h2 id="statTotal">0</h2></div><div class="stat-icon"><i class="ri-folder-open-line"></i></div></div>
                <div class="stat-card" onclick="filterByStat('Open')"><div class="stat-info"><h4>Open</h4><h2 id="statOpen" style="color:var(--warning)">0</h2></div><div class="stat-icon" style="background:#fffbeb; color:var(--warning)"><i class="ri-loader-2-line"></i></div></div>
                <div class="stat-card" onclick="filterByStat('Closed')"><div class="stat-info"><h4>Selesai</h4><h2 id="statClosed" style="color:var(--success)">0</h2></div><div class="stat-icon" style="background:#ecfdf5; color:var(--success)"><i class="ri-check-double-line"></i></div></div>
                <div class="stat-card overdue" onclick="filterByStat('Overdue')"><div class="stat-info"><h4 style="color:var(--danger)">Overdue</h4><h2 id="statOverdue" style="color:var(--danger)">0</h2></div><div class="stat-icon"><i class="ri-alarm-warning-line"></i></div></div>
            </div>
            <div style="display:grid; grid-template-columns: 2fr 1fr; gap:24px; margin-bottom: 24px;">
                <div style="background:var(--bg-card); padding:24px; border-radius:var(--radius); border:1px solid var(--border-color); box-shadow:var(--shadow-sm);">
                    <div style="display:flex; justify-content:space-between; margin-bottom:20px;"><h3 style="font-size:16px; font-weight:600; margin:0;">Analitik Kinerja</h3><select style="border:none; background:transparent; font-size:12px; color:var(--text-secondary); width:auto; padding:0;"><option>7 Hari Terakhir</option></select></div>
                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:24px;">
                        <div style="position: relative; height: 200px; width: 100%;"><canvas id="chartCategory"></canvas></div>
                        <div style="position: relative; height: 200px; width: 100%;"><canvas id="chartSLA"></canvas></div>
                    </div>
                </div>
                <div style="background:var(--bg-card); padding:24px; border-radius:var(--radius); border:1px solid var(--border-color); display:flex; flex-direction:column; box-shadow:var(--shadow-sm);">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;"><h3 style="font-size:16px; font-weight:600; margin:0;">ðŸ“¢ Pengumuman</h3><button class="btn-toggle" onclick="openAnnModal(null)" style="font-size:12px;"><i class="ri-add-line"></i> Baru</button></div>
                    <div id="announcementFeed" style="flex:1; overflow-y:auto; max-height:300px; display:flex; flex-direction:column; gap:12px;"></div>
                </div>
            </div>
        </div>

        <div id="view-tickets" class="hidden">
            <div class="view-header">
                <div class="view-title"><h1>Manajemen Tiket</h1><p>Pantau insiden, lacak SLA, dan selesaikan laporan user.</p></div>
                <div style="display:flex; gap:12px;">
                    <button class="btn btn-outline" onclick="toggleTrash()"><i class="ri-delete-bin-line"></i> Sampah</button>
                    <button class="btn" onclick="openReportModal(null)"><i class="ri-add-line"></i> Tiket Baru</button>
                </div>
            </div>

            <div class="table-toolbar">
                <div class="toolbar-left">
                    <div class="btn-group">
                        <button class="btn-toggle active" id="btnList" onclick="toggleViewMode('list')"><i class="ri-list-check"></i> List</button>
                        <button class="btn-toggle" id="btnKanban" onclick="toggleViewMode('kanban')"><i class="ri-kanban-view"></i> Board</button>
                    </div>
                    <div style="height:24px; width:1px; background:var(--border-color); margin:0 8px;"></div>
                    <select id="filterCat" style="width:160px;"><option value="">Semua Kategori</option><option value="Low">Low</option><option value="Normal">Normal</option><option value="Critical">Critical</option></select>
                </div>
                <div class="toolbar-right">
                    <div class="search-box" style="width:250px; display:block;"><i class="ri-search-line"></i><input type="text" id="ticketSearch" placeholder="Filter ID/Nama..." style="border-radius:6px;"></div>
                </div>
            </div>

            <div id="cont-list" class="table-container">
                <div class="table-responsive">
                    <table id="reportTable"><thead><tr><th>ID & Pelapor</th><th>Subjek Masalah</th><th>Status & SLA</th><th>Teknisi (PIC)</th><th>Waktu Lapor</th><th style="text-align:right">Aksi</th></tr></thead><tbody></tbody></table>
                </div>
                <div class="pagination-container"><div class="pagination-info" id="paginationInfo">Menampilkan 0-0 dari 0</div><div class="pagination-btns" id="paginationBtns"></div></div>
            </div>
            
            <div id="cont-kanban" class="hidden">
                <div class="kanban-board">
                    <div class="kanban-col"><div class="kanban-header"><h3>Open / Baru</h3><span class="kanban-count" id="countOpen">0</span></div><div id="kb-Open" class="kanban-items-container"></div></div>
                    <div class="kanban-col"><div class="kanban-header"><h3>In Progress</h3><span class="kanban-count" id="countProgress">0</span></div><div id="kb-Progress" class="kanban-items-container"></div></div>
                    <div class="kanban-col"><div class="kanban-header"><h3>Closed / Selesai</h3><span class="kanban-count" id="countClosed">0</span></div><div id="kb-Closed" class="kanban-items-container"></div></div>
                </div>
            </div>
        </div>

        <div id="view-users" class="hidden">
            <div class="view-header">
                <div class="view-title"><h1>Manajemen User</h1><p>Kelola akses dan data karyawan.</p></div>
                <button id="showCreateUserPopupBtn" class="btn btn-create"><i class="ri-user-add-line"></i> User Baru</button>
            </div>
            
            <div class="stats-row">
                <div class="stat-card"><div class="stat-info"><h4>Total User</h4><h2 id="userStatTotal">0</h2></div><div class="stat-icon"><i class="ri-group-line"></i></div></div>
                <div class="stat-card"><div class="stat-info"><h4>Pending</h4><h2 id="userStatPending" style="color:var(--warning)">0</h2></div><div class="stat-icon"><i class="ri-user-follow-line"></i></div></div>
                <div class="stat-card"><div class="stat-info"><h4>Approved</h4><h2 id="userStatApproved" style="color:var(--success)">0</h2></div><div class="stat-icon"><i class="ri-user-smile-line"></i></div></div>
            </div>

            <div class="table-toolbar">
                <div class="toolbar-left" style="flex:2;">
                    <div class="search-box" style="width:100%; display:block;">
                        <i class="ri-search-line"></i>
                        <input id="userSearchInput" type="text" placeholder="Cari nama atau email..." style="border-radius:6px;">
                    </div>
                </div>
                <div class="toolbar-right">
                    <select id="userFilterDept" style="width:180px;"><option value="">Semua Departemen</option></select>
                    <select id="userFilterStatus" style="width:140px;"><option value="">Semua Status</option><option value="pending">Pending</option><option value="approved">Approved</option><option value="rejected">Rejected</option></select>
                </div>
            </div>

            <div class="table-container table-responsive"><table id="userTable"><thead><tr><th>Nama</th><th>Email</th><th>Departemen</th><th>Status</th><th style="text-align:center;">Tiket</th><th>Aksi</th></tr></thead><tbody id="userTableBody"></tbody></table></div>
        </div>

        <div id="view-requests" class="hidden">
            <div class="view-header">
                <div class="view-title"><h1>Permintaan Aset</h1><p>Approval permintaan perangkat hardware/software.</p></div>
            </div>
            
            <div class="stats-row">
                <div class="stat-card"><div class="stat-info"><h4>Total Pending</h4><h2 id="reqStatPending" style="color:var(--warning)">0</h2></div><div class="stat-icon"><i class="ri-time-line"></i></div></div>
                <div class="stat-card"><div class="stat-info"><h4>Approved</h4><h2 id="reqStatApproved" style="color:var(--success)">0</h2></div><div class="stat-icon"><i class="ri-check-line"></i></div></div>
                <div class="stat-card"><div class="stat-info"><h4>Rejected</h4><h2 id="reqStatRejected" style="color:var(--danger)">0</h2></div><div class="stat-icon"><i class="ri-close-line"></i></div></div>
            </div>

            <div class="table-toolbar">
                <div class="toolbar-left" style="flex:2;">
                    <div class="search-box" style="width:100%; display:block;">
                        <i class="ri-search-line"></i>
                        <input id="reqSearch" type="text" placeholder="Cari user, email, detail..." style="border-radius:6px;">
                    </div>
                </div>
                <div class="toolbar-right">
                    <select id="reqFilterDept" style="width:180px;"><option value="">Semua Departemen</option></select>
                    <select id="reqFilterStatus" style="width:140px;"><option value="">Semua Status</option><option value="Pending" selected>Pending</option><option value="Approved">Approved</option><option value="Rejected">Rejected</option></select>
                </div>
            </div>

            <div class="table-container table-responsive"><table id="reqTable"><thead><tr><th>Tanggal</th><th>User</th><th>Departemen</th><th>Kategori</th><th>Detail</th><th>Prioritas</th><th>Status</th><th>Aksi</th></tr></thead><tbody id="reqTableBody"></tbody></table></div>
        </div>
    </main>
</div>

<div class="modal-overlay" id="modalTicket">
    <div class="modal-content">
        <h2 style="margin-top:0; font-weight:700;">Detail Tiket</h2>
        <form id="formTicket" onsubmit="return false;">
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:16px; margin-bottom:16px;">
                <div><label style="font-size:12px; font-weight:600;">Pelapor</label><input id="t_nama" required placeholder="Nama User" style="margin-top:4px;"></div>
                <div><label style="font-size:12px; font-weight:600;">PIC Teknisi</label><input id="t_pic" required placeholder="Nama Anda" style="margin-top:4px;"></div>
            </div>
            <div style="margin-bottom:16px;">
                <label style="font-size:12px; font-weight:600;">Jenis & Kategori</label>
                <div style="display:flex; gap:12px; margin-top:4px;">
                    <select id="t_jenis" style="flex:2;">
                        <option value="" disabled selected>-- Pilih Jenis Masalah --</option>
                        <optgroup label="Hardware & Perangkat">
                            <option value="Hardware - Laptop/PC">Laptop / PC Rusak</option>
                            <option value="Hardware - Printer">Printer / Scanner</option>
                            <option value="Hardware - Peripheral">Mouse / Keyboard / Monitor</option>
                        </optgroup>
                        <optgroup label="Jaringan & Internet">
                            <option value="Network - No Internet">Tidak Ada Internet</option>
                            <option value="Network - WiFi">Masalah WiFi</option>
                            <option value="Network - VPN">Akses VPN</option>
                        </optgroup>
                        <optgroup label="Software & Aplikasi">
                            <option value="Software - OS">Windows / MacOS Error</option>
                            <option value="Software - Office">Microsoft Office / Email</option>
                            <option value="Software - ERP/SAP">Aplikasi ERP / Internal</option>
                        </optgroup>
                        <optgroup label="Akun & Keamanan">
                            <option value="Account - Reset Password">Lupa Password / Reset</option>
                            <option value="Account - New Access">Permintaan Akses Baru</option>
                        </optgroup>
                        <optgroup label="Lainnya">
                            <option value="Other">Lain-lain</option>
                        </optgroup>
                    </select>
                    <select id="t_kategori" style="flex:1;"><option value="Low">Low (48h)</option><option value="Normal">Normal (24h)</option><option value="Critical">Critical (4h)</option></select>
                </div>
            </div>
            <div style="margin-bottom:16px;"><label style="font-size:12px; font-weight:600;">Catatan Publik</label><textarea id="t_note" rows="3" style="margin-top:4px;"></textarea></div>
            <div style="margin-bottom:24px;"><label style="font-size:12px; font-weight:600; color:var(--primary);">ðŸ”’ Catatan Internal</label><textarea id="t_internal" rows="3" style="background:var(--bg-hover); margin-top:4px; border-color:#cbd5e1;"></textarea></div>
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <select id="t_status" style="width:auto;"><option value="Open">Open</option><option value="Progress">Progress</option><option value="Closed">Closed</option></select>
                <div style="display:flex; gap:12px;"><button class="btn btn-outline" onclick="closeModal('modalTicket')">Batal</button><button class="btn" onclick="saveTicket()">Simpan Perubahan</button></div>
            </div>
        </form>
    </div>
</div>

<div class="modal-overlay" id="modalAnn">
    <div class="modal-content">
        <h2 style="margin-top:0;">Buat Pengumuman</h2>
        <div style="margin-bottom:12px;"><label style="font-size:12px; font-weight:600;">Judul</label><input id="a_title" placeholder="Cth: Libur Nasional" style="margin-top:4px;"></div>
        <div style="margin-bottom:12px;"><label style="font-size:12px; font-weight:600;">Konten</label><textarea id="a_content" rows="6" placeholder="Isi..." style="margin-top:4px;"></textarea></div>
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-bottom:16px;">
            <div><label style="font-size:12px; font-weight:600;">Kategori</label><select id="a_cat" style="margin-top:4px;"><option value="Umum">Umum</option><option value="Penting">Penting</option><option value="Event">Event</option></select></div>
            <div><label style="font-size:12px; font-weight:600;">Author</label><input id="a_author" value="Admin" style="margin-top:4px;"></div>
        </div>
        <label style="display:flex; align-items:center; gap:8px; cursor:pointer; margin-bottom:24px;"><input type="checkbox" id="a_pin"> <span>Sematkan (Pin)</span></label>
        <div style="display:flex; justify-content:flex-end; gap:12px;"><button class="btn btn-outline" onclick="closeModal('modalAnn')">Batal</button><button class="btn" onclick="saveAnnouncement()">Publikasikan</button></div>
    </div>
</div>

<div class="modal-overlay" id="modalUserDetail">
    <div class="modal-content">
        <h3>Detail User: <span id="ud_name" style="color:var(--primary)"></span></h3><input type="hidden" id="ud_id">
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-bottom:16px;"><div><label class="small">Nama Lengkap</label><input type="text" id="ud_fullname"></div><div><label class="small">Departemen</label><input type="text" id="ud_dept"></div></div>
        <div style="margin-bottom:16px;"><label class="small">Email</label><input type="email" id="ud_email" disabled></div>
        <div style="display:grid; grid-template-columns:repeat(3, 1fr); gap:8px; margin-bottom:16px;"><button class="btn" style="background:var(--success)" onclick="updateUserStatus('approved')">Approve</button><button class="btn" style="background:var(--danger)" onclick="updateUserStatus('rejected')">Reject</button><button class="btn" style="background:var(--warning)" onclick="updateUserStatus('pending')">Pending</button></div>
        <div style="display:flex; justify-content:flex-end; gap:12px; border-top:1px solid var(--border-color); padding-top:16px;"><button class="btn btn-outline" onclick="closeModal('modalUserDetail')">Tutup</button><button class="btn" onclick="saveUserChanges()">Simpan Data</button></div>
    </div>
</div>

<div class="modal-overlay" id="modalCreateUser">
    <div class="modal-content">
        <h3>Buat User Baru</h3>
        <form id="formCreateUser" onsubmit="return false;">
            <div style="margin-bottom:12px;"><label class="small">Nama Lengkap</label><input id="cu_name" required></div>
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-bottom:12px;"><div><label class="small">Email</label><input id="cu_email" type="email" required></div><div><label class="small">Departemen</label><input id="cu_dept" required></div></div>
            <div style="margin-bottom:16px;"><label class="small">Password (Min. 6 char)</label><input id="cu_pass" type="password" required minlength="6"></div>
            <div style="display:flex; justify-content:flex-end; gap:12px;"><button class="btn btn-outline" onclick="closeModal('modalCreateUser')">Batal</button><button class="btn" onclick="submitNewUser()">Buat Akun</button></div>
        </form>
    </div>
</div>

<div class="modal-overlay" id="modalReqDetail">
    <div class="modal-content">
        <h3>Proses Permintaan</h3><input type="hidden" id="rd_id">
        <div style="background:var(--bg-hover); padding:16px; border-radius:8px; margin-bottom:16px;"><div style="font-weight:700; margin-bottom:4px;" id="rd_user">User Name</div><div style="font-size:13px; color:var(--text-secondary);" id="rd_detail">Request Details...</div><div style="margin-top:8px; font-style:italic;" id="rd_reason">"Reason..."</div></div>
        <div id="assetAssignSection" style="margin-bottom:16px; display:none;"><label class="small" style="color:var(--primary)"><i class="ri-box-3-line"></i> Tetapkan Aset dari Stok</label><select id="rd_asset_select" style="margin-top:4px;"><option value="">-- Pilih Aset --</option></select></div>
        <div style="margin-bottom:16px;"><label class="small">Catatan Admin</label><textarea id="rd_notes" rows="3" placeholder="Respon untuk user..."></textarea></div>
        <div style="display:flex; justify-content:flex-end; gap:12px;"><button class="btn btn-outline" onclick="closeModal('modalReqDetail')">Batal</button><button class="btn" style="background:var(--danger)" onclick="processRequest('Rejected')">Tolak</button><button class="btn" style="background:var(--success)" onclick="processRequest('Approved')">Setujui</button></div>
    </div>
</div>

<div id="toast" style="position:fixed; bottom:-100px; left:50%; transform:translateX(-50%); background:var(--text-primary); color:white; padding:12px 24px; border-radius:50px; font-weight:600; transition:all 0.3s; z-index:99999; box-shadow:var(--shadow-md); font-size:14px;">Notification</div>

<script>
    // === CONFIGURATION ===
    const ADMIN_UID = "Ogy9lUbGHbSu8wYIYx2gQsTtFDF2";
    const ADMIN_EMAIL = "root@zeppelin.center";
    const firebaseConfig = {
        apiKey: "AIzaSyA9wgSalrlTcveIZi2i-WND86z1i9JYHKw",
        authDomain: "it-support-53eeb.firebaseapp.com",
        databaseURL: "https://it-support-53eeb-default-rtdb.firebaseio.com",
        projectId: "it-support-53eeb",
        storageBucket: "it-support-53eeb.firebasestorage.app",
        messagingSenderId: "573924501146",
        appId: "1:573924501146:web:12f34306ed675472322123",
        measurementId: "G-33K6DDE1VR"
    };

    const mainApp = firebase.initializeApp(firebaseConfig);
    const db = mainApp.database();
    const auth = mainApp.auth();
    const firestore = mainApp.firestore();
    const SLA_HOURS = { Low: 48, Normal: 24, Critical: 4 };

    // === STATE ===
    let reports = [];
    let users = [];
    let requests = [];
    let assets = []; 
    let announcements = [];
    let isTrashMode = false;
    let editingId = null;
    let editingAnnId = null;
    let editingUserId = null;
    let currentTicketPage = 1;
    const itemsPerPage = 10;

    // === UTILS ===
    const $ = (sel) => document.querySelector(sel);
    const showToast = (msg, type='normal') => {
        const t = $('#toast'); 
        t.textContent = msg; 
        t.style.background = type === 'error' ? 'var(--danger)' : '#1e293b';
        t.style.bottom = "32px";
        setTimeout(() => t.style.bottom = "-100px", 3000);
    };
    const nowISO = () => new Date().toISOString();
    
    // === LOADING EFFECT HELPER (UPDATED) ===
    const showLoading = () => {
        const l = $('#appLoader');
        l.style.display = 'flex';
        l.style.visibility = 'visible';
        l.style.opacity = '1';
    };
    const hideLoading = () => {
        const l = $('#appLoader');
        l.style.opacity = '0';
        setTimeout(() => {
            l.style.visibility = 'hidden';
            l.style.display = 'none';
        }, 500);
    };

    // === AUTH & INIT (FIXED REFRESH FLASHING) ===
    auth.onAuthStateChanged(user => {
        if (user && user.uid === ADMIN_UID) {
            // Logged In: Show Dashboard
            $('#loginScreen').classList.add('hidden');
            $('#appInterface').classList.remove('hidden');
            initApp(user);
        } else {
            // Not Logged In: Show Login
            $('#loginScreen').classList.remove('hidden');
            $('#appInterface').classList.add('hidden');
        }
        
        // Sembunyikan Loading Screen HANYA SETELAH status auth dicek
        setTimeout(() => hideLoading(), 800); // Sedikit lebih lama agar smooth
    });

    $('#loginBtn').onclick = async () => {
        const u = $('#loginUser').value; const p = $('#loginPass').value;
        if (u !== 'root' || p !== 'adm123') return $('#authError').textContent = "Invalid Credentials", $('#authError').style.display = 'block';
        try { 
            showLoading(); // Show Spinner immediately
            await auth.signInWithEmailAndPassword(ADMIN_EMAIL, p); 
        } 
        catch (e) { 
            hideLoading();
            $('#authError').textContent = e.message; 
            $('#authError').style.display = 'block'; 
        }
    };
    $('#logoutBtn').onclick = () => {
        showLoading();
        auth.signOut();
    };

    function initApp(user) {
        $('#themeToggle').onclick = () => {
            const newTheme = document.body.getAttribute('data-theme') === 'light' ? 'dark' : 'light';
            document.body.setAttribute('data-theme', newTheme);
        };
        $('#mobileMenuBtn').onclick = () => $('#sidebar').classList.toggle('open');

        // === FILTER LISTENERS ===
        $('#filterCat').onchange = () => renderTickets(1);
        $('#userFilterDept').onchange = renderUsers;
        $('#userFilterStatus').onchange = renderUsers;
        $('#reqFilterDept').onchange = renderRequests;
        $('#reqFilterStatus').onchange = renderRequests;

        // === SEARCH LISTENERS ===
        $('#ticketSearch').oninput = () => renderTickets(1);
        $('#globalSearch').oninput = () => { renderTickets(1); renderUsers(); renderRequests(); };
        $('#userSearchInput').oninput = renderUsers;
        $('#reqSearch').oninput = renderRequests;

        // === BACKUP & RESTORE LOGIC ===
        $('#backupBtn').onclick = async () => {
            showLoading();
            try {
                const backupData = {
                    reports: reports, users: users, requests: requests, announcements: announcements, timestamp: Date.now()
                };
                const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(backupData));
                const downloadAnchorNode = document.createElement('a');
                downloadAnchorNode.setAttribute("href", dataStr);
                downloadAnchorNode.setAttribute("download", "zeppelin_backup_" + new Date().toISOString().slice(0,10) + ".json");
                document.body.appendChild(downloadAnchorNode);
                downloadAnchorNode.click();
                downloadAnchorNode.remove();
                showToast("Backup Berhasil Diunduh");
            } catch (err) { console.error(err); showToast("Gagal Backup", 'error'); }
            finally { hideLoading(); }
        };

        $('#restoreBtn').onclick = () => $('#restoreFile').click();
        $('#restoreFile').onchange = (event) => {
            const file = event.target.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = async (e) => {
                showLoading();
                try {
                    const data = JSON.parse(e.target.result);
                    if(data.reports && Array.isArray(data.reports)) {
                        const reportObj = {}; data.reports.forEach(r => reportObj[r.id] = r);
                        await db.ref('reports').update(reportObj);
                    }
                    if(data.requests && Array.isArray(data.requests)) {
                        const reqObj = {}; data.requests.forEach(r => reqObj[r.id] = r);
                        await db.ref('device_requests').update(reqObj);
                    }
                    if(data.announcements && Array.isArray(data.announcements)) {
                        const annObj = {}; data.announcements.forEach(r => annObj[r.key] = r);
                        await db.ref('announcements').update(annObj);
                    }
                    showToast("Restore Data Berhasil!");
                } catch (err) { alert("File Backup Corrupt!"); } 
                finally { hideLoading(); $('#restoreFile').value = ''; }
            };
            reader.readAsText(file);
        };

        // === REALTIME LISTENERS ===
        db.ref('reports').on('value', snap => {
            const val = snap.val();
            reports = val ? Object.keys(val).map(k => ({...val[k], id: k})) : [];
            renderTickets(); renderStats(); renderCharts();
            if(editingUserId) showUserDetail(editingUserId); 
        });

        db.ref('announcements').on('value', snap => {
            const val = snap.val();
            announcements = val ? Object.keys(val).map(k => ({...val[k], key: k})) : [];
            renderAnnouncements();
        });

        db.ref('users').on('value', snap => {
            const val = snap.val();
            users = val ? Object.keys(val).map(k => ({...val[k], uid: k})) : [];
            renderUsers();
        });

        db.ref('device_requests').on('value', snap => {
            const val = snap.val();
            requests = val ? Object.keys(val).map(k => ({...val[k], id: k})) : [];
            renderRequests();
        });

        firestore.collection('users').doc(user.uid).collection('assets_v2').onSnapshot(snap => {
            assets = snap.docs.map(doc => ({id: doc.id, ...doc.data()}));
        });

        db.ref('chats/private_chats').on('value', snap => {
            $('#chatBadge').style.display = snap.exists() ? 'block' : 'none';
        });
    }

    // === TABS & FILTER LOGIC ===
    window.switchTab = (tab) => {
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        const navItem = Array.from(document.querySelectorAll('.nav-item')).find(el => el.getAttribute('onclick') && el.getAttribute('onclick').includes(tab));
        if(navItem) navItem.classList.add('active');
        ['dashboard', 'tickets', 'users', 'requests'].forEach(id => $(`#view-${id}`).classList.add('hidden'));
        $(`#view-${tab}`).classList.remove('hidden');
        if(window.innerWidth < 1024) $('#sidebar').classList.remove('open');
        if(tab === 'tickets') renderTickets();
        if(tab === 'users') renderUsers();
        if(tab === 'requests') renderRequests();
    };

    window.filterByStat = (statType) => {
        switchTab('tickets');
        $('#filterCat').value = ""; 
        const searchInput = $('#ticketSearch');
        if (statType === 'All') searchInput.value = "";
        else if (statType === 'Overdue') searchInput.value = "overdue";
        else searchInput.value = statType;
        renderTickets(1);
    };

    // === RENDERING FUNCTIONS ===
    function renderStats() {
        const active = reports.filter(r => !r.isDeleted);
        $('#statTotal').textContent = active.length;
        $('#statOpen').textContent = active.filter(r => r.status === 'Open').length;
        $('#statClosed').textContent = active.filter(r => r.status === 'Closed').length;
        $('#statOverdue').textContent = active.filter(r => {
            if(r.status === 'Closed') return false;
            return Date.now() > (new Date(r.created_iso).getTime() + (SLA_HOURS[r.kategori]*3600000));
        }).length;
    }

    function renderAnnouncements() {
        const sorted = announcements.sort((a,b) => (a.isPinned === b.isPinned) ? b.timestamp - a.timestamp : a.isPinned ? -1 : 1);
        $('#announcementFeed').innerHTML = sorted.length ? sorted.map(a => `
            <div style="padding:12px; border-bottom:1px solid var(--border-color); display:flex; align-items:center; gap:12px; cursor:pointer; transition:background 0.2s;" onmouseover="this.style.background='var(--bg-hover)'" onmouseout="this.style.background='transparent'" onclick="openAnnModal('${a.key}')">
                <div style="width:4px; height:40px; background:${a.isPinned?'var(--warning)':'var(--primary-light)'}; border-radius:2px;"></div>
                <div style="flex:1;">
                    <div style="font-size:11px; font-weight:700; color:var(--primary); text-transform:uppercase; margin-bottom:2px;">${a.category}</div>
                    <div style="font-weight:600; font-size:13px; color:var(--text-primary);">${a.title}</div>
                    <div style="font-size:11px; color:var(--text-tertiary);">${new Date(a.timestamp).toLocaleDateString()}</div>
                </div>
                ${a.isPinned ? '<i class="ri-pushpin-fill" style="color:var(--warning)"></i>' : ''}
                <i class="ri-delete-bin-line" onclick="event.stopPropagation(); deleteAnn('${a.key}')" style="color:var(--danger); cursor:pointer; opacity:0.5;"></i>
            </div>
        `).join('') : '<div style="text-align:center; padding:32px; color:var(--text-secondary)"><i class="ri-notification-off-line" style="font-size:24px; display:block; margin-bottom:8px;"></i>Belum ada pengumuman</div>';
    }

    window.toggleViewMode = (mode) => {
        if(mode === 'list') {
            $('#cont-list').classList.remove('hidden'); $('#cont-kanban').classList.add('hidden');
            $('#btnList').classList.add('active'); $('#btnKanban').classList.remove('active');
        } else {
            $('#cont-list').classList.add('hidden'); $('#cont-kanban').classList.remove('hidden');
            $('#btnList').classList.remove('active'); $('#btnKanban').classList.add('active');
            renderKanban();
        }
    };

    function renderTickets(page = 1) {
        currentTicketPage = page;
        const tbody = $('#reportTable tbody');
        tbody.innerHTML = '';
        const searchText = ($('#ticketSearch').value || $('#globalSearch').value).toLowerCase();
        const catFilter = $('#filterCat').value;
        let filtered = reports.filter(r => {
            if(isTrashMode) return r.isDeleted;
            if(r.isDeleted) return false;
            let matchesSearch = JSON.stringify(r).toLowerCase().includes(searchText);
            if (searchText === 'overdue') {
                if (r.status === 'Closed') return false;
                const limit = new Date(r.created_iso).getTime() + (SLA_HOURS[r.kategori]*3600000);
                matchesSearch = Date.now() > limit;
            }
            const matchesCat = !catFilter || r.kategori === catFilter;
            return matchesSearch && matchesCat;
        }).sort((a,b) => new Date(b.created_iso) - new Date(a.created_iso));
        const total = filtered.length;
        const totalPages = Math.ceil(total / itemsPerPage) || 1;
        if(currentTicketPage > totalPages) currentTicketPage = totalPages;
        const start = (currentTicketPage - 1) * itemsPerPage;
        const paginated = filtered.slice(start, start + itemsPerPage);
        paginated.forEach(r => {
            const slaLimit = new Date(r.created_iso).getTime() + (SLA_HOURS[r.kategori]*3600000);
            const timeLeft = slaLimit - Date.now();
            const percent = Math.max(0, Math.min(100, (timeLeft / (SLA_HOURS[r.kategori]*3600000)) * 100));
            const color = (timeLeft < 0 && r.status!=='Closed') ? 'var(--danger)' : (percent<50?'var(--warning)':'var(--success)');
            
            // DATE FORMATTING
            const createdDate = new Date(r.created_iso);
            const dateStr = createdDate.toLocaleDateString('id-ID', { day: 'numeric', month: 'short', year: 'numeric' });
            const timeStr = createdDate.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' });

            tbody.innerHTML += `
            <tr onclick="openReportModal('${r.id}')" style="cursor:pointer;">
                <td>
                    <div style="font-weight:700; color:var(--primary); font-family:'JetBrains Mono', monospace;">${r.id}</div>
                    <div style="font-size:13px; font-weight:500; color:var(--text-primary); margin-top:2px;">${r.nama}</div>
                </td>
                <td>
                    <div style="font-weight:600; font-size:14px; margin-bottom:4px;">${r.jenis}</div>
                    <div style="font-size:12px; color:var(--text-tertiary); max-width:240px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${(r.catatan||'-')}</div>
                </td>
                <td>
                    <div style="display:flex; gap:6px; margin-bottom:6px;">
                        <span class="badge status-${r.status}">${r.status}</span> 
                        <span class="badge cat-${r.kategori}">${r.kategori}</span>
                    </div>
                    ${r.status!=='Closed' ? `<div class="sla-progress"><div class="sla-bar" style="width:${percent}%; background:${color}"></div></div>` : ''}
                </td>
                <td>
                    ${r.pic ? `<div style="display:flex; align-items:center; gap:6px; font-size:13px;"><div style="width:24px; height:24px; background:var(--bg-hover); border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:10px; font-weight:700;">${r.pic.charAt(0)}</div>${r.pic}</div>` : '<span style="color:var(--text-tertiary); font-style:italic; font-size:12px;">Belum ada PIC</span>'}
                </td>
                <td>
                    <div style="font-size:13px; font-weight:600;">${dateStr}</div>
                    <div style="font-size:11px; color:var(--text-tertiary);">${timeStr}</div>
                </td>
                <td style="text-align:right">
                    <button class="icon-btn" onclick="event.stopPropagation(); openReportModal('${r.id}')"><i class="ri-edit-line"></i></button>
                    <button class="icon-btn" style="color:${isTrashMode?'var(--success)':'var(--danger)'}" onclick="event.stopPropagation(); ${isTrashMode?`restore('${r.id}')`:`softDelete('${r.id}')`}"><i class="ri-${isTrashMode?'refresh-line':'delete-bin-line'}"></i></button>
                </td>
            </tr>`;
        });
        $('#paginationInfo').textContent = `Menampilkan ${total>0?start+1:0}-${Math.min(start+itemsPerPage, total)} dari ${total}`;
        $('#paginationBtns').innerHTML = '';
        if(totalPages > 1) {
            for(let i=1; i<=totalPages; i++) {
                if(i==1 || i==totalPages || (i>=currentTicketPage-1 && i<=currentTicketPage+1)) {
                    $('#paginationBtns').innerHTML += `<button class="page-btn ${i===currentTicketPage?'active':''}" onclick="renderTickets(${i})">${i}</button>`;
                } else if(i==currentTicketPage-2 || i==currentTicketPage+2) {
                    $('#paginationBtns').innerHTML += `<span>...</span>`;
                }
            }
        }
        if(!$('#cont-kanban').classList.contains('hidden')) renderKanban();
    }

    function renderKanban() {
        const searchText = ($('#ticketSearch').value || $('#globalSearch').value).toLowerCase();
        const catFilter = $('#filterCat').value;
        const filtered = reports.filter(r => {
            if(isTrashMode) return r.isDeleted;
            if(r.isDeleted) return false;
            let matchesSearch = JSON.stringify(r).toLowerCase().includes(searchText);
            if (searchText === 'overdue') {
                if (r.status === 'Closed') return false;
                const limit = new Date(r.created_iso).getTime() + (SLA_HOURS[r.kategori]*3600000);
                matchesSearch = Date.now() > limit;
            }
            const matchesCat = !catFilter || r.kategori === catFilter;
            return matchesSearch && matchesCat;
        });

        ['Open', 'Progress', 'Closed'].forEach(status => {
            const container = $(`#kb-${status}`);
            const items = filtered.filter(r => r.status === status);
            $(`#count${status}`).textContent = items.length;
            container.innerHTML = items.map(r => `
                <div class="kanban-card" onclick="openReportModal('${r.id}')">
                    <div class="k-card-top">
                        <span style="font-family:'JetBrains Mono'; font-weight:700; color:var(--primary);">${r.id}</span>
                        <span>${new Date(r.created_iso).toLocaleDateString()}</span>
                    </div>
                    <div class="k-card-title">${r.jenis}</div>
                    <div style="font-size:12px; color:var(--text-secondary); margin-bottom:12px;">${r.nama}</div>
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <div class="badge cat-${r.kategori}">${r.kategori}</div>
                        <div style="font-size:12px; color:var(--text-tertiary);"><i class="ri-user-smile-line"></i> ${r.pic||'?'}</div>
                    </div>
                </div>`).join('');
        });
    }

    function renderUsers() {
        const search = ($('#userSearchInput').value || $('#globalSearch').value).toLowerCase();
        const deptFilter = $('#userFilterDept').value;
        const statusFilter = $('#userFilterStatus').value;
        const depts = [...new Set(users.map(u => u.departemen).filter(Boolean))];
        if($('#userFilterDept').children.length === 1) depts.forEach(d => $('#userFilterDept').innerHTML += `<option value="${d}">${d}</option>`);
        $('#userStatTotal').textContent = users.length;
        $('#userStatPending').textContent = users.filter(u=>u.status==='pending').length;
        $('#userStatApproved').textContent = users.filter(u=>u.status==='approved').length;
        const filtered = users.filter(u => {
            if(u.uid === ADMIN_UID) return false;
            const matchesSearch = (u.nama||'').toLowerCase().includes(search) || (u.email||'').toLowerCase().includes(search);
            const matchesDept = !deptFilter || u.departemen === deptFilter;
            const matchesStatus = !statusFilter || (u.status||'pending') === statusFilter;
            return matchesSearch && matchesDept && matchesStatus;
        });
        $('#userTableBody').innerHTML = filtered.map(u => {
            const ticketCount = reports.filter(r => r.uid === u.uid).length;
            const statusClass = u.status === 'approved' ? 'status-approved' : (u.status==='rejected'?'status-rejected':'status-pending');
            return `<tr><td>${u.nama}</td><td>${u.email}</td><td>${u.departemen}</td><td><span class="badge ${statusClass}">${u.status||'pending'}</span></td><td style="text-align:center">${ticketCount}</td><td><button class="btn ghost" style="padding:6px 12px; font-size:12px; border:1px solid var(--border-color);" onclick="showUserDetail('${u.uid}')">Edit</button></td></tr>`;
        }).join('');
    }

    function renderRequests() {
        const search = ($('#reqSearch').value || $('#globalSearch').value).toLowerCase();
        const statusFilter = $('#reqFilterStatus').value;
        const deptFilter = $('#reqFilterDept').value;
        $('#reqStatPending').textContent = requests.filter(r=>(r.status||'Pending')==='Pending').length;
        $('#reqStatApproved').textContent = requests.filter(r=>r.status==='Approved').length;
        $('#reqStatRejected').textContent = requests.filter(r=>r.status==='Rejected').length;
        const depts = [...new Set(requests.map(r => r.departemen).filter(Boolean))];
        if($('#reqFilterDept').children.length === 1) depts.forEach(d => $('#reqFilterDept').innerHTML += `<option value="${d}">${d}</option>`);
        const filtered = requests.filter(r => {
            const matchesSearch = (r.nama||'').toLowerCase().includes(search) || (r.detail||'').toLowerCase().includes(search);
            const matchesStatus = !statusFilter || (r.status||'Pending') === statusFilter;
            const matchesDept = !deptFilter || r.departemen === deptFilter;
            return matchesSearch && matchesStatus && matchesDept;
        }).sort((a,b) => new Date(b.created_at) - new Date(a.created_at));
        $('#reqTableBody').innerHTML = filtered.map(r => `<tr><td>${new Date(r.created_at).toLocaleDateString()}</td><td>${r.nama}</td><td>${r.departemen}</td><td>${r.kategori}</td><td>${r.detail}</td><td><span class="badge ${r.prioritas==='High'?'cat-High':'cat-Normal'}">${r.prioritas}</span></td><td><span class="badge status-${r.status||'Pending'}">${r.status||'Pending'}</span></td><td><button class="btn ghost" style="padding:6px 12px; border:1px solid var(--border-color);" onclick="openReqDetail('${r.id}')">Proses</button></td></tr>`).join('');
    }

    // === OPERATIONS (WITH LOADING EFFECT) ===
    window.openReportModal = (id) => {
        editingId = id; 
        // Animasi Modal
        const m = $('#modalTicket'); m.style.display = 'flex'; 
        setTimeout(() => m.classList.add('active'), 10);
        $('#formTicket').reset();
        
        if(id) {
            const r = reports.find(x => x.id === id);
            $('#t_nama').value = r.nama; $('#t_nama').readOnly = true;
            $('#t_pic').value = r.pic || ''; $('#t_jenis').value = r.jenis; $('#t_kategori').value = r.kategori;
            $('#t_status').value = r.status; $('#t_note').value = r.catatan || ''; $('#t_internal').value = r.note_internal || '';
        } else { $('#t_nama').readOnly = false; $('#t_status').value = 'Open'; }
    };

    window.saveTicket = async () => {
        const nama = $('#t_nama').value, pic = $('#t_pic').value;
        if(!nama || !pic) return alert("Wajib diisi");
        showLoading(); // START LOADING
        try {
            let id = editingId;
            const oldData = id ? reports.find(r => r.id === id) : {};
            if(!id) { const s = await db.ref('counter').transaction(c => (c||0)+1); id = 'ZP-'+String(s.snapshot.val()).padStart(4,'0'); }
            
            // DATA & LOGIC URGENT (JANGAN DIHAPUS)
            const data = { 
                id, nama, pic, 
                jenis: $('#t_jenis').value, 
                kategori: $('#t_kategori').value, 
                status: $('#t_status').value, 
                catatan: $('#t_note').value, 
                note_internal: $('#t_internal').value, 
                updated_iso: nowISO(), 
                created_iso: oldData.created_iso || nowISO(), 
                uid: oldData.uid || auth.currentUser.uid,
                urgent: $('#t_kategori').value === 'Critical'
            };

            await db.ref('reports/'+id).update(data);
            closeModal('modalTicket'); showToast("Tiket Disimpan");
        } catch(e) { alert(e.message); }
        finally { hideLoading(); } // END LOADING
    };

    window.softDelete = (id) => { if(confirm("Hapus?")) db.ref(`reports/${id}`).update({isDeleted: true}); };
    window.restore = (id) => db.ref(`reports/${id}`).update({isDeleted: null});
    window.toggleTrash = () => { isTrashMode = !isTrashMode; renderTickets(); showToast(isTrashMode ? "Mode Sampah" : "Mode Aktif"); };

    window.openAnnModal = (key) => {
        editingAnnId = key; 
        const m = $('#modalAnn'); m.style.display = 'flex'; setTimeout(() => m.classList.add('active'), 10);
        if(key) {
            const a = announcements.find(x => x.key === key);
            $('#a_title').value = a.title; $('#a_content').value = a.content; $('#a_cat').value = a.category; $('#a_pin').checked = a.isPinned;
        } else { $('#a_title').value = ''; $('#a_content').value = ''; $('#a_pin').checked = false; }
    };
    window.saveAnnouncement = async () => {
        showLoading();
        try {
            const d = { title: $('#a_title').value, content: $('#a_content').value, category: $('#a_cat').value, author: $('#a_author').value, isPinned: $('#a_pin').checked, timestamp: firebase.database.ServerValue.TIMESTAMP };
            if(editingAnnId) await db.ref(`announcements/${editingAnnId}`).update(d);
            else await db.ref('announcements').push(d);
            closeModal('modalAnn'); showToast("Pengumuman Terbit");
        } finally { hideLoading(); }
    };
    window.deleteAnn = (k) => { if(confirm("Hapus?")) db.ref(`announcements/${k}`).remove(); };

    window.showUserDetail = (uid) => {
        const u = users.find(x => x.uid === uid);
        if(!u) return;
        editingUserId = uid;
        const m = $('#modalUserDetail'); m.style.display = 'flex'; setTimeout(() => m.classList.add('active'), 10);
        $('#ud_name').textContent = u.nama; $('#ud_id').value = uid;
        $('#ud_fullname').value = u.nama; $('#ud_email').value = u.email; $('#ud_dept').value = u.departemen;
    };
    window.updateUserStatus = (s) => {
        const uid = $('#ud_id').value;
        db.ref(`users/${uid}`).update({status: s});
        showToast(`Status user diubah ke ${s}`);
    };
    window.saveUserChanges = () => {
        const uid = $('#ud_id').value;
        db.ref(`users/${uid}`).update({ nama: $('#ud_fullname').value, departemen: $('#ud_dept').value });
        closeModal('modalUserDetail'); showToast("Data User Disimpan");
    };
    
    $('#showCreateUserPopupBtn').onclick = () => { const m = $('#modalCreateUser'); m.style.display = 'flex'; setTimeout(() => m.classList.add('active'), 10); };
    window.submitNewUser = async () => {
        const email = $('#cu_email').value, pass = $('#cu_pass').value, name = $('#cu_name').value, dept = $('#cu_dept').value;
        if(!email || !pass || !name) return alert("Lengkapi form");
        showLoading();
        try {
            const secApp = firebase.initializeApp(firebaseConfig, "Secondary");
            const uc = await secApp.auth().createUserWithEmailAndPassword(email, pass);
            await db.ref(`users/${uc.user.uid}`).set({ uid: uc.user.uid, nama: name, email, departemen: dept, status: 'approved' });
            await secApp.delete();
            closeModal('modalCreateUser'); showToast("User Baru Dibuat");
        } catch(e) { alert(e.message); }
        finally { hideLoading(); }
    };

    window.openReqDetail = (id) => {
        const r = requests.find(x => x.id === id);
        if(!r) return;
        editingId = id; 
        const m = $('#modalReqDetail'); m.style.display = 'flex'; setTimeout(() => m.classList.add('active'), 10);
        $('#rd_user').textContent = r.nama; $('#rd_detail').textContent = `${r.kategori} - ${r.detail}`; $('#rd_reason').textContent = `"${r.alasan}"`;
        $('#rd_notes').value = r.admin_notes || '';
        const isHW = (r.detail||'').toLowerCase().match(/laptop|desktop|monitor/);
        const stock = assets.filter(a => ['Laptop','Desktop','Monitor'].includes(a.type) && !a.pic);
        const sel = $('#rd_asset_select');
        sel.innerHTML = '<option value="">-- Pilih Aset --</option>';
        if(isHW) {
            $('#assetAssignSection').style.display = 'block';
            stock.forEach(a => sel.innerHTML += `<option value="${a.id}">${a.name} (${a.serial})</option>`);
        } else { $('#assetAssignSection').style.display = 'none'; }
    };
    window.processRequest = async (status) => {
        const id = editingId;
        const notes = $('#rd_notes').value;
        const assetId = $('#rd_asset_select').value;
        if(status === 'Approved' && $('#assetAssignSection').style.display !== 'none' && !assetId) return alert("Harap pilih aset untuk diserahkan ke user.");
        showLoading();
        try {
            if(status === 'Approved' && assetId) {
                const r = requests.find(x => x.id === id);
                await firestore.collection('users').doc(auth.currentUser.uid).collection('assets_v2').doc(assetId).update({
                    pic: r.nama, location: r.departemen, lastUpdate: firebase.firestore.FieldValue.serverTimestamp()
                });
            }
            await db.ref(`device_requests/${id}`).update({ status, admin_notes: notes, processed_at: nowISO() });
            closeModal('modalReqDetail');
            showToast(`Permintaan ${status}`);
        } finally { hideLoading(); }
    };

    window.closeModal = (id) => {
        const m = $(`#${id}`);
        m.classList.remove('active');
        setTimeout(() => m.style.display = 'none', 200); // Tunggu animasi selesai
    };

    let chartCat, chartSLA;
    function renderCharts() {
        const cats = { Low:0, Normal:0, Critical:0 };
        const statusCounts = { Open:0, Progress:0, Closed:0 };
        reports.filter(r=>!r.isDeleted).forEach(r => {
            cats[r.kategori] = (cats[r.kategori]||0)+1;
            statusCounts[r.status] = (statusCounts[r.status]||0)+1;
        });
        const ctxC = $('#chartCategory').getContext('2d');
        if(chartCat) chartCat.destroy();
        chartCat = new Chart(ctxC, { type: 'doughnut', data: { labels: Object.keys(cats), datasets: [{ data: Object.values(cats), backgroundColor: ['#06b6d4', '#f59e0b', '#ef4444'], borderWidth: 0 }] }, options: { maintainAspectRatio: false, plugins: { legend: {position:'right'} } } });
        const ctxS = $('#chartSLA').getContext('2d');
        if(chartSLA) chartSLA.destroy();
        chartSLA = new Chart(ctxS, { type: 'bar', data: { labels: Object.keys(statusCounts), datasets: [{ label:'Tiket', data: Object.values(statusCounts), backgroundColor: ['#f59e0b', '#3b82f6', '#10b981'], borderRadius: 4 }] }, options: { maintainAspectRatio: false, plugins: { legend: {display:false} } } });
    }
</script>
</body>
</html>
